#+TITLE: Emacs config
#+PROPERTY: header-args:emacs-lisp :lexical t
#+OPTIONS: toc:nil
* early-init.el
:PROPERTIES:
:header-args:emacs-lisp: :tangle early-init.el
:END:
#+begin_src emacs-lisp
  ;; -*- lexical-binding: t; -*-
  ;;; early-init.el --- Early initialization before GUI is created -*- lexical-binding: t; -*-

  ;; Minimize GC during startup by raising thresholds to the absolute maximum.
  ;; This prevents the garbage collector from running while packages are loading.
  (setq gc-cons-threshold most-positive-fixnum
        gc-cons-percentage 0.6)

  ;; After Emacs has fully started, restore saner GC settings:
  ;; 32 MB threshold and 0.1 % heap-size trigger to keep interactive sessions responsive.
  (add-hook 'emacs-startup-hook
            (lambda ()
              (setq gc-cons-threshold (* 32 1024 1024)   ; 32 MB
                    gc-cons-percentage 0.1)))

  ;; Save the original `file-name-handler-alist' (used for special file-name parsing).
  (defvar my/startup-file-name-handler-alist file-name-handler-alist)

  ;; Disable it temporarily during startup to avoid costly regexp matches.
  (setq file-name-handler-alist nil)

  ;; Restore the original list once startup is complete.
  (add-hook 'emacs-startup-hook
            (lambda ()
              (setq file-name-handler-alist my/startup-file-name-handler-alist)))

  ;; Enable the package-quickstart feature: pre-compute autoloads to speed up
  ;; `package-initialize'.  Run `M-x package-quickstart-refresh' after any
  ;; package list change.
  (setq package-quickstart t)

  ;; Prefer newer .elc files when both .el and .elc exist.
  (setq load-prefer-newer t)

  ;; Do **not** activate the package system automatically; we will do it
  ;; manually in init.el for faster control.
  (setq package-enable-at-startup nil)

  ;; Native-compilation settings -------------------------------------------------
  ;; JIT-compile Lisp to native code as soon as a file is loaded.
  (setq native-comp-jit-compilation t)
  ;; Suppress async native-compilation warnings in the echo area.
  (setq native-comp-async-report-warnings-errors nil)
  ;; Defer native compilation of installed packages until idle time.
  (setq native-comp-deferred-compilation t)

  ;; Ensure UTF-8 is the default coding system everywhere.
  (prefer-coding-system 'utf-8)
  (setq-default buffer-file-coding-system 'utf-8)
  (setq file-name-coding-system 'utf-8)
  (setq-default process-coding-system-alist
                '(("[pP][lL][iI][nN][kK]" utf-8-dos . gbk-dos)
                  ("[cC][mM][dD][pP][rR][oO][xX][yY]" utf-8-dos . gbk-dos)
                  ("rg" utf-8 . gbk-dos)
                  ("ug" utf-8 . gbk-dos)
                  ("ugrep" utf-8 . gbk-dos)
                  ("es" gbk-dos . gbk-dos)
                  ("explorer" gbk-dos . gbk-dos)
                  ("*" utf-8-unix . utf-8-unix)))
  ;; Prevent Emacs from automatically resizing frames based on font changes.
  (setq frame-inhibit-implied-resize t)

  ;; Remove UI chrome from the default frame.
  (push '(menu-bar-lines   . 0) default-frame-alist) ; no menu bar
  (push '(tool-bar-lines   . 0) default-frame-alist) ; no tool bar
  (push '(vertical-scroll-bars . nil) default-frame-alist) ; no scroll bar

  ;; Load order: prefer compiled .elc files, then fall back to .el source.
  (setq load-suffixes '(".elc" ".el"))

  ;; Disable versioned suffixes (e.g. .el.gz) to simplify loading.
  (setq load-file-rep-suffixes '(""))
  (provide 'early-init)
  ;;; early-init.el ends here
#+end_src

* init.el
:PROPERTIES:
:header-args:emacs-lisp: :tangle init.el
:END:
#+begin_src emacs-lisp
  ;; -*- lexical-binding: t; -*-
  (progn
    ;; Initialize the built-in package system.
    (package-initialize)
    ;; Ensure the local package index exists; download if missing.
    (unless package-archive-contents
      (package-refresh-contents))
    ;; Bootstrap `use-package` if it is not already installed.
    (unless (package-installed-p 'use-package)
      (package-install 'use-package))
    (eval-when-compile
      (require 'use-package))
    ;; Use TUNA mirrors (China) for faster downloads.
    (setq package-archives '(("gnu"    . "https://mirrors.tuna.tsinghua.edu.cn/elpa/gnu/")
                             ("nongnu" . "https://mirrors.tuna.tsinghua.edu.cn/elpa/nongnu/")
                             ("melpa"  . "https://mirrors.tuna.tsinghua.edu.cn/elpa/melpa/")))
    ;; Native-compile installed packages for better performance.
    (setq package-native-compile t
          ;; Allow upgrading packages that are built-in to Emacs.
          package-install-upgrade-built-in t
          ;; Do **not** auto-install missing packages (manual control).
          use-package-always-ensure nil
          ;; Defer loading by default unless `:demand' is specified.
          use-package-always-defer t
          ;; Generate minimal expansion code in the macro expansion.
          use-package-expand-minimally t
          ;; Disable post-startup statistics to reduce overhead.
          use-package-compute-statistics nil))
#+END_SRC
** 内置行为与基础设置
*** 核心设置
#+begin_src emacs-lisp
  ;; Command-line options -------------------------------------------------------
  ;; Remove X11-style switches (e.g. -fn, -bg) so Emacs ignores them.
  (setq command-line-x-option-alist nil)

  ;; Process I/O optimisation ---------------------------------------------------
  ;; Increase the amount of data Emacs reads from subprocesses in one chunk
  ;; (64 KiB) to reduce context switches and boost throughput.
  (setq read-process-output-max (* 1024 1024))          ; 1 MB

  ;; Disable FFAP domain detection ----------------------------------------------
  ;; Tell FFAP (Find File At Point) never to attempt remote machine lookups
  ;; when a string looks like a domain name.
  (setq ffap-machine-p-known 'reject)

  ;; Personal information -------------------------------------------------------
  (setq user-full-name       "Wei"
        user-mail-address    "Jiawei0655@gmail.com")

  ;; UTF-8 everywhere -----------------------------------------------------------
  ;; Prioritise Unicode when multiple charsets match a character.
  (when (fboundp 'set-charset-priority)
    (set-charset-priority 'unicode))

  ;; 24-hour clock in modeline ---------------------------------------------------
  (setq display-time-24hr-format t)

  ;; 将 Git for Windows 的 usr\bin 目录添加到执行路径
  (add-to-list 'exec-path "D:/Apps/Scoop/apps/git/current/usr/bin/")
  ;; 可选：同时添加 mingw64\bin 目录以确保万无一失
  (add-to-list 'exec-path "D:/Apps/Scoop/apps/git/current/mingw64/bin/")
  ;; 此外，可以将该目录添加到系统的 PATH 环境变量前段
  (setenv "PATH" (concat "D:\\Apps\\Scoop\\apps\\git\\current\\usr\\bin;" (getenv "PATH")))

  ;; Garbage-Collection Magic Hack (gcmh) ---------------------------------------
  (use-package gcmh
    :ensure t
    :demand t
    :diminish                                 ; hide "gcmh" from the modeline
    :hook (emacs-startup . gcmh-mode)        ; start immediately after init
    :custom
    (gcmh-idle-delay 'auto)                  ; compute idle delay dynamically
    (gcmh-auto-idle-delay-factor 10)         ; multiply auto-detected delay by 10
    (gcmh-high-cons-threshold #x12800000))   ; 320 MB threshold for aggressive GC

  ;; Server mode ----------------------------------------------------------------
  ;; Allow external programs (editor, git, etc.) to open files via `emacsclient`.
  (use-package server
    :ensure nil                               ; built-in
    :hook (after-init . server-mode))        ; start server after init finishes

  ;; Remember cursor position in files ------------------------------------------
  (use-package saveplace
    :defer t                                  ; autoload
    :hook (after-init . save-place-mode)     ; enable globally
    :config
    (setq save-place-file
          (locate-user-emacs-file "etc/places"))) ; persist file in `~/.emacs.d/etc/places`

  ;; Recently opened files ------------------------------------------------------
  (use-package recentf
    :defer 1                                  ; load one second after idle
    :bind (("C-x C-r" . recentf-open-files))  ; quick access
    :hook (after-init . recentf-mode)        ; enable mode after init
    :custom
    (recentf-max-saved-items 300)
    (recentf-auto-cleanup 'never)            ; manual cleanup only
    (recentf-exclude                          ; ignore temporary/system paths
     '("^/private/tmp/"
       "^/var/folders/"
       "^/tmp/"
       "/ssh\\(?:x\\|do\\):"                  ; TRAMP sudo/ssh
       "^/usr/include/"
       "/TAGS\\'"
       "COMMIT_EDITMSG\\'"))
    :config
    (setq recentf-save-file
          (locate-user-emacs-file "etc/recentf"))) ; persist list in `~/.emacs.d/etc/recentf`

  ;; Minibuffer history persistence ---------------------------------------------
  (use-package savehist
    :hook (after-init . savehist-mode)       ; save history across sessions
    :init
    (setq enable-recursive-minibuffers t      ; allow minibuffer commands in minibuffer
          history-length 1000                 ; keep more history
          savehist-file (locate-user-emacs-file "etc/history")
          savehist-additional-variables '(mark-ring
                                          global-mark-ring
                                          search-ring
                                          regexp-search-ring
                                          extended-command-history)
          savehist-autosave-interval 300))    ; auto-save every 5 minutes
#+end_src

*** 使用地址
#+BEGIN_SRC emacs-lisp
  (require 'cl-lib)
  (defun my/normalize-path (PATH)
    "Convert a Windows PATH to Emacs-style forward slashes and ensure a trailing slash."
    (file-name-as-directory
     (replace-regexp-in-string "\\\\" "/" (convert-standard-filename PATH))))
  ;; --- Root directories ---
  (defconst my/org-root
    (my/normalize-path "C:/Users/wei/Documents/org/")
    "Org root directory.")
  (defconst my/org-agenda-root
    (my/normalize-path (expand-file-name "agenda" my/org-root))
    "Org-agenda root directory.")
  (defconst my/denote-root
    (my/normalize-path (expand-file-name "notes" my/org-root))
    "Denote notes root directory.")
  ;; --- Agenda sub-directories ---
  (defconst my/org-projects-dir (expand-file-name "projects" my/org-agenda-root)
    "Projects directory under agenda.")
  (defconst my/org-work-dir     (expand-file-name "work"     my/org-agenda-root)
    "Work directory under agenda.")
  (defconst my/org-personal-dir (expand-file-name "personal" my/org-agenda-root)
    "Personal directory under agenda.")
  ;; --- Bibliography directories ---
  (defconst my/bibliography-directory
    (expand-file-name "bibliography" my/org-root)
    "Bibliography library directory.")
  (defconst my/bibliography-files
    (list (expand-file-name "我的文库.bib" my/bibliography-directory))
    "List of main BibTeX files.")
  (defconst my/bibliography-notes-directory
    (expand-file-name "literature-notes" my/denote-root)
    "Directory for literature notes (used with Denote).")
  ;; --- GPTel cache directory ---
  (defconst my/gptel-cache-dir
    (expand-file-name "etc/gptel" user-emacs-directory)
    "GPTel cache directory.")
  ;; --- Unified directory list (duplicates removed) ---
  (defconst my/managed-directories
    (delete-dups
     (list my/org-root
           my/org-agenda-root
           my/denote-root
           my/org-projects-dir
           my/org-work-dir
           my/org-personal-dir
           my/bibliography-directory
           my/bibliography-notes-directory
           my/gptel-cache-dir))
    "Directories that must exist on startup.")
  (defun my/ensure-directories ()
    "Ensure all directories in `my/managed-directories' exist.
  Missing ones are created once; this function removes itself from
  `after-init-hook' afterwards to avoid repeated checks."
    (let ((missing (cl-remove-if #'file-directory-p my/managed-directories)))
      (when missing
        (dolist (dir missing)
          (make-directory dir t))))
    (remove-hook 'after-init-hook #'my/ensure-directories))
  (add-hook 'after-init-hook #'my/ensure-directories)
#+end_src
** UI 与显示
*** 主题配置
#+begin_src emacs-lisp
  ;; -------------------------------------------------------------------
  ;; Panel – fancy startup dashboard with weather, image, and quote
  ;; -------------------------------------------------------------------
  (use-package panel
    ;; Fetch from GitHub; pin to branch "main"
    :vc (panel :url "https://github.com/jiandwei/emacs-panel.git"
               :branch "main")
    ;; Create the dashboard as soon as Emacs is ready
    :hook (after-init . panel-create-hook)
    :config
    ;; ---------- Basic display settings ----------
    (setq panel-title "Happy hacking, Emacs ♥  you"   ; main banner text
          panel-show-file-path nil                    ; hide recent-file path
          panel-min-left-padding 10                   ; left margin (columns)
          panel-path-max-length 20                    ; truncate long paths
          ;; Geo-coordinates for weather / sunrise: Dalian, China
          ;;panel-latitude  38.9140
          panel-latitude 46.58333
          ;;panel-longitude 121.6147
          panel-longtitude 125.0
          ;; Custom header image
          panel-image-file   (locate-user-emacs-file "etc/bitmap.png")
          panel-image-width  400
          panel-image-height 169))

  ;; -------------------------------------------------------------------
  ;; Circadian – automatic light/dark theme switcher
  ;; -------------------------------------------------------------------
  (use-package circadian
    :ensure t
    :defer t                       ; autoload until first use
    :init
    ;; Themes tied to local sunrise/sunset (Dalian)
    (setq circadian-themes
          '((:sunrise . modus-operandi-tinted)   ; light theme
            (:sunset  . modus-vivendi))          ; dark theme
          calendar-latitude  38.9140
          calendar-longitude 121.6147
          calendar-location-name "Dalian")
    ;; Activate theme scheduler after init
    :hook (after-init . circadian-setup))

  ;; -------------------------------------------------------------------
  ;; Smooth pixel-precise scrolling
  ;; -------------------------------------------------------------------
  (use-package pixel-scroll
    :ensure nil                    ; built-in since Emacs 29
    :hook (after-init . pixel-scroll-precision-mode)
    :custom
    ;; Resize windows/frames by single pixels instead of character cells
    (window-resize-pixelwise t)
    (frame-resize-pixelwise t)
    ;; Enable interpolation for large scrolls (feels smoother)
    (pixel-scroll-precision-interpolate-page t)
    ;; Scroll this many pixels before interpolation kicks in
    (pixel-scroll-precision-large-scroll-height 40.0)
    ;; Higher = faster acceleration curve
    (pixel-scroll-precision-interpolation-factor 30))
#+end_src
*** 字体配置
#+begin_src emacs-lisp
  ;;; Font setup – optimized (cached + lazy-load)
  (defun font-available-p (FONT-NAME)
    "Return non-nil if FONT-NAME is available."
    (find-font (font-spec :name FONT-NAME)))
  (defvar my/font-cache nil
    "Cache for detected fonts to avoid repeated system queries.")
  (defun my/detect-fonts-once ()
    "Detect required fonts once and cache the results."
    (unless my/font-cache
      (setq my/font-cache
            (list
             :han (cl-loop for f in '("等距更纱黑体 SC")
                           when (font-available-p f) return f)
             :symbol (cl-loop for f in '("Symbols Nerd Font Mono")
                              when (font-available-p f) return f)
             :emoji (cl-loop for f in '("Noto Color Emoji" "Apple Color Emoji" "Segoe UI Emoji")
                             when (font-available-p f) return f)))))
  (defun my/setup-fonts-beautiful ()
    "Set up fonts (beautified version)."
    (when (display-graphic-p)
      ;; Latin font
      (set-face-attribute 'default nil
                          :font "IosevkaTerm NF"
                          :height 120
                          :weight 'normal)
      ;; Variable-pitch font (for Org prose)
      (set-face-attribute 'variable-pitch nil
                          :font  "IosevkaTerm NF"
                          :height 1.0)
      ;; Fixed-pitch font (for code blocks)
      (set-face-attribute 'fixed-pitch nil
                          :font "IosevkaTerm NF";;"IosevkaTermSS05 Nerd Font Mono + LXGW WenKai Mono Lite Regular"
                          :height 1.0)
      ;; CJK font
      (my/detect-fonts-once)
      (when-let* ((han (plist-get my/font-cache :han)))
        (setq face-font-rescale-alist `((,han . 1.0)))
        (set-fontset-font t 'han (font-spec :family han)))
      ;; Symbols
      (when-let* ((sym (plist-get my/font-cache :symbol)))
        (set-fontset-font t 'symbol (font-spec :family sym) nil 'prepend))
      ;; Emoji
      (when-let* ((emo (plist-get my/font-cache :emoji)))
        (set-fontset-font t 'emoji (font-spec :family emo) nil 'prepend))))
  (add-hook 'after-init-hook #'my/setup-fonts-beautiful)
  ;; Re-apply after new frame (needed for daemon mode)
  (add-hook 'after-make-frame-functions #'my/setup-fonts-beautiful)
  ;; Re-apply after Circadian theme switch
  (with-eval-after-load 'circadian
    (add-hook 'circadian-after-load-theme-hook
              (lambda (_theme) (my/setup-fonts-beautiful))))
#+end_src
*** 图标与 Modeline
#+begin_src emacs-lisp
  (use-package doom-modeline
    :ensure t
    :hook after-init
    :config
    (setq doom-modeline-buffer-file-name-style 'truncate-upto-project)
    (setq doom-modeline-icon t)
    (setq doom-modeline-bar-width 4)
    (setq doom-modeline-major-mode-color-icon t))
  (use-package nerd-icons
    :ensure t
    :defer t)   ; loaded on-demand by dired, ibuffer, etc.
#+end_src
*** 高亮与反馈
**** 当前行高亮
#+begin_src emacs-lisp
  (use-package hl-line
    :ensure nil                       ; built-in since Emacs 22
    ;; Highlight current line everywhere except in terminal/dashboard buffers
    :hook (after-init . global-hl-line-mode)
    ;; Disable hl-line in special buffers where it looks ugly
    :hook ((dashboard-mode
            eshell-mode
            shell-mode
            term-mode
            vterm-mode)
           . (lambda ()
               "Turn off line highlighting in this buffer."
               (setq-local global-hl-line-mode nil)))
    ;; Face tuned for dark Nord-like themes
    :custom-face
    (hl-line ((t (:extend t              ; stretch across window width
                  :background "#2d3436"))))) ; subtle grey highlight
#+end_src
**** 括号匹配
#+begin_src emacs-lisp
  (use-package paren
    :defer t
    :after (:any text prog)                 ; load only when text/prog modes run
    :hook ((text-mode prog-mode) . show-paren-mode)
    :custom
    ;; Highlight bracket under cursor as well as the matching one.
    (show-paren-when-point-inside-paren t)
    ;; Also highlight when cursor is just before/after a bracket.
    (show-paren-when-point-in-periphery t)

    :config
    ;; If child-frames work, use a floating tip for off-screen matches;
    ;; otherwise fall back to an overlay in the current window.
    (setq show-paren-context-when-offscreen
          (if (childframe-workable-p) 'child-frame 'overlay))

    ;; Helper: display an overlay spanning the entire line at POS, showing STR
    ;; with optional FACE.
    (with-no-warnings
      (defun display-line-overlay (pos str &optional face)
        "Display line at POS as STR with FACE."
        (let ((ol (save-excursion
                    (goto-char pos)
                    (make-overlay (line-beginning-position)
                                  (line-end-position)))))
          (overlay-put ol 'display str)
          (overlay-put ol 'face (or face '(:inherit highlight)))
          ol))

      ;; Overlay used to show off-screen matching line
      (defvar-local show-paren--off-screen-overlay nil)

      (defun show-paren-off-screen (&rest _args)
        "When the matching paren is off-screen, echo its line in the current buffer."
        ;; Clean up any previous overlay
        (when (overlayp show-paren--off-screen-overlay)
          (delete-overlay show-paren--off-screen-overlay))
        ;; Only proceed if a show-paren overlay is active and we are not in
        ;; the minibuffer, a macro, etc.
        (when (and (overlay-buffer show-paren--overlay)
                   (not (or cursor-in-echo-area
                            executing-kbd-macro
                            noninteractive
                            (minibufferp)
                            this-command))
                   ;; Heuristic: previous char is an open paren/bracket
                   (and (not (bobp))
                        (memq (char-syntax (char-before)) '(?$ ?\$)))
                   ;; Make sure we moved at least one char
                   (= 1 (logand 1 (- (point)
                                     (save-excursion
                                       (forward-char -1)
                                       (skip-syntax-backward "/\\")
                                       (point))))))
          ;; Temporarily override `minibuffer-message' to capture the
          ;; string that show-paren would echo, and display it as an
          ;; overlay at the top of the window instead.
          (cl-letf (((symbol-function #'minibuffer-message)
                     (lambda (msg &rest args)
                       (let ((msg (apply #'format-message msg args)))
                         (setq show-paren--off-screen-overlay
                               (display-line-overlay (window-start) msg))))))
            (blink-matching-open))))

      ;; Hook our helper into the built-in paren function
      (advice-add #'show-paren-function :after #'show-paren-off-screen)))
#+end_src
**** 脉冲高亮
#+begin_src emacs-lisp
  (use-package pulse                       ; built-in since Emacs 29
    :ensure nil
    ;; Make pulse use the same colours as the active region
    :custom-face
    (pulse-highlight-start-face ((t (:inherit region :background unspecified))))
    (pulse-highlight-face ((t (:inherit region :background unspecified :extend t))))

    ;; Pulse after various “jump” commands
    :hook (((dumb-jump-after-jump imenu-after-jump)      . my/recenter-and-pulse)
           ((bookmark-after-jump magit-diff-visit-file next-error) . my/recenter-and-pulse-line))

    :init
    (with-no-warnings
      ;; ------------------------------------------------------------------
      ;; Core pulse helpers
      ;; ------------------------------------------------------------------
      (defun my/pulse-momentary-line (&rest _)
        "Briefly highlight the current line."
        (pulse-momentary-highlight-one-line (point)))

      (defun my/pulse-momentary (&rest _)
        "Pulse the active region, or fall back to the current line."
        (if (fboundp 'xref-pulse-momentarily)
            (xref-pulse-momentarily)
          (my/pulse-momentary-line)))

      (defun my/recenter-and-pulse (&rest _)
        "Recenter window, then pulse region / line."
        (recenter)
        (my/pulse-momentary))

      (defun my/recenter-and-pulse-line (&rest _)
        "Recenter window, then pulse only the current line."
        (recenter)
        (my/pulse-momentary-line))

      ;; ------------------------------------------------------------------
      ;; Generic navigation commands that deserve a subtle flash
      ;; ------------------------------------------------------------------
      (dolist (cmd '(recenter-top-bottom
                     other-window
                     switch-to-buffer
                     aw-select
                     toggle-window-split
                     windmove-do-window-select
                     pager-page-down
                     pager-page-up
                     treemacs-select-window))
        (advice-add cmd :after #'my/pulse-momentary-line))

      ;; ------------------------------------------------------------------
      ;; Mark / history jumps that also benefit from recentering
      ;; ------------------------------------------------------------------
      (dolist (cmd '(pop-to-mark-command
                     pop-global-mark
                     goto-last-change))
        (advice-add cmd :after #'my/recenter-and-pulse))))
#+end_src
** 编辑器设置
#+begin_src emacs-lisp
  (use-package emacs
    :custom
    ;; ------------------------------------------------------------------
    ;; Frame geometry
    ;; ------------------------------------------------------------------
    (frame-inhibit-implied-resize t)   ; stop Emacs auto-resizing frames
    (frame-resize-pixelwise t)         ; allow pixel-perfect frame sizing

    ;; ------------------------------------------------------------------
    ;; UI chrome off by default
    ;; ------------------------------------------------------------------
    (menu-bar-mode nil)                ; no menu bar
    (scroll-bar-mode nil)              ; no scroll bar
    (tool-bar-mode nil)                ; no tool bar
    (inhibit-startup-screen t)         ; skip *GNU Emacs* splash
    (use-dialog-box nil)               ; use minibuffer instead of pop-up dialogs

    ;; ------------------------------------------------------------------
    ;; Window dividers (thin, same colour as background)
    ;; ------------------------------------------------------------------
    (window-divider-default-right-width 1)
    (window-divider-default-bottom-width 1)
    (window-divider-default-places t)

    ;; ------------------------------------------------------------------
    ;; Editing behaviour
    ;; ------------------------------------------------------------------
    (delete-selection-mode t)          ; replace region when typing
    (electric-indent-mode nil)         ; I control indentation myself
    (electric-pair-mode t)             ; auto-insert matching pair
    (global-auto-revert-mode t)        ; auto-revert changed buffers

    ;; ------------------------------------------------------------------
    ;; Cursor & scrolling
    ;; ------------------------------------------------------------------
    (blink-cursor-mode nil)            ; static cursor
    (mouse-wheel-progressive-speed nil) ; linear scroll speed
    (scroll-conservatively 101)        ; never recenter when moving point
    (scroll-step 2)                    ; keyboard scroll lines
    (scroll-margin 2)                  ; start scrolling 2 lines from top/bottom

    ;; ------------------------------------------------------------------
    ;; Tabs & indentation
    ;; ------------------------------------------------------------------
    (tab-width 4)
    (indent-tabs-mode nil)             ; spaces, not tabs
    (tab-always-indent 'complete)      ; TAB ⇒ complete, then indent

    ;; ------------------------------------------------------------------
    ;; Backup / lock files OFF
    ;; ------------------------------------------------------------------
    (make-backup-files nil)
    (create-lockfiles nil)

    ;; ------------------------------------------------------------------
    ;; Completion
    ;; ------------------------------------------------------------------
    (completion-cycle-threshold 3)     ; cycle after 3 candidates

    ;; ------------------------------------------------------------------
    ;; *scratch* starts in Lisp-Interaction
    ;; ------------------------------------------------------------------
    (initial-major-mode 'lisp-interaction-mode)
    (tramp-persistency-file-name
     (expand-file-name "etc/tramp" user-emacs-directory))
    :init
    ;; ------------------------------------------------------------------
    ;; Create runtime directories once
    ;; ------------------------------------------------------------------
    (let ((dirs '("etc/" "etc/server/" "etc/auto-save-list/"
                  "etc/org-persist/" "etc/transient/" "etc/persistent-scratch/")))
      (dolist (dir dirs)
        (let ((full-dir (locate-user-emacs-file dir)))
          (unless (file-exists-p full-dir)
            (make-directory full-dir t)))))

    ;; ------------------------------------------------------------------
    ;; Centralise persistent files
    ;; ------------------------------------------------------------------
    (setq server-auth-dir        (locate-user-emacs-file "etc/server/")
          auto-save-list-file-prefix (locate-user-emacs-file "etc/auto-save-list/.saves-")
          custom-file            (locate-user-emacs-file "etc/custom-vars.el")
          default-directory      "C:/Users/wei/Documents/")

    ;; ------------------------------------------------------------------
    ;; Load custom-variables file silently
    ;; ------------------------------------------------------------------
    (load custom-file 'noerror 'nomessage)

    ;; ------------------------------------------------------------------
    ;; Silence warnings & async compiler chatter
    ;; ------------------------------------------------------------------
    (setq warning-minimum-level :emergency
          native-comp-async-report-warnings-errors nil)

    ;; ------------------------------------------------------------------
    ;; Frame title shows buffer name only
    ;; ------------------------------------------------------------------
    (setq frame-title-format "%b"
          icon-title-format "%b")

    ;; ------------------------------------------------------------------
    ;; Performance tweaks
    ;; ------------------------------------------------------------------
    (setq-default bidi-paragraph-direction 'left-to-right)
    (setq bidi-inhibit-bpa t               ; disable UAX#9 algorithm
          display-raw-bytes-as-hex t
          redisplay-skip-fontification-on-input t) ; stay responsive

    ;; ------------------------------------------------------------------
    ;; Horizontal / vertical scroll behaviour
    ;; ------------------------------------------------------------------
    (setq hscroll-step 2
          hscroll-margin 2
          scroll-preserve-screen-position 'always
          auto-hscroll-mode 'current-line   ; only current line hscrolls
          auto-window-vscroll nil)          ; no automatic vscroll

    ;; ------------------------------------------------------------------
    ;; Clipboard integration (Win32)
    ;; ------------------------------------------------------------------
    (setq select-enable-primary t
          select-enable-clipboard t
          mouse-yank-at-point t)            ; yank at point, not at click

    ;; ------------------------------------------------------------------
    ;; Misc niceties
    ;; ------------------------------------------------------------------
    (setq fill-column 80
          projectile-git-submodule-command nil ; faster project detection
          ;; Windows-specific I/O tweaks
          w32-get-true-file-attributes nil ; reduce stat calls
          w32-use-native-image-API t       ; faster image display
          w32-pipe-read-delay 0            ; faster subprocess I/O
          w32-pipe-buffer-size 65536)      ; 64 KB pipe buffer (was 4 KB)
    ;; ==========================================================================
    ;; Global convenience tweaks
    ;; ==========================================================================

    ;; Single-key y/n prompts
    (setq use-short-answers t
          y-or-n-p-use-read-key t
          read-char-choice-use-read-key t)

    ;; Visual bell, no audio
    (setq visible-bell t)

    ;; Performance
    (setq inhibit-compacting-font-caches t)

    ;; Move deleted files to system trash
    (setq delete-by-moving-to-trash t)

    ;; Disable *~ backups and #auto-save# files
    (setq make-backup-files nil
          auto-save-default nil)

    ;; Uniquify buffer names: <name-of-directory/post-fix>
    (setq uniquify-buffer-name-style 'post-forward-angle-brackets)

    ;; Adaptive fill for comments/lists
    (setq adaptive-fill-regexp "[ \t]+|[ \t]*([0-9]+\\.|\\*+)[ \t]*"
          adaptive-fill-first-line-regexp "^\\* *$")

    ;; Sentence-end: recognise Chinese punctuation as well
    (setq sentence-end "\
  \\([。！？]\\|……\\|[.?!][]\"')}]*\\($\\|\\\\\\)\\)[ \t]*"
          sentence-end-double-space nil)   ; single space after period

    ;; Better word-wrap for CJK
    (setq word-wrap-by-category t)

    ;; ------------------------------------------------------------------
    ;; M-x completion: show only suitable commands by default
    ;; ------------------------------------------------------------------
    (when (boundp 'read-extended-command-predicate)
      (setq read-extended-command-predicate
            #'command-completion-default-include-p))

    ;; ------------------------------------------------------------------
    ;; Re-enable commands that are disabled by default
    ;; ------------------------------------------------------------------
    (dolist (cmd '(narrow-to-defun narrow-to-page narrow-to-region
                                   dired-find-alternate-file list-timers list-threads))
      (put cmd 'disabled nil))

    ;; ------------------------------------------------------------------
    ;; Default font size (110 = 11 pt)
    ;; ------------------------------------------------------------------
    (set-face-attribute 'default nil :height 110)

    ;; ------------------------------------------------------------------
    ;; Underscore is part of a word (useful in snake_case languages)
    ;; ------------------------------------------------------------------
    (add-hook 'after-change-major-mode-hook
              (lambda ()
                (modify-syntax-entry ?_ "w")))

    :config

    ;; ------------------------------------------------------------------
    ;; Turn on window-divider mode and hide the pixels
    ;; ------------------------------------------------------------------
    (window-divider-mode 1)
    (let ((bg (face-attribute 'default :background)))
      (set-face-attribute 'window-divider nil :foreground bg)
      (set-face-attribute 'window-divider-first-pixel nil :foreground bg)
      (set-face-attribute 'window-divider-last-pixel nil :foreground bg))

    ;; ------------------------------------------------------------------
    ;; Allow editing variable values in Help buffers
    ;; ------------------------------------------------------------------
    (with-eval-after-load 'help-fns
      (put 'help-fns-edit-variable 'disabled nil))

    :bind
    ;; One escape to quit recursive edits, pop up windows, etc.
    ([escape] . keyboard-escape-quit))


  ;; ------------------------------------------------------------------
  ;; winner-mode – undo/redo window configurations
  ;; ------------------------------------------------------------------
  (use-package winner
    :ensure nil
    :commands (winner-undo winner-redo)
    :hook (after-init . winner-mode)
    :custom
    (winner-boring-buffers          ; don’t record these buffers
     '("*Completions*"
       "*Compile-Log*"
       "*inferior-lisp*"
       "*Fuzzy Completions*"
       "*Apropos*"
       "*Help*"
       "*cvs*"
       "*Buffer List*"
       "*Ibuffer*"
       "*esh command on file*")))
#+end_src

** 编辑体验增强
*** Simple 模式增强
#+begin_src emacs-lisp
  (use-package simple
    :ensure nil
    :hook ((after-init . size-indication-mode)        ; show file size in mode-line
           (text-mode   . visual-line-mode)           ; soft wrap long lines
           ;; show trailing whitespace in code/docs and strip on save
           ((prog-mode markdown-mode conf-mode) . enable-trailing-whitespace))
    :config
    ;; ------------------------------------------------------------------
    ;; baseline options
    ;; ------------------------------------------------------------------
    (setq column-number-mode t              ; show cursor column
          line-number-mode t                ; show cursor line
          line-move-visual nil              ; C-n/C-p by logical lines
          track-eol t                       ; keep cursor at EOL when moving
          set-mark-command-repeat-pop t)    ; C-u C-SPC pops previous marks

    ;; default: no trailing-whitespace indicator
    (setq-default show-trailing-whitespace nil)

    ;; ------------------------------------------------------------------
    ;; minor mode: show trailing spaces and delete them on save
    ;; ------------------------------------------------------------------
    (defun enable-trailing-whitespace ()
      "Turn on `show-trailing-whitespace' and auto-clean on save."
      (setq show-trailing-whitespace t)
      (add-hook 'before-save-hook #'delete-trailing-whitespace nil t))

    ;; ------------------------------------------------------------------
    ;; Prettify *Process List* buffer with colours
    ;; ------------------------------------------------------------------
    (with-no-warnings
      (defun my/list-processes--prettify ()
        "Add faces to process status, TTY, thread, etc."
        (when-let* ((entries tabulated-list-entries))
          (setq tabulated-list-entries nil)
          (dolist (p (process-list))
            (when-let* ((val (cadr (assoc p entries)))
                        (name (aref val 0))
                        (pid  (aref val 1))
                        (status (aref val 2))
                        (status-face (if (memq status '(stop exit closed failed))
                                         'error 'success))
                        (buf-label (aref val 3))
                        (tty  (list (aref val 4)  'face 'font-lock-doc-face))
                        (thread (list (aref val 5) 'face 'font-lock-doc-face))
                        (cmd  (list (aref val 6)  'face 'completions-annotations)))
              (push (list p (vector name
                                    pid
                                    (list status 'face status-face)
                                    buf-label
                                    tty
                                    thread
                                    cmd))
                    tabulated-list-entries)))))
      (advice-add #'list-processes--refresh :after #'my/list-processes--prettify)))
#+end_src
*** 删除选中文本
#+begin_src emacs-lisp
  (use-package delsel
    :ensure nil
    :hook (after-init . delete-selection-mode))
#+end_src
*** 跳转 (Avy)
#+begin_src emacs-lisp
  (use-package avy
    :defer t
    :ensure t
    :bind (("C-:" . avy-goto-char)
           ("C-\"" . avy-goto-char-2))
    ;;:hook (after-init . avy-setup-default)
    :config
    (setq avy-all-windows nil
          avy-all-windows-alt t
          avy-background t
          avy-style 'pre))
#+end_src
*** 自动配对
#+begin_src emacs-lisp
  (use-package elec-pair
    :ensure nil
    :hook (after-init . electric-pair-mode)
    :config
    (setq electric-pair-inhibit-predicate 'electric-pair-conservative-inhibit))
#+end_src
*** 智能删除空白
#+begin_src emacs-lisp
  (use-package hungry-delete
    :ensure t
    :diminish
    :hook (after-init . global-hungry-delete-mode)
    :init
    (setq hungry-delete-chars-to-skip " \t\f\v"
          hungry-delete-except-modes
          '(help-mode minibuffer-mode minibuffer-inactive-mode calc-mode)))
#+end_src
*** 智能行首行尾移动
#+begin_src emacs-lisp
  (use-package mwim
    :ensure t
    :bind (([remap move-beginning-of-line] . mwim-beginning)
           ([remap move-end-of-line] . mwim-end)))
#+end_src
*** 长行处理
#+begin_src emacs-lisp
  (use-package so-long
    :ensure t
    :hook (after-init . global-so-long-mode))
#+end_src
*** Hideshow & auto-fill
#+BEGIN_SRC emacs-lisp
  (use-package hideshow
    :ensure nil
    :hook
    (prog-mode . hs-minor-mode))
#+end_src
*** Stripspace
#+BEGIN_SRC emacs-lisp
  (use-package stripspace
    :ensure t
    :commands stripspace-local-mode
    ;; Enable for prog-mode-hook, text-mode-hook
    :hook ((prog-mode . stripspace-local-mode)
           (text-mode . stripspace-local-mode))
    :custom
    (stripspace-only-if-initially-clean nil)
    (stripspace-restore-column t))
#+end_src
*** Anzu
#+begin_src emacs-lisp
  (use-package anzu
    :ensure t
    :bind
    ([remap query-replace] . anzu-query-replace)
    ([remap query-replace-regexp] . anzu-query-replace-regexp))
#+end_src
*** visual-replace
#+begin_src emacs-lisp
  (use-package visual-replace
    :ensure t
    :bind (([remap query-replace] . visual-replace)
           :map isearch-mode-map
           ("C-c r" . visual-replace-from-isearch)))
#+end_src
** 补全、搜索与命令面板
*** Orderless Vertico Marginalia
#+begin_src emacs-lisp
  ;; ------------------------------------------------------------------
  ;; Orderless – advanced completion style
  ;; ------------------------------------------------------------------
  (use-package orderless
    :ensure t
    :defer t
    :after vertico                       ; load only after vertico
    :custom
    ;; Orderless as the primary style, fall back to basic for simple matches
    (completion-styles '(orderless basic))
    ;; Files: use basic + partial-completion for speed
    (completion-category-overrides '((file (styles basic partial-completion))))
    ;; Ignore built-in category defaults
    (completion-category-defaults nil)
    ;; Space can be escaped to match literal space
    (orderless-component-separator #'orderless-escapable-split-on-space))

  ;; ------------------------------------------------------------------
  ;; Pinyin support for orderless (Chinese input)
  ;; ------------------------------------------------------------------
  (use-package pinyinlib
    :ensure t
    :after orderless
    :autoload pinyinlib-build-regexp-string
    :init
    (defun completion--regex-pinyin (str)
      "Convert STR to pinyin regexp for orderless."
      (orderless-regexp (pinyinlib-build-regexp-string str)))
    ;; Register the new matching style
    (add-to-list 'orderless-matching-styles 'completion--regex-pinyin))

  ;; ------------------------------------------------------------------
  ;; Vertico – vertical completion UI
  ;; ------------------------------------------------------------------
  (use-package vertico
    :ensure t
    :hook (after-init . vertico-mode)
    :bind (:map vertico-map
           ("RET"   . vertico-directory-enter)      ; enter directory
           ("DEL"   . vertico-directory-delete-char) ; delete char or go up dir
           ("M-DEL" . vertico-directory-delete-word)) ; delete word
    :custom
    (vertico-count 17)                ; 15 candidates visible
    (vertico-cycle t)                 ; wrap around
    (vertico-resize nil)             ; keep height fixed

    ;; Tidy shadowed file name in minibuffer when moving through directories
    :config
    (add-hook 'rfn-eshadow-update-overlay-hook #'vertico-directory-tidy))

  ;; ------------------------------------------------------------------
  ;; Marginalia – rich annotations in minibuffer
  ;; ------------------------------------------------------------------

  (use-package marginalia
    :ensure t
    :hook (after-init . marginalia-mode)
    :custom
    ;; 优化：右对齐，更美观
    (marginalia-align 'center)
    ;; 增加字段宽度，显示更多信息
    (marginalia-max-relative-age 0)
    ;; 自定义注解器顺序
    (marginalia-annotator-registry
     (append marginalia-annotator-registry
             '((command marginalia-annotate-command builtin none)
               (symbol marginalia-annotate-symbol builtin none))))
    :config
    ;; 性能优化：延迟文件大小计算
    (setq marginalia-field-width 80)

    ;; 自定义某些类别的注解
    (with-eval-after-load 'project
      (add-to-list 'marginalia-command-categories
                   '(project-find-file . file))))

  ;; Add icons to completion candidates
  (use-package nerd-icons-completion
    :ensure t
    :after (marginalia nerd-icons)
    :hook (marginalia-mode . nerd-icons-completion-marginalia-setup)
    :config
    ;; 性能优化：缓存图标
    (nerd-icons-completion-mode 1))
  ;; ------------------------------------------------------------------
  ;; consult-dir – quick directory switching within consult
  ;; ------------------------------------------------------------------
  (use-package consult-dir
    :ensure t
    :after consult)

  ;; ------------------------------------------------------------------
  ;; Consult – unified search/navigation commands
  ;; ------------------------------------------------------------------
  (use-package consult
    :ensure t
    :defer t
    :hook (completion-list-mode . consult-preview-at-point-mode)
    :bind (;; replace built-ins with consult equivalents
           ([remap imenu]                    . consult-imenu)
           ([remap isearch-forward]          . consult-line)
           ([remap isearch-backward]         . consult-line)
           ([remap find-file-read-only]      . consult-recent-file)
           ([remap list-directory]           . consult-dir)
           ([remap goto-line]                . consult-goto-line)
           ([remap bookmark-jump]            . consult-bookmark)
           ([remap recentf-open-files]       . consult-recent-file)
           ([remap repeat-complex-command]   . consult-complex-command)
           ([remap jump-to-register]         . consult-register-load)
           ([remap point-to-register]        . consult-register-store))

    :config
    ;; Use consult for xref buffers
    (with-eval-after-load 'xref
      (setq xref-show-xrefs-function         #'consult-xref
            xref-show-definitions-function #'consult-xref))

    ;; ----------------------------------------------------------------
    ;; Extra consult utilities
    ;; ----------------------------------------------------------------
    (defvar consult-colors-history nil)

    ;; --- Emacs built-in colours ---
    (autoload 'list-colors-duplicates "facemenu")
    (defun consult-colors-emacs (color)
      "Insert selected Emacs colour name."
      (interactive
       (list (consult--read (list-colors-duplicates (defined-colors))
                            :prompt "Emacs color: "
                            :require-match t
                            :category 'color
                            :history '(:input consult-colors-history))))
      (insert color))

    ;; --- CSS colours ---
    (autoload 'consult--read "consult")
    (defun consult-colors--web-list ()
      "Return sorted list of CSS colour names."
      (require 'shr-color)
      (sort (mapcar #'downcase (mapcar #'car shr-color-html-colors-alist))
            #'string-lessp))

    (defun consult-colors-web (color)
      "Insert selected CSS colour name."
      (interactive
       (list (consult--read (consult-colors--web-list)
                            :prompt "CSS color: "
                            :require-match t
                            :category 'color
                            :history '(:input consult-colors-history))))
      (insert color))

    ;; --- Orderless compiler for consult ---
    (defun consult--orderless-regexp-compiler (input type &rest _config)
      "Use orderless patterns inside consult."
      (setq input (orderless-pattern-compiler input))
      (cons
       (mapcar (lambda (r) (consult--convert-regexp r type)) input)
       (lambda (str) (orderless--highlight input str))))

    ;; ----------------------------------------------------------------
    ;; Preview & performance
    ;; ----------------------------------------------------------------
    (with-no-warnings
      (consult-customize
       consult-ripgrep consult-fd
       consult-bookmark consult-goto-line consult-theme
       consult-recent-file consult-buffer
       :preview-key '(:debounce 0.2 any)))

    (setq register-preview-delay 0.5
          register-preview-function #'consult-register-format)

    :custom
    (consult-fontify-preserve nil)        ; faster fontification
    (consult-async-min-input 2)           ; start search after 2 chars
    (consult-async-refresh-delay 0.15)
    (consult-async-input-throttle 0.2)
    (consult-async-input-debounce 0.1))


  ;; ------------------------------------------------------------------
  ;; Embark – contextual actions on minibuffer candidates
  ;; ------------------------------------------------------------------
  (use-package embark
    :ensure t
    :bind (;; full bindings list
           ([remap describe-bindings] . embark-bindings)
           :map minibuffer-local-map
           ("C-;"     . embark-dwim)
           ("M-o"     . embark-act)          ; act on candidate
           ("C-c C-c" . embark-export)       ; export to writable buffer
           ("M-."     . my/embark-preview)   ; preview without quitting
           ("C-c C-o" . embark-collect))     ; open collect buffer

    :init
    ;; Make C-h display embark keymap instead of standard help
    (setq prefix-help-command #'embark-prefix-help-command)

    :config
    ;; Preview candidate in other window without leaving minibuffer
    (defun my/embark-preview ()
      "Preview candidate in vertico/consult buffer."
      (interactive)
      (unless (bound-and-true-p consult--preview-function)
        (save-selected-window
          (let ((embark-quit-after-action nil))
            (embark-dwim)))))

    ;; Hide modeline in Embark Collect buffers
    (add-to-list 'display-buffer-alist
                 '("\\`\\*Embark Collect \\(?:\\$Live\\|Completions\\)\\*"
                   nil
                   (window-parameters (mode-line-format . none))))

    ;; ----------------------------------------------------------------
    ;; which-key integration for embark
    ;; ----------------------------------------------------------------
    (with-eval-after-load 'which-key
      (defun embark-which-key-indicator ()
        "Show embark keymap via which-key."
        (lambda (&optional keymap targets prefix)
          (if (null keymap)
              (which-key--hide-popup-ignore-command)
            (which-key--show-keymap
             (if (eq (plist-get (car targets) :type) 'embark-become)
                 "Become"
               (format "Act on %s '%s'%s"
                       (plist-get (car targets) :type)
                       (embark--truncate-target (plist-get (car targets) :target))
                       (if (cdr targets) "…" "")))
             (if prefix
                 (pcase (lookup-key keymap prefix 'accept-default)
                   ((and (pred keymapp) km) km)
                   (_ (key-binding prefix 'accept-default)))
               keymap)
             nil nil t
             (lambda (binding)
               (not (string-suffix-p "-argument" (cdr binding))))))))

      ;; Replace default embark indicators
      (setq embark-indicators
            '(embark-which-key-indicator
              embark-highlight-indicator
              embark-isearch-highlight-indicator))

      ;; Hide which-key immediately when embark prompt ends
      (defun embark-hide-which-key-indicator (fn &rest args)
        (which-key--hide-popup-ignore-command)
        (let ((embark-indicators
               (remq #'embark-which-key-indicator embark-indicators)))
          (apply fn args)))
      (advice-add #'embark-completing-read-prompter
                  :around #'embark-hide-which-key-indicator)))


  ;; ------------------------------------------------------------------
  ;; Bridge between embark and consult
  ;; ------------------------------------------------------------------
  (use-package embark-consult
    :ensure t
    :after embark
    :bind (:map minibuffer-mode-map
           ("C-c C-o" . embark-export))   ; same as above, redundant but clear
    :hook (embark-collect-mode . consult-preview-at-point-mode)
    :config
    ;; 优化：自动 wgrep 模式
    (with-eval-after-load 'wgrep
      (setq wgrep-auto-save-buffer t)
      (setq wgrep-change-readonly-file t)))
#+end_src
*** 自动补全
#+begin_src emacs-lisp
  ;; ------------------------------------------------------------------
  ;; Corfu – in-buffer completion popup
  ;; ------------------------------------------------------------------
  (use-package corfu
    :ensure t
    :defer t
    :demand nil
    :functions persistent-scratch-save corfu-move-to-minibuffer
    :init
    ;; ----------------  core settings  ----------------
    (setq corfu-auto t                   ; popup automatically
          corfu-auto-prefix 2            ; after 2 chars
          corfu-auto-delay 0.2           ; 0.2 s delay
          corfu-count 12                 ; max 12 candidates
          corfu-cycle t                  ; wrap around
          corfu-min-width 25
          corfu-left-margin-width 2
          corfu-preview-current nil      ; don't insert candidate until RET
          corfu-on-exact-match nil       ; still show popup on exact match
          corfu-popupinfo-delay '(0.4 . 0.2) ; doc popup: show 0.4 s, hide 0.2 s
          ;; disable ispell completion when Corfu is active
          text-mode-ispell-word-completion nil
          ispell-alternate-dictionary nil)
    ;; enable Corfu everywhere except listed modes
    (setq global-corfu-modes '((not erc-mode circe-mode help-mode
                                    org-mode gud-mode vterm-mode) t))
    :bind (:map corfu-map
           ("<escape>" . corfu-quit)
           ("TAB"      . corfu-next)
           ([tab]      . corfu-next)
           ("RET"      . corfu-complete)
           ("S-TAB"    . corfu-previous)
           ([backtab]  . corfu-previous))
    :hook ((after-init . global-corfu-mode)
           (global-corfu-mode . corfu-popupinfo-mode)
           (global-corfu-mode . corfu-history-mode))
    :custom-face
    (corfu-border ((t (:inherit region :background unspecified))))
    :config
    ;; quit completion before saving
    (add-hook 'before-save-hook #'corfu-quit)
    (advice-add #'persistent-scratch-save :before #'corfu-quit)
    ;; promote corfu popup into minibuffer when needed
    (defun corfu-move-to-minibuffer ()
      "Move Corfu completion to minibuffer with Consult."
      (interactive)
      (pcase completion-in-region--data
        (`(,beg ,end ,table ,pred ,extras)
         (let ((completion-extra-properties extras)
               (completion-cycle-threshold completion-cycling))
           (consult-completion-in-region beg end table pred)))))
    (add-to-list 'corfu-continue-commands #'corfu-move-to-minibuffer))
  ;; ------------------------------------------------------------------
  ;; Nerd-icons for Corfu margins
  ;; ------------------------------------------------------------------
  (use-package nerd-icons-corfu
    :ensure t
    :after corfu
    :init
    (add-to-list 'corfu-margin-formatters #'nerd-icons-corfu-formatter))
  ;; ------------------------------------------------------------------
  ;; CAPF backends
  ;; ------------------------------------------------------------------
  (use-package cape
    :ensure t
    :commands (cape-file cape-elisp-block cape-keyword cape-dabbrev)
    :init
    ;; lightweight static backends
    (add-to-list 'completion-at-point-functions #'cape-dabbrev)
    (add-to-list 'completion-at-point-functions #'cape-file)
    (add-hook 'org-mode-hook
              (lambda ()
                (setq-local completion-at-point-functions
                            (delq 'yasnippet-capf completion-at-point-functions))))
    (add-hook 'emacs-lisp-mode-hook
              (lambda () (add-to-list 'completion-at-point-functions #'cape-elisp-block)))
    (add-to-list 'completion-at-point-functions #'cape-keyword))

  ;; ------------------------------------------------------------------
  ;; Yasnippet integration
  ;; ------------------------------------------------------------------
  (use-package yasnippet
    :ensure t
    :diminish
    :hook ((LaTeX-mode python-ts-mode ess-r-mode ) . yas-minor-mode)
    :config
    (yas-reload-all)
    ;; silence backquote-change warning
    (with-eval-after-load 'warnings
      (cl-pushnew '(yasnippet backquote-change) warning-suppress-types :test 'equal))

    (setq yas-triggers-in-field t)       ; allow nested expansion

    ;; auto-expand snippets marked with condition: auto
    (defun my/yas-try-expanding-auto-snippets ()
      "Expand `auto' conditioned snippets immediately."
      (when (and (bound-and-true-p yas-minor-mode)
                 (not (memq this-command '(yas-expand yas-next-field yas-prev-field))))
        (let ((yas-buffer-local-condition ''(require-snippet-condition . auto)))
          (yas-expand))))
    (add-hook 'post-self-insert-hook #'my/yas-try-expanding-auto-snippets)

    :custom
    (yas-snippet-dirs (list (locate-user-emacs-file "yasnippets"))))


  ;; ------------------------------------------------------------------
  ;; Let Corfu + Eglot see Yasnippet candidates
  ;; ------------------------------------------------------------------
  (use-package yasnippet-capf
    :ensure t
    :after (cape eglot)
    :commands yasnippet-capf
    :init
    ;; prepend yasnippet to default capf list
    (add-to-list 'completion-at-point-functions #'yasnippet-capf)
    ;; inside eglot buffers merge server + yasnippet completions
    (defun my/eglot-capf-with-yasnippet ()
      "Combine Eglot and Yasnippet completion."
      (setq-local completion-at-point-functions
                  (list (cape-capf-super
                         #'eglot-completion-at-point
                         #'yasnippet-capf))))
    (add-hook 'eglot-managed-mode-hook #'my/eglot-capf-with-yasnippet))
#+end_src
** 项目文件与工具
*** Ibuffer
#+begin_src emacs-lisp
  ;; ------------------------------------------------------------------
  ;; Enhanced buffer list
  ;; ------------------------------------------------------------------
  (use-package ibuffer
    :ensure nil
    :bind ("C-x C-b" . ibuffer)          ; replace stock buffer list
    :init
    ;; nicer group heading face
    (setq ibuffer-filter-group-name-face '(:inherit (font-lock-string-face bold))))

  ;; ------------------------------------------------------------------
  ;; Icons for ibuffer
  ;; ------------------------------------------------------------------
  (use-package nerd-icons-ibuffer
    :ensure t
    :after ibuffer
    :hook (ibuffer-mode . nerd-icons-ibuffer-mode)
    :config
    (setq nerd-icons-ibuffer-icon t))    ; show icons before buffer names
#+end_src
*** Minibuffer
#+begin_src emacs-lisp
  (use-package minibuffer
    :ensure nil
    ;; ------------------------------------------------------------------
    ;; Consistent ESC behaviour in every minibuffer keymap
    ;; ------------------------------------------------------------------
    :bind (:map minibuffer-local-map              ([escape] . abort-recursive-edit)
           :map minibuffer-local-ns-map           ([escape] . abort-recursive-edit)
           :map minibuffer-local-completion-map   ([escape] . abort-recursive-edit)
           :map minibuffer-local-must-match-map   ([escape] . abort-recursive-edit)
           :map minibuffer-local-isearch-map      ([escape] . abort-recursive-edit))

    :custom
    ;; ------------------------------------------------------------------
    ;; Completion behaviour
    ;; ------------------------------------------------------------------
    (completion-auto-help t)                    ; show *Completions* when needed
    (completion-show-help nil)                  ; but no extra help message
    (completion-cycle-threshold nil)            ; always show *Completions* buffer
    (completion-auto-select 'second-tab)        ; TAB twice to pick first
    (enable-recursive-minibuffers t)            ; allow commands in minibuffer
    (minibuffer-depth-indicate-mode t)          ; show [n] in prompt when nested
    (minibuffer-default-prompt-format " [%s]")  ; hint for default value
    (minibuffer-electric-default-mode t)        ; dim default part after accept
    (minibuffer-completion-auto-choose nil)     ; don't auto-choose sole match
    (minibuffer-follows-selected-frame nil)     ; stay on original frame

    ;; ------------------------------------------------------------------
    ;; Case handling
    ;; ------------------------------------------------------------------
    (completion-ignore-case t)
    (read-buffer-completion-ignore-case t)
    (read-file-name-completion-ignore-case t)

    ;; ------------------------------------------------------------------
    ;; Completion styles (order matters)
    ;; ------------------------------------------------------------------
    (completion-styles '(basic partial-completion substring flex))
    (completion-category-overrides
     '((buffer (styles . (flex)))          ; flex for buffer names
       (imenu  (styles . (substring)))))   ; substring for imenu

    ;; ------------------------------------------------------------------
    ;; *Completions* buffer layout
    ;; ------------------------------------------------------------------
    (completions-format 'one-column)       ; vertical list
    (completions-max-height 13)            ; max 13 rows
    (completions-detailed t))              ; show annotations (e.g. keybindings)
#+end_src
*** Dired
#+begin_src emacs-lisp
  (use-package dired
    :ensure nil
    :bind (:map dired-mode-map
           ("C-c C-p" . wdired-change-to-wdired-mode)) ; quick-edit filenames
    :custom
    ;; ------------------------------------------------------------------
    ;; Smart copy/move destination: auto-pick dir in other window
    ;; ------------------------------------------------------------------
    (dired-dwim-target t)

    ;; Always recurse into subdirs for deletes/copies
    (dired-recursive-deletes  'always)
    (dired-recursive-copies   'always)

    ;; Human-readable listing: long, show-hidden, sort dirs-first
    (dired-listing-switches "-alh --group-directories-first")

    ;; Performance / UX
    (dired-hide-details-mode nil)               ; show full details by default
    (dired-kill-when-opening-new-dired-buffer t) ; replace buffer when navigating (Emacs 28+)
    :hook (dired-mode . auto-revert-mode)       ; auto-refresh on external changes

    :config
    ;; Windows fallback if GNU ls is missing
    (when (and (eq system-type 'windows-nt)
               (not (executable-find "ls")))
      (setq dired-listing-switches "-alh")))    ; native ls only supports short flags


  ;; ------------------------------------------------------------------
  ;; Extra dired goodies
  ;; ------------------------------------------------------------------

  ;; colourful dired
  (use-package diredfl
    :ensure t
    :hook (dired-mode . diredfl-mode))

  ;; icons
  (use-package nerd-icons-dired
    :ensure t
    :diminish
    :custom-face
    (nerd-icons-dired-dir-face ((t (:inherit nerd-icons-dsilver :foreground unspecified))))
    :hook (dired-mode . nerd-icons-dired-mode))

  ;; fd-powered fast file search
  (use-package fd-dired
    :ensure t
    :when (executable-find "fd")
    :bind (:map dired-mode-map
           ("C-c f" . fd-dired)))
#+end_src

*** Ripgrep
#+begin_src emacs-lisp
  (use-package rg
    :ensure t
    ;; Activate default key-bindings under C-c s prefix
    :hook (after-init . rg-enable-default-bindings)

    ;; Quick-access keys (after C-c s)
    :bind (:map rg-global-map
           ("c" . rg-dwim-current-dir)   ; search in current directory
           ("f" . rg-dwim-current-file)  ; search in current buffer's file
           ("m" . rg-menu))              ; open interactive menu

    :init
    ;; Pretty results: group matches and show column numbers
    (setq rg-group-result t
          rg-show-columns t)

    :config
    ;; Add custom file-type alias for Go templates
    (cl-pushnew '("tmpl" . "*.tmpl") rg-custom-type-aliases))
#+end_src

*** Bookmark
#+begin_src emacs-lisp
  (use-package bookmark
    :ensure nil
    :config
    ;; ------------------------------------------------------------------
    ;; Keep bookmarks under ~/.emacs.d/etc/bookmarks
    ;; ------------------------------------------------------------------
    (setq bookmark-default-file (locate-user-emacs-file "etc/bookmarks"))

    ;; ------------------------------------------------------------------
    ;; Prettier bookmark list (tabulated-list)
    ;; ------------------------------------------------------------------
    (with-no-warnings
      (defun my/bookmark-bmenu--revert ()
        "Re-populate bookmark list with icons, status, shorter paths."
        (let (entries)
          (dolist (full-record (bookmark-maybe-sort-alist))
            (let* ((name (bookmark-name-from-record full-record))
                   (annotation (bookmark-get-annotation full-record))
                   (location (bookmark-location full-record))
                   (file (file-name-nondirectory location))
                   (icon (if (and (icons-displayable-p)
                                  (not (string-empty-p file)))
                             (nerd-icons-icon-for-file file)
                           ""))
                   (type (cond ((null location)
                                (propertize "NOFILE"  'face 'warning))
                               ((file-remote-p location)
                                (propertize "REMOTE"  'face 'mode-line-buffer-id))
                               ((not (file-exists-p location))
                                (propertize "MISSING" 'face 'error))
                               ((file-directory-p location)
                                (propertize "DIRED"   'face 'warning))
                               (t
                                (propertize "FILE"    'face 'success)))))
              (push (list full-record
                          (vector (if (and annotation (not (string= annotation "")))
                                      "*" "")
                                  icon
                                  (if (display-mouse-p)
                                      (propertize name
                                                  'font-lock-face 'bookmark-menu-bookmark
                                                  'mouse-face 'highlight
                                                  'follow-link t
                                                  'help-echo "mouse-2: visit in other window")
                                    name)
                                  type
                                  (if bookmark-bmenu-toggle-filenames
                                      (propertize location 'face 'completions-annotations)
                                    "")))
                    entries)))
          (setq tabulated-list-entries (nreverse entries)))
        (tabulated-list-init-header)
        (tabulated-list-print t))

      ;; Replace original revert function
      (advice-add #'bookmark-bmenu--revert :override #'my/bookmark-bmenu--revert)

      ;; Entry point: ensure file is loaded, pop to buffer
      (defun my/bookmark-bmenu-list ()
        "Display enhanced bookmark list."
        (interactive)
        (bookmark-maybe-load-default-file)
        (let ((buf (get-buffer-create bookmark-bmenu-buffer)))
          (if (called-interactively-p 'interactive)
              (pop-to-buffer buf)
            (set-buffer buf)))
        (bookmark-bmenu-mode)
        (my/bookmark-bmenu--revert))

      ;; Override default list command
      (advice-add #'bookmark-bmenu-list :override #'my/bookmark-bmenu-list)

      ;; Tweak column widths & padding
      (define-derived-mode bookmark-bmenu-mode tabulated-list-mode "Bookmarks"
        "Prettified bookmark browser."
        (setq truncate-lines t)
        (setq buffer-read-only t)
        (setq tabulated-list-format
              `[("" 1)
                ("Icon" 2)
                ("Bookmark" ,bookmark-bmenu-file-column bookmark-bmenu--name-predicate)
                ("Type" 8)
                ,@(if bookmark-bmenu-toggle-filenames
                      '(("Location" 0 bookmark-bmenu--file-predicate))
                    '())])
        (setq tabulated-list-padding bookmark-bmenu-marks-width)
        (setq tabulated-list-sort-key '("Bookmark" . nil))
        (add-hook 'tabulated-list-revert-hook #'my/bookmark-bmenu--revert nil t)
        (setq revert-buffer-function #'my/bookmark-bmenu--revert)
        (tabulated-list-init-header))))
#+end_src
** 笔记系统
*** Org 性能优化
#+begin_src emacs-lisp
  (defvar my/org-optimized-p nil
    "Whether Org emphasis regexp has been optimised.")

  (defun my/org-optimize-emphasis-parsing ()
    "One-time tweak to make Org emphasis parsing faster and CJK-friendly."
    (interactive)
    (unless my/org-optimized-p
      ;; ----------------------------------------------------------
      ;; 1.  Simpler pre/post chars → fewer back-tracking steps
      ;; ----------------------------------------------------------
      (setq org-emphasis-regexp-components
            '("-[:space:]('\"{[:nonascii:]"   ; pre
              "-[:space:].,:!?;'\")}\$$[:nonascii:]" ; post
              "[:space:]"                      ; border
              "."                              ; body
              1))                              ; newline ok

      ;; ----------------------------------------------------------
      ;; 2.  Tell Org to rebuild the emphasis regexps
      ;; ----------------------------------------------------------
      (org-set-emph-re 'org-emphasis-regexp-components
                       org-emphasis-regexp-components)

      ;; ----------------------------------------------------------
      ;; 3.  (Optional) tighten sub-string regexp for LaTeX/CJK
      ;; ----------------------------------------------------------
      (setq org-match-substring-regexp
            (concat
             ;; LaTeX symbols  $$...$$, $...$
             "\\(?:\$\$[^$]+\$\$\\|\$[^$]+\$\\)"
             "\\|"
             ;; balanced {...} or (...)  – up to org-match-sexp-depth
             (org-create-multibrace-regexp "{" "}" org-match-sexp-depth)
             "\\|"
             (org-create-multibrace-regexp "(" ")" org-match-sexp-depth)
             "\\|"
             ;; simple asterisk list marker or numeric prefix
             "\\(?:\\*\\|[+-]?[0-9]+\\)"))

      ;; ----------------------------------------------------------
      ;; 4.  Force Org to recompile its syntax table
      ;; ----------------------------------------------------------
      (org-element-update-syntax)
      (setq my/org-optimized-p t)))

  ;; Auto-apply when first opening an Org file
  (add-hook 'org-mode-hook #'my/org-optimize-emphasis-parsing)
#+end_src
*** Org-mode 核心配置
#+begin_src emacs-lisp
  (use-package org
    :diminish
    :defer t
    :mode ("\\.org\\'" . org-mode)
    :hook
    ((org-mode . (lambda ()
                   (face-remap-add-relative 'bold :foreground "#0080ff")
                   (lazytab-mode 1)               ; TAB cycles headings/src blocks
                   (visual-line-mode 1)           ; soft wrap long lines
                   (yas-minor-mode 1)             ; snippets
                   (my/add-latex-in-org-mode-expansions)
                   ;; one-time emphasis regexp optimisation
                   (my/org-optimize-emphasis-parsing)))
     ;; refresh inline images after executing babel blocks
     (org-babel-after-execute . org-redisplay-inline-images))
    :bind (("C-c a" . org-agenda)               ; global agenda dispatcher
           :map org-mode-map
           ("C-c i" . yank-media)               ; paste image from clipboard
           ("C-c l" . org-store-link))          ; store link to heading/file
    :custom
    ;; ----------------------------------------------------------------
    ;; Paths & persistence
    ;; ----------------------------------------------------------------
    (org-persist-directory (locate-user-emacs-file "etc/org-persist/"))
    (org-directory my/org-agenda-root)          ; defined elsewhere
    ;; ----------------------------------------------------------------
    ;; Display & cosmetics
    ;; ----------------------------------------------------------------
    (org-hide-emphasis-markers t)               ; hide * / = markers
    (org-startup-indented t)                    ; indent text to heading level
    (org-fontify-todo-headline nil)             ; no extra face on TODO keyword
    (org-fontify-done-headline t)               ; grey out DONE headings
    (org-fontify-whole-heading-line t)          ; highlight entire heading
    (org-fontify-quote-and-verse-blocks t)
    (org-ellipsis " [+]")                       ; cleaner folding indicator
    (org-image-actual-width '(600))             ; max 600 px wide images
    ;; ----------------------------------------------------------------
    ;; Lists & checkboxes
    ;; ----------------------------------------------------------------
    (org-list-demote-modify-bullet              ; cycle bullets on demote
     '(("+" . "-") ("1." . "a.") ("-" . "+")))
    ;; ----------------------------------------------------------------
    ;; LaTeX preview
    ;; ----------------------------------------------------------------
    (org-preview-latex-image-directory
     (expand-file-name "orgltxpng/" (or (getenv "TEMP") "/tmp")))
    (org-latex-preview-numbered t)
    ;; ----------------------------------------------------------------
    ;; Navigation & imenu
    ;; ----------------------------------------------------------------
    (org-imenu-depth 4)
    ;; ----------------------------------------------------------------
    ;; TODO keywords & faces (Nord palette)
    ;; ----------------------------------------------------------------
    (org-todo-keywords
     '((sequence "TODO(t)" "HOLD(h!)" "WIP(i!)" "WAIT(w!)" "|" "DONE(d!)" "CANCELLED(c@/!)")))
    (org-todo-keyword-faces
     '(("TODO"      :foreground "#7c7c75" :weight bold)
       ("HOLD"      :foreground "#feb24c" :weight bold)
       ("WIP"       :foreground "#0098dd" :weight bold)
       ("WAIT"      :foreground "#9f7efe" :weight bold)
       ("DONE"      :foreground "#50a14f" :weight bold)
       ("CANCELLED" :foreground "#ff6480" :weight bold)))
    (org-use-fast-todo-selection 'expert)       ; single-key speed selection
    (org-enforce-todo-dependencies t)           ; block parent until kids done
    (org-enforce-todo-checkbox-dependencies t)
    ;; ----------------------------------------------------------------
    ;; Priorities & properties
    ;; ----------------------------------------------------------------
    (org-priority-faces
     '((?A . (:foreground "red"))
       (?B . (:foreground "orange"))
       (?C . (:foreground "yellow"))))
    (org-global-properties
     '(("EFFORT_ALL" . "0:15 0:30 0:45 1:00 2:00 3:00 4:00 5:00 6:00 7:00 8:00")
       ("APPT_WARNTIME_ALL" . "0 5 10 15 20 25 30 45 60")
       ("STYLE_ALL" . "habit")))
    (org-columns-default-format
     "%25ITEM %TODO %SCHEDULED %DEADLINE %3PRIORITY %TAGS %CLOCKSUM %EFFORT{:}")
    ;; ----------------------------------------------------------------
    ;; Logging & archiving
    ;; ----------------------------------------------------------------
    (org-log-repeat 'time)                      ; time-stamp repeated tasks
    (org-closed-keep-when-no-todo t)
    (org-archive-location "%s_archive::datetree/")
    ;; ----------------------------------------------------------------
    ;; Refile / capture
    ;; ----------------------------------------------------------------
    (org-refile-use-cache nil)
    (org-refile-targets '((org-agenda-files . (:maxlevel . 6))))
    (org-refile-use-outline-path 'file)
    (org-outline-path-complete-in-steps nil)
    (org-refile-allow-creating-parent-nodes 'confirm)
    (org-goto-auto-isearch nil)
    (org-goto-interface 'outline-path-completion)
    ;; ----------------------------------------------------------------
    ;; Tags & links
    ;; ----------------------------------------------------------------
    (org-use-fast-tag-selection t)
    (org-fast-tag-selection-single-key t)
    (org-id-link-to-org-use-id 'create-if-interactive-and-no-custom-id)
    :config
    ;; ================================================================
    ;; Org-mode Enhanced Emphasis & Subscript/Superscript Support
    ;; ================================================================
    ;; Support for Chinese characters and improved emphasis parsing
    ;; ================================================================
    (with-eval-after-load 'org
      ;; -------------------- Custom Emphasis Parsing --------------------
      (defun my/org-element--parse-generic-emphasis (mark type)
        "Parse emphasis object at point with better Unicode support.
  MARK is the delimiter string (e.g., \"*\", \"/\", \"_\").
  TYPE is a symbol: `bold', `code', `italic', `strike-through',
  `underline', or `verbatim'.
  This override adds support for:
  - Chinese and other non-ASCII characters
  - Better boundary detection
  - Improved whitespace handling"
        (save-excursion
          (let ((origin (point)))
            (unless (bolp) (forward-char -1))
            (let ((opening-re
                   (rx-to-string
                    `(seq (or line-start
                              (any space ?- ?\( ?' ?\" ?\{ nonascii))
                          ,mark
                          (not space)))))
              (when (looking-at opening-re)
                (goto-char (1+ origin))
                (let ((closing-re
                       (rx-to-string
                        `(seq (not space)
                              (group ,mark)
                              (or (any space ?- ?. ?, ?\; ?: ?! ?? ?' ?\"
                                       ?\) ?\} ?\\ ?\[ nonascii)
                                  line-end)))))
                  (when (re-search-forward closing-re nil t)
                    (let* ((closing (match-end 1))
                           (post-blank (progn
                                         (goto-char closing)
                                         (skip-chars-forward " \t")))
                           (contents-begin (1+ origin))
                           (contents-end (1- closing)))
                      (list type
                            (append
                             (list :begin origin
                                   :end (point)
                                   :post-blank post-blank)
                             (if (memq type '(code verbatim))
                                 (list :value
                                   (buffer-substring contents-begin
                                                     contents-end))
                               (list :contents-begin contents-begin
                                     :contents-end contents-end))))))))))))
      ;; -------------------- Enhanced Emphasis Faces --------------------
      (defun my/org-do-emphasis-faces (limit)
        "Apply emphasis faces with improved Unicode and Chinese support.
  This function runs through the buffer up to LIMIT and applies
  appropriate faces to emphasized text."
        (let ((quick-re (format "\\([%s]\\|^\\)\\([~=*/_+]\\)"
                                (car org-emphasis-regexp-components))))
          (catch :exit
            (while (re-search-forward quick-re limit t)
              (let* ((marker (match-string 2))
                     (verbatim? (member marker '("~" "="))))
                (when (save-excursion
                        (goto-char (match-beginning 0))
                        (and
                         ;; Prevent recursive emphasis
                         (not (save-excursion
                                (forward-char 1)
                                (get-pos-property (point) 'org-emphasis)))
                         ;; Skip LaTeX fragments
                         (not (org-inside-LaTeX-fragment-p))
                         ;; Skip property drawers
                         (not (org-match-line
                               "^[    ]*:\\(\\(?:\\w\\|[-_]\\)+\\):[      ]*"))
                         ;; Skip table hlines with '+'
                         (not (and (equal marker "+")
                                   (org-match-line
                                    "[ \t]*\\(|[-+]+|?\\|\\+[-+]+\\+\\)[ \t]*$")))
                         ;; Skip headline stars
                         (not (and (equal marker "*")
                                   (save-excursion
                                     (forward-char)
                                     (skip-chars-backward "*")
                                     (looking-at-p org-outline-regexp-bol))))
                         ;; Match full emphasis regexp
                         (looking-at (if verbatim?
                                         org-verbatim-re
                                       org-emph-re))
                         ;; Don't span paragraphs
                         (not (string-match-p org-element-paragraph-separate
                                              (match-string 2)))
                         ;; Don't span table cells
                         (not (and (save-match-data (org-match-line "[ \t]*|"))
                                   (string-match-p "|" (match-string 4))))))
                  (pcase-let ((`(,_ ,face ,_) (assoc marker org-emphasis-alist))
                              (m (if org-hide-emphasis-markers 4 2)))
                    ;; Apply face
                    (font-lock-prepend-text-property
                     (match-beginning m) (match-end m) 'face face)
                    ;; Handle verbatim text specially
                    (when verbatim?
                      (org-remove-flyspell-overlays-in
                       (match-beginning 0) (match-end 0))
                      ;; Handle folding if available
                      (when (and (org-fold-core-folding-spec-p 'org-link)
                                 (org-fold-core-folding-spec-p 'org-link-description))
                        (org-fold-region (match-beginning 0) (match-end 0)
                                         nil 'org-link)
                        (org-fold-region (match-beginning 0) (match-end 0)
                                         nil 'org-link-description))
                      (remove-text-properties
                       (match-beginning 2) (match-end 2)
                       '(display t invisible t intangible t)))
                    ;; Mark as emphasis for future checks
                    (add-text-properties
                     (match-beginning 2) (match-end 2)
                     '(font-lock-multiline t org-emphasis t))
                    ;; Hide markers if configured
                    (when (and org-hide-emphasis-markers
                               (not (org-at-comment-p)))
                      (add-text-properties
                       (match-end 4) (match-beginning 5)
                       '(invisible t))
                      (add-text-properties
                       (match-beginning 3) (match-end 3)
                       '(invisible t)))
                    (throw :exit t))))))))

      ;; -------------------- Configuration --------------------
      ;; Enhanced emphasis regexp for Unicode support
      (setq org-emphasis-regexp-components
            '("-[:space:]('\"{[:nonascii:]"           ; Pre chars
              "-[:space:].,:!?;'\")}\\[[:nonascii:]"  ; Post chars
              "[:space:]"                              ; Forbidden border
              "."                                      ; Body regexp
              1))                                      ; Max newlines
      ;; Enhanced subscript/superscript matching for alphanumeric + Greek
      (setq org-match-substring-regexp
            (concat
             "\\([0-9a-zA-Zα-γΑ-Ω]\\)"  ; Base character (includes Greek)
             "\\([_^]\\)"                ; Sub/superscript marker
             "\\("
             ;; Braced expression: {content}
             "\\(?:" (org-create-multibrace-regexp "{" "}"
                                                   org-match-sexp-depth) "\\)"
             "\\|"
             ;; Parenthesized expression: (content)
             "\\(?:" (org-create-multibrace-regexp "(" ")"
                                                   org-match-sexp-depth) "\\)"
             "\\|"
             ;; Simple expression: number, word, or symbol
             "\\(?:\\*\\|[+-]?[[:alnum:].,\\]*[[:alnum:]]\\)"
             "\\)"))
      ;; -------------------- Apply Configuration --------------------
      ;; Update emphasis regex
      (org-set-emph-re 'org-emphasis-regexp-components
                       org-emphasis-regexp-components)
      ;; Update syntax parser
      (org-element-update-syntax)
      ;; Install advice
      (advice-add #'org-do-emphasis-faces
                  :override #'my/org-do-emphasis-faces)
      (advice-add #'org-element--parse-generic-emphasis
                  :override #'my/org-element--parse-generic-emphasis)
      ;; -------------------- Cleanup on Unload --------------------
      (defun my/org-emphasis-unload ()
        "Remove custom emphasis advice."
        (advice-remove #'org-do-emphasis-faces
                       #'my/org-do-emphasis-faces)
        (advice-remove #'org-element--parse-generic-emphasis
                       #'my/org-element--parse-generic-emphasis))
      (add-hook 'kill-emacs-hook #'my/org-emphasis-unload))
    ;; ================================================================
    ;; Org-mode Image Handling: Clipboard to Disk with Caption
    ;; ================================================================
    ;; Enable image yanking to save as files
    (setq org-yank-image-save-method "file")

    ;; -------------------- Path Generator --------------------
    (defun my/org-yank-image-file-name ()
      "Generate organized figure path under current heading.
  Creates: Figure/heading-name/YYYYMMDD_HHMMSS.png"
      (unless (buffer-file-name)
        (user-error "Buffer must be saved before inserting images"))

      (let* ((heading (or (org-get-heading t t t t) "default"))
             (clean-heading (replace-regexp-in-string
                             "[^a-zA-Z0-9\u4e00-\u9fa5-]+" "_" heading))
             (time-stamp (format-time-string "%Y%m%d_%H%M%S"))
             (fig-dir (expand-file-name
                       (concat "Figure/" clean-heading "/")
                       (file-name-directory (buffer-file-name))))
             (full-path (expand-file-name (concat time-stamp ".png") fig-dir)))

        (make-directory fig-dir t)
        full-path))

    (setq org-yank-image-file-name-function #'my/org-yank-image-file-name)

    ;; -------------------- Caption Insertion --------------------
    (defun my/org-add-image-caption ()
      "Add #+CAPTION: above the last inserted image link."
      (when (eq major-mode 'org-mode)
        (save-excursion
          ;; Find the last inserted image link
          (when (re-search-backward
                 "^\\[\\[file:\\([^]]+\\.png\\)\\]\\]$"
                 (line-beginning-position 0) t)
            (let* ((file-path (match-string 1))
                   (file-name (file-name-nondirectory file-path))
                   (default-caption (file-name-sans-extension file-name))
                   (caption (read-string
                             (format "Caption (default: %s): " default-caption)
                             nil nil default-caption)))

              (unless (string-empty-p caption)
                ;; Insert caption above the image link
                (goto-char (line-beginning-position))
                (insert (format "#+CAPTION: %s\n" caption))
                (message "✓ Caption added: %s" caption)))))))

    ;; -------------------- Hook Integration --------------------
    (defun my/yank-image-with-caption (&rest _)
      "Wrapper to add caption after image insertion in org-mode."
      (when (eq major-mode 'org-mode)
        (run-with-idle-timer 0.1 nil #'my/org-add-image-caption)))

    (advice-add 'yank-media :after #'my/yank-image-with-caption)
    ;; ----------------------------------------------------------------
    ;; LaTeX & expand-region tweaks
    ;; ----------------------------------------------------------------
    (defun my/add-latex-in-org-mode-expansions ()
      "Extra expand-region selectors for LaTeX fragments."
      (modify-syntax-entry ?\\ "\\" org-mode-syntax-table)
      (setq paragraph-start (concat paragraph-start "\\|\\\\end{[A-Za-z0-9*]+}"))
      (setq-local beginning-of-defun-function #'my/org-beginning-of-defun)
      (with-eval-after-load 'expand-region
        (setq-local my/try-expand-list
                    (append (cl-set-difference my/try-expand-list
                                               '(my/mark-method-call
                                                 my/mark-inside-pairs
                                                 my/mark-outside-pairs))
                            '(LaTeX-mark-environment
                              my/mark-LaTeX-inside-math
                              my/mark-latex-inside-pairs
                              my/mark-latex-outside-pairs
                              my/mark-LaTeX-math))))))
  (use-package org-modern
    :ensure t
    :hook
    ((org-mode . org-modern-mode)
     (org-agenda-finalize . org-modern-agenda))
    :custom
    (org-tags-column 0)
    (org-special-ctrl-a/e t)
    (org-insert-heading-respect-content t)
    (org-modern-keyword t)
    (org-modern-table-horizontal 0.2)
    (org-modern-tag t)
    (org-modern-timestamp nil)
    (org-modern-table t)
    (org-modern-priority t)
    (custom-set-faces
     '(org-modern-symbol ((t (:height 1.0 :foreground "#81A1C1"))))
     '(org-modern-tag ((t (:background "#3B4252" :foreground "#ECEFF4"
                           :height 1.0 :weight regular :box nil))))
     '(org-modern-priority ((t (:height 1.0 :inherit org-priority))))
     '(org-modern-date-active ((t (:background "#434C5E" :foreground "#88C0D0"
                                   :height 1.0 :box nil))))
     '(org-modern-date-inactive ((t (:background "#3B4252" :foreground "#4C566A"
                                     :height 1.0 :box nil))))
     '(org-modern-time-active ((t (:inherit org-modern-date-active))))
     '(org-modern-time-inactive ((t (:inherit org-modern-date-inactive)))))
    ;; 行间距优化
    (defun my/org-modern-spacing ()
      (setq-local line-spacing 0.15))
    (add-hook 'org-modern-mode-hook #'my/org-modern-spacing)
    :config
    (setq
     ;; 标题星号 - 渐进式圆形
     org-modern-star '("◉" "○" "◈" "◇" "⬡" "⬢")
     ;; 列表符号 - 统一箭头系
     org-modern-list '((43 . "▶")   ;; + 实心三角
                       (45 . "▸")   ;; - 空心三角
                       (42 . "•"))  ;; * 圆点
     ;; 复选框 - 统一方形
     org-modern-checkbox
     '((88 . "☑")   ;; [X] 完成
       (45 . "◫")   ;; [-] 进行中
       (32 . "☐"))  ;; [ ] 未完成
     ;; LaTeX 片段 - 数学符号
     org-modern-latex
     '((t . t)
       ("\$" "⁅" "⁆")
       ("\$$" "⟦" "⟧"))))
#+end_src
*** Denote 笔记系统
#+begin_src emacs-lisp
  (use-package denote
    :ensure t
    :defer t
    :custom
    (denote-file-type 'org)
    (denote-directory my/denote-root)
    (denote-signature-prompt nil)
    (denote-known-keywords
     '("literature" "research" "thesis"
       "project" "work" "meeting" "report"
       "journal" "idea" "reading" "personal"
       "todo" "draft" "archive"))
    (denote-infer-keywords t)
    (denote-sort-keywords t)
    (denote-prompts '(title keywords template))
    (denote-save-buffers nil)
    (denote-rename-confirmations '(rewrite-front-matter modify-file-name))
    (denote-link-fontify t)
    (denote-date-prompt-use-org-read-date t)
    (denote-date-format "%Y-%m-%d %a")
    :hook ((org-mode . denote-fontify-links-mode-maybe)
           (dired-mode . denote-dired-mode-in-directories))
    :bind (("C-c n n" . denote)
           ("C-c n R" . denote-rename-file)
           ("C-c n r" . denote-rename-file-keywords)
           ("C-c n d" . denote-dired-rename-files)
           ("C-c n b" . denote-backlinks)
           ("C-c n a" . denote-add-links)
           :map dired-mode-map
           ("C-c C-d C-r" . denote-dired-rename-files)
           ("C-c C-d C-i" . denote-dired-link-marked-notes))
    :config
    (denote-rename-buffer-mode 1)
    (setq denote-templates
          `((报告 . "* 摘要\n\n* 引言\n\n* 主体\n** 方法\n** 结果\n\n* 结论\n\n* 参考文献\n\n")
            (日记 . ,(concat "* 今日总结"
                             "\n\n"
                             "* 待办事项"
                             "\n** 已完成"
                             "\n** 未完成"
                             "\n\n"
                             "* 思考与感悟"
                             "\n\n"))
            (新闻联播 . ,(concat "* 重点新闻"
                                 "\n\n"
                                 "* 高频主题"
                                 "\n\n"
                                 "* 关键数据"
                                 "\n\n"))
            (文献 . ,(concat "* 文献信息"
                             "\n** 期刊/会议"
                             "\n\n"
                             "* 主要内容"
                             "\n\n"
                             "* 关键观点"
                             "\n\n"
                             "* 逻辑过程"
                             "\n\n"
                             "* 本文发现"
                             "\n\n"
                             "* 使用的方法"
                             "\n\n"
                             "* 使用的数据"
                             "\n\n"
                             "* 机制分析"
                             "\n\n"))
            (草稿 . ,(concat "* 大纲"
                             "\n\n"
                             "** 理论逻辑"
                             "\n\n"
                             "** 数据"
                             "\n\n"
                             "** 假设"
                             "\n\n"
                             "** 模型"
                             "\n\n"
                             "* 初稿"
                             "\n\n"
                             "* 修改记录"
                             "\n\n")))))
  (use-package consult-denote
    :ensure t
    :after (consult denote)
    :bind (("C-c n f" . consult-denote-find)
           ("C-c n l" . consult-denote-link)
           ("C-c n g" . consult-denote-grep))
    :config
    (setq consult-denote-grep-command #'consult-ripgrep
          denote-consult-directory denote-directory))
#+end_src
*** Org Habit
#+begin_src emacs-lisp
  (with-eval-after-load 'org-agenda
    (require 'org-habit)
    ;; 习惯图表显示列数
    (setq org-habit-graph-column 60)
    ;; 显示过去的天数
    (setq org-habit-preceding-days 21)
    ;; 显示未来的天数
    (setq org-habit-following-days 7)
    ;; 是否只显示今天的习惯
    (setq org-habit-show-habits-only-for-today nil)
    ;; 已完成但未到下次计划的习惯显示为绿色
    (setq org-habit-show-done-always-green t))
#+end_src
*** Org Agenda
#+begin_src emacs-lisp
  ;; ------------------------------------------------------------------
  ;; Fast, cached, auto-discovery of agenda files
  ;; ------------------------------------------------------------------
  (defvar my/org-agenda-files-cache nil
    "Cached list of all Org files under `my/org-agenda-root'.")

  (defvar my/org-agenda-files-last-check 0
    "Epoch seconds of last cache build.")

  (defconst my/org-agenda-cache-timeout 300
    "Seconds before cache is considered stale (5 min).")

  (defun my/org-auto-collect-agenda-files (&optional force-refresh)
    "Return every *.org file under predefined directories.
  Rebuilds list if FORCE-REFRESH is non-nil or cache is older than
  `my/org-agenda-cache-timeout'."
    (let ((now (float-time)))
      (when (or force-refresh
                (null my/org-agenda-files-cache)
                (> (- now my/org-agenda-files-last-check)
                   my/org-agenda-cache-timeout))
        (setq my/org-agenda-files-cache
              (delete-dups
               (append
                (when (file-directory-p my/org-projects-dir)
                  (directory-files-recursively my/org-projects-dir "\\.org\\'"))
                (when (file-directory-p my/org-work-dir)
                  (directory-files-recursively my/org-work-dir "\\.org\\'"))
                (when (file-directory-p my/org-personal-dir)
                  (directory-files-recursively my/org-personal-dir "\\.org\\'"))
                (let ((inbox (expand-file-name "inbox.org" my/org-agenda-root)))
                  (when (file-exists-p inbox) (list inbox))))))
        (setq my/org-agenda-files-last-check now))
      my/org-agenda-files-cache))

  ;; ------------------------------------------------------------------
  ;; Delayed agenda loading – files are discovered only when needed
  ;; ------------------------------------------------------------------
  (with-eval-after-load 'org-agenda
    ;; Start with empty list so startup is instant
    (setq org-agenda-files nil)
    (defun my/org-agenda-prepare (&rest _)
      "Populate `org-agenda-files' on first agenda call."
      (unless org-agenda-files
        (setq org-agenda-files (my/org-auto-collect-agenda-files))))
    (advice-add 'org-agenda :before #'my/org-agenda-prepare)

    ;; ----------------------------------------------------------------
    ;; Visual settings (unchanged)
    ;; ----------------------------------------------------------------
    (setq org-agenda-span 'week
          org-agenda-start-day nil
          org-agenda-window-setup 'current-window
          org-agenda-include-deadlines t
          org-agenda-show-all-dates nil
          org-agenda-block-separator ?─

          org-agenda-time-grid
          '((daily today require-timed)
            (800 1000 1200 1400 1600 1800 2000)
            " ┄┄┄┄┄ " "┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄")

          org-agenda-current-time-string
          "⭠ now ─────────────────────────────────────────────────"

          org-agenda-prefix-format
          '((agenda . " %i %-12:c %t")
            (todo   . " %i %-12:c")
            (tags   . " %i %-12:c")
            (search . " %i %-12:c"))

          org-agenda-sorting-strategy
          '((agenda time-up priority-down category-keep)
            (todo   priority-down category-keep)
            (tags   priority-down category-keep)
            (search category-keep))))

#+end_src
*** Org Capture
#+begin_src emacs-lisp
  ;; ------------------------------------------------------------------
  ;; Org-capture – fast, templated note / task entry
  ;; ------------------------------------------------------------------

  (defvar my/org-capture-files
    '(("inbox" . "inbox.org")
      ("ideas" . "ideas.org")
      ("notes" . "notes.org"))
    "File names used by capture templates.")

  (defun my/create-org-capture-file (name)
    "Create NAME.org under `my/org-agenda-root' if it does not exist.
  Return absolute path."
    (let ((file (expand-file-name name my/org-agenda-root)))
      (unless (file-exists-p file)
        (with-temp-file file
          (insert (format "#+TITLE: %s\n#+CREATED: %s\n\n"
                          (file-name-sans-extension name)
                          (format-time-string "%Y-%m-%d %a %H:%M"))))
        (message "Created capture file: %s"
                 (file-relative-name file my/org-agenda-root)))
      file))

  (defun my/ensure-capture-files ()
    "Create missing capture files."
    (dolist (pair my/org-capture-files)
      (my/create-org-capture-file (cdr pair))))

  ;; Pre-create files so templates never fail
  (with-eval-after-load 'org-capture
    (my/ensure-capture-files))

  (defun my/get-capture-file (key)
    "Return absolute path for KEY (inbox | ideas | notes)."
    (when-let* ((name (alist-get key my/org-capture-files nil nil #'string=)))
      (expand-file-name name my/org-agenda-root)))

  (defun my/org-capture-setup ()
    "Minor tweaks for capture buffer."
    (setq-local org-complete-tags-always-offer-all-agenda-tags t)
    (visual-line-mode -1)            ; hard newlines in template
    (auto-fill-mode -1))

  (defun my/org-capture-selection-or-block ()
    "Return selected region (if any) wrapped in appropriate block."
    (with-current-buffer (org-capture-get :original-buffer)
      (let ((content (plist-get org-store-link-plist :initial))
            (src-mode (replace-regexp-in-string "-mode$" "" (symbol-name major-mode)))
            (is-code (derived-mode-p 'prog-mode)))
        (cond
         ((null content) "")
         (is-code (format "\n#+begin_src %s\n%s\n#+end_src\n" src-mode content))
         (t         (format "\n#+begin_quote\n%s\n#+end_quote\n" content))))))

  (defun my/org-capture-link-format ()
    "Return formatted link / annotation line."
    (with-current-buffer (org-capture-get :original-buffer)
      (let ((annotation (plist-get org-store-link-plist :annotation))
            (file       (buffer-file-name)))
        (cond
         ((null annotation) "")
         ((eq major-mode 'org-mode)
          ;; strip link brackets, keep description only
          (string-trim (replace-regexp-in-string "\\[\\[\\(?:[^]]+::\\)?\\([^]]+\\)\\]\\[.*?\\]\\]"
                                                 "- reference :: \\1"
                                                 annotation)))
         (file
          (format "- reference :: %s [[%s]]" annotation (file-name-nondirectory file)))
         (t
          (format "- reference :: %s" annotation))))))

  (use-package org-capture
    :bind ("C-c c" . org-capture)
    :hook (org-capture-mode . my/org-capture-setup)
    :config
    (setq org-capture-templates
          `(("t" "Todo")
            ("tt" "Todo" entry (file ,(my/get-capture-file "inbox"))
             "* TODO %?\n  %U\n  %i\n"
             :empty-lines 1)
            ("th" "Daily Habit" entry (file ,(my/get-capture-file "inbox"))
             "* TODO %^{习惯名称}\nSCHEDULED: <%<%Y-%m-%d %a +1d>>\n  :PROPERTIES:\n  :STYLE: habit\n  :CREATED: %U\n  :END:\n"
             :empty-lines 1
             :prepend t)
            ("n" "Notes" entry (file+headline ,(my/get-capture-file "notes") "Notes")
             "* %?\n%(my/org-capture-link-format)\n%U"
             :prepend t
             :empty-lines 1)
            ("i" "Idea" entry (file+headline ,(my/get-capture-file "ideas") "Ideas")
             "* %^{Title}\n%?\n%(my/org-capture-link-format)\n%U"
             :prepend t
             :empty-lines 1)))

    ;; Auto-refresh agenda after capture
    (defun my/org-capture-refresh-agenda (&rest _)
      "Redraw agenda if it is visible."
      (when-let* ((buf (get-buffer "*Org Agenda*")))
        (with-current-buffer buf
          (org-agenda-redo))))
    (advice-add 'org-capture-finalize :after #'my/org-capture-refresh-agenda))
#+end_src
*** Org Modern
#+begin_src emacs-lisp
  (use-package org-appear
    :ensure t
    :hook (org-mode . org-appear-mode)
    :config
    (setq org-appear-autolinks t)
    (setq org-appear-autosubmarkers t)
    (setq org-appear-autoentities t)
    (setq org-appear-autokeywords t)
    (setq org-appear-inside-latex t))
  (use-package org-faces
    :ensure nil
    :after org
    :custom-face
    (org-level-1 ((t (:height 1.3 :weight bold))))
    (org-level-2 ((t (:height 1.2 :weight semi-bold))))
    (org-level-3 ((t (:height 1.1 :weight normal))))
    (org-document-title ((t (:height 1.5 :weight bold :underline t)))))
#+end_src
*** Org Agenda 提醒系统
#+begin_src emacs-lisp
  (use-package appt
    :after org-agenda
    :ensure nil
    :config
    ;; 激活提醒系统
    (appt-activate 1)

    ;; 基础配置
    (setq appt-message-warning-time 15          ; 提前15分钟提醒
          appt-display-interval 5               ; 每5分钟重复提醒
          appt-display-mode-line t              ; 在 mode-line 显示
          appt-display-duration 60              ; 显示60秒
          appt-audible t                        ; 启用声音
          appt-display-diary nil                ; 不显示 diary
          appt-display-format 'window)          ; 使用窗口显示

    ;; 确保变量已初始化
    (unless (boundp 'appt-time-msg-list)
      (setq appt-time-msg-list nil))

    ;; 自定义提醒显示函数
    (defun my/appt-display (min-to-app new-time msg)
      "增强的提醒显示函数，支持多种通知方式。
  MIN-TO-APP: 距离约会的分钟数
  NEW-TIME: 约会时间
  MSG: 提醒消息"
      (let* ((min-num (string-to-number min-to-app))
             (urgency (cond ((< min-num 5) "🔴 紧急")
                            ((< min-num 10) "🟡 重要")
                            (t "🟢 提醒")))
             (title (format "%s - %s分钟后" urgency min-to-app))
             (formatted-msg (format "[%s] %s" new-time msg)))

        ;; 显示在 Emacs 窗口
        (appt-disp-window min-to-app new-time msg)

        ;; 在 minibuffer 显示
        (message "📅 %s: %s" title formatted-msg)

        ;; 使用 alert 包发送通知
        (when (and (featurep 'alert) (fboundp 'alert))
          (alert formatted-msg
                 :title title
                 :severity (cond ((< min-num 5) 'urgent)
                                 ((< min-num 10) 'high)
                                 (t 'moderate))
                 :category 'org-agenda
                 :id 'org-appt))))

    (setq appt-disp-window-function #'my/appt-display)

    ;; 从 Org Agenda 加载约会
    (defun my/org-agenda-to-appt (&optional force)
      "从 Org Agenda 文件中提取所有约会。
   如果 FORCE 为非 nil，则强制重新加载，否则只在列表为空时加载。"
      (interactive "P")
      (condition-case err
          (let ((count-before (length appt-time-msg-list)))
            (when (or force (null appt-time-msg-list))
              (setq appt-time-msg-list nil)
              (org-agenda-to-appt t))
            (let ((count-after (length appt-time-msg-list)))
              (message "约会提醒已更新: %d 个事项 %s"
                       count-after
                       (if (> count-after count-before)
                           (format "(新增 %d)" (- count-after count-before))
                         ""))))
        (error
         (message "加载约会提醒时出错: %s" (error-message-string err))
         nil)))

    ;; 定时更新（每小时）
    (run-at-time "00:00" 3600 #'my/org-agenda-to-appt)

    ;; 启动时延迟5秒加载
    (run-at-time "5 sec" nil #'my/org-agenda-to-appt)

    ;; 各种钩子自动更新
    (add-hook 'org-finalize-agenda-hook #'my/org-agenda-to-appt)
    (add-hook 'org-after-todo-state-change-hook
              (lambda () (my/org-agenda-to-appt t)))
    (add-hook 'org-after-tags-change-hook
              (lambda () (my/org-agenda-to-appt t)))

    ;; 保存 org 文件时更新
    (add-hook 'org-mode-hook
              (lambda ()
                (add-hook 'after-save-hook
                          (lambda () (my/org-agenda-to-appt t))
                          nil 'local))))
#+end_src
*** Org导出
#+BEGIN_SRC emacs-lisp
  ;; 导出 HTML 时自动追加 org.css
  (with-eval-after-load 'ox-html
    (setq org-html-head-extra
          (format "<link rel=\"stylesheet\" type=\"text/css\" href=\"%s\"/>"
                  (expand-file-name "org.css" user-emacs-directory))))
  (with-eval-after-load 'ox-latex
    (setq org-latex-pdf-process '("latexmk -xelatex -quiet -shell-escape -f %f"))
    (push '(
            "\\documentclass[lang=cn]{article}
                   [NO-DEFAULT-PACKAGES]
                   [PACKAGES]
                   [EXTRA]"
            ("\\section{%s}" . "\\section*{%s}")
            ("\\subsection{%s}" . "\\subsection*{%s}")
            ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
            ("\\paragraph{%s}" . "\\paragraph*{%s}")
            ("\\subparagraph{%s}" . "\\subparagraph*{%s}"))
          org-latex-classes))
#+end_src

#+RESULTS:
| \documentclass[lang=cn]{article} |

*** Org引用配置
#+begin_src emacs-lisp
  (use-package oc
    :ensure nil
    :after org
    :custom
    (org-cite-global-bibliography my/bibliography-files)
    (org-cite-insert-processor 'basic)
    (org-cite-activate-processor 'basic)
    (org-cite-follow-processor 'basic)
    (org-cite-export-processors
     '((latex biblatex)
       (html csl)
       (t basic)))
    :config
    (setq org-cite-csl-styles-dir
          (expand-file-name "csl-styles/" my/bibliography-directory))
    (unless (file-directory-p org-cite-csl-styles-dir)
      (make-directory org-cite-csl-styles-dir t)
      (message "请从 https://www.zotero.org/styles 下载 CSL 样式文件到: %s"
               org-cite-csl-styles-dir)))
#+end_src
*** Org-babel配置文件
#+begin_src emacs-lisp
  (use-package org-src
    :ensure nil
    :after org
    :custom
    (org-src-window-setup 'current-window)
    (org-src-fontify-natively t)
    (org-src-tab-acts-natively t)
    (org-confirm-babel-evaluate nil)
    (org-src-preserve-indentation t)
    (org-edit-src-content-indentation 0)
    :bind (:map org-mode-map
           ("C-c C-v C-e" . org-babel-execute-src-block)
           ("C-c C-v C-b" . org-babel-execute-buffer)
           ("C-c '" . org-edit-special)  ;; 进入 org-src-mode
           :map org-src-mode-map
           ("C-c '" . org-edit-src-exit)  ;; 退出 org-src-mode
           ("C-c C-k" . org-edit-src-abort))
    :custom-face
    ;; 代码块使用等宽字体
    (org-block ((t (:inherit fixed-pitch :background "#2e3440"))))
    (org-block-begin-line ((t (:inherit fixed-pitch :foreground "#616e88"
                               :background "#2e3440" :extend t))))
    (org-block-end-line ((t (:inherit org-block-begin-line))))
    (with-eval-after-load 'org
      (org-babel-do-load-languages
       'org-babel-load-languages
       '((R . t)
         (C . t))))
    (setq org-src-fontify-natively t                ; Fontify code in code blocks.
          org-adapt-indentation nil                 ; Adaptive indentation
          org-src-tab-acts-natively t               ; Tab acts as in source editing
          org-confirm-babel-evaluate nil            ; No confirmation before executing code
          org-edit-src-content-indentation 0        ; No relative indentation for code blocks
          org-fontify-whole-block-delimiter-line t)) ; Fontify whole block
#+end_src
*** Markdown
#+BEGIN_SRC emacs-lisp
  (use-package markdown-mode
    :ensure t
    :defer t
    :mode (("README\\.md\\'" . gfm-mode)
           ("\\.md\\'" . markdown-mode)
           ("\\.markdown\\'" . markdown-mode))
    :hook ((markdown-mode . visual-line-mode)
           (markdown-mode . display-fill-column-indicator-mode))
    :custom
    (markdown-command "pandoc")
    (markdown-fontify-code-blocks-natively t)
    (markdown-enable-math t)
    (markdown-header-scaling t)
    (markdown-header-scaling-values '(1.3 1.2 1.1 1.0 1.0 1.0))
    :custom-face
    (markdown-header-face-1 ((t (:height 1.3 :weight bold))))
    (markdown-header-face-2 ((t (:height 1.2 :weight bold))))
    (markdown-code-face ((t (:background "#2e3440")))))
  (use-package markdown-toc
    :ensure t
    :hook (markdown-mode . markdown-toc-mode)
    :defer t
    :after markdown-mode
    :bind (:map markdown-mode-map
           ("C-c C-t" . markdown-toc-generate-or-refresh-toc))
    :custom
    (markdown-toc-header-toc-title "## 目录"))
#+end_src

** 编程语言
*** R配置文件
#+BEGIN_SRC emacs-lisp
  ;;; ESS - R 语言支持
  (use-package ess
    :ensure t
    :defer t
    :mode (("\\.R\\'" . R-mode)
           ("\\.r\\'" . R-mode))
    :init
    ;; 性能优化配置
    (setq ess-use-flymake t
          ess-use-eldoc 'script-only
          ess-eldoc-show-on-symbol t
          ess-startup-directory 'default-directory
          ess-ask-for-ess-directory nil
          ess-indent-offset 2
          ess-style 'RStudio
          ess-offset-continued 2
          ess-expression-offset 2
          ess-nuke-trailing-whitespace-p t
          ess-default-style 'RStudio
          inferior-R-args "--no-save --no-restore")
    :hook
    (inferior-ess-r-mode . (lambda ()
                             (setq-local comint-scroll-to-bottom-on-input t
                                         comint-scroll-to-bottom-on-output t
                                         comint-move-point-for-output t)))
    :config
    ;; 简化字体锁定
    (setq ess-R-font-lock-keywords
          '((ess-R-fl-keyword:keywords . t)
            (ess-R-fl-keyword:constants . t)
            (ess-fl-keyword:fun-calls . t)
            (ess-fl-keyword:numbers . t)))
    ;; Eglot 集成
    (with-eval-after-load 'eglot
      (add-to-list 'eglot-server-programs
                   '((R-mode ess-r-mode) "R" "--no-echo" "-e" "languageserver::run()")))
    ;; 智能进程清理
    (defvar my/ess-cleanup-timer nil)
    (defun my/ess-cleanup-old-processes ()
      (dolist (proc (process-list))
        (when (and (string-match-p "^R:" (process-name proc))
                   (let ((last-activity (process-get proc 'last-activity)))
                     (and last-activity
                          (> (float-time (time-since last-activity)) 3600))))
          (delete-process proc))))
    (add-hook 'inferior-ess-mode-hook
              (lambda ()
                (unless my/ess-cleanup-timer
                  (setq my/ess-cleanup-timer
                        (run-with-idle-timer 1800 t #'my/ess-cleanup-old-processes))))))
#+end_src
*** Elisp配置
#+BEGIN_SRC emacs-lisp
  (use-package elisp-mode
    :ensure nil
    :bind (:map emacs-lisp-mode-map
           ("C-c C-x" . ielm)
           ("C-c C-c" . eval-defun)
           ("C-c C-b" . eval-buffer))
    :config
    (defun my/lisp-indent-function (indent-point state)
      "改进的 Lisp 缩进函数"
      (let ((normal-indent (current-column))
            (orig-point (point)))
        (goto-char (1+ (elt state 1)))
        (parse-partial-sexp (point) calculate-lisp-indent-last-sexp 0 t)
        (cond
         ((and (elt state 2)
               (or (not (looking-at "\\sw\\|\\s_"))
                   (looking-at ":")))
          (unless (> (save-excursion (forward-line 1) (point))
                     calculate-lisp-indent-last-sexp)
            (goto-char calculate-lisp-indent-last-sexp)
            (beginning-of-line)
            (parse-partial-sexp (point) calculate-lisp-indent-last-sexp 0 t))
          (backward-prefix-chars)
          (current-column))
         ((and (save-excursion
                 (goto-char indent-point)
                 (skip-syntax-forward " ")
                 (not (looking-at ":")))
               (save-excursion
                 (goto-char orig-point)
                 (looking-at ":")))
          (save-excursion
            (goto-char (+ 2 (elt state 1)))
            (current-column)))
         (t
          (let* ((function (buffer-substring (point)
                                             (progn (forward-sexp 1) (point))))
                 (method (or (function-get (intern-soft function)
                                           'lisp-indent-function)
                             (get (intern-soft function) 'lisp-indent-hook))))
            (cond ((or (eq method 'defun)
                       (and (null method)
                            (length> function 3)
                            (string-match "\\`def" function)))
                   (lisp-indent-defform state indent-point))
                  ((integerp method)
                   (lisp-indent-specform method state indent-point normal-indent))
                  (method
                   (funcall method indent-point state))))))))

    (add-hook 'emacs-lisp-mode-hook
              (lambda () (setq-local lisp-indent-function #'my/lisp-indent-function)))

    (add-hook 'help-mode-hook #'cursor-sensor-mode)

    (defun function-advices (function)
      "返回 FUNCTION 的所有 advice"
      (let ((flist (indirect-function function)) advices)
        (while (advice--p flist)
          (push (advice--car flist) advices)
          (setq flist (advice--cdr flist)))
        (nreverse advices)))

    (defun add-remove-advice-button (advice function)
      "为 ADVICE 添加移除按钮"
      (when (and (functionp advice) (functionp function))
        (let ((inhibit-read-only t)
              (msg (format "Remove advice `%s'" advice)))
          (insert "\t")
          (insert-button
           "Remove"
           'face 'custom-button
           'cursor-sensor-functions `((lambda (&rest _) (message ,msg)))
           'help-echo msg
           'action (lambda (_)
                     (when (yes-or-no-p msg)
                       (message "%s from function `%s'" msg function)
                       (advice-remove function advice)
                       (if (eq major-mode 'helpful-mode)
                           (helpful-update)
                         (revert-buffer nil t))))
           'follow-link t))))

    (defun add-button-to-remove-advice (buffer-or-name function)
      "在帮助缓冲区中添加移除 advice 的按钮"
      (with-current-buffer buffer-or-name
        (save-excursion
          (goto-char (point-min))
          (let ((ad-list (function-advices function)))
            (while (re-search-forward
                    "^\$?:This function has \$?:[-a-z]+ advice: \$.+\$$" nil t)
              (when-let* ((advice (pop ad-list)))
                (add-remove-advice-button advice function)))))))

    (define-advice describe-function-1 (:after (function) advice-remove-button)
      (add-button-to-remove-advice (help-buffer) function))

    (with-eval-after-load 'helpful
      (define-advice helpful-update (:after () advice-remove-button)
        (when helpful--callable-p
          (add-button-to-remove-advice (current-buffer) helpful--sym))))

    (defun remove-hook-at-point ()
      "在 *Help* 缓冲区中移除光标处的 hook"
      (interactive)
      (unless (memq major-mode '(help-mode helpful-mode))
        (error "仅适用于 help-mode 或 helpful-mode"))
      (let ((orig-point (point)))
        (save-excursion
          (when-let* ((hook (progn (goto-char (point-min)) (symbol-at-point)))
                      (func (when (and (or (re-search-forward "^Value:?[\s|\n]" nil t)
                                           (goto-char orig-point))
                                       (sexp-at-point))
                              (end-of-sexp)
                              (backward-char 1)
                              (catch 'break
                                (while t
                                  (condition-case nil
                                      (backward-sexp)
                                    (scan-error (throw 'break nil)))
                                  (when-let* ((bounds (bounds-of-thing-at-point 'sexp)))
                                    (when (<= (car bounds) orig-point (cdr bounds))
                                      (throw 'break (sexp-at-point)))))))))
            (when (yes-or-no-p (format "Remove %s from %s? " func hook))
              (remove-hook hook func)
              (if (eq major-mode 'helpful-mode)
                  (helpful-update)
                (revert-buffer nil t))))))))
#+end_src
*** Format-all
#+begin_src emacs-lisp
  (use-package apheleia
    :ensure t
    :diminish
    :config
    (setf (alist-get 'astyle apheleia-formatters)
          '("astyle" "--mode=c" "--suffix=none"))
    ;; BibTeX - 需要添加
    (setf (alist-get 'bibtex-tidy apheleia-formatters)
          '("bibtex-tidy" "--stdin" "--stdout"))
    ;; 配置air
    (setf (alist-get 'air apheleia-formatters)
          '("air" "format" filepath))
    ;; 建立模式与formatter的映射
    ;; 注意：是 LaTeX-mode 不是 latex-mode (首字母大写)
    (setf (alist-get 'LaTeX-mode apheleia-mode-alist) 'latexindent)
    (setf (alist-get 'c-mode apheleia-mode-alist) 'astyle)
    (setf (alist-get 'c++-mode apheleia-mode-alist) 'astyle)
    (setf (alist-get 'ess-r-mode apheleia-mode-alist) 'air)
    ;; BibTeX mode
    (setf (alist-get 'bibtex-mode apheleia-mode-alist) 'bibtex-tidy)
    (add-hook 'org-src-mode-hook #'apheleia-mode)
    ;; 启用全局模式
    (apheleia-global-mode +1))
#+end_src
*** EGLOT-MODE
#+begin_src emacs-lisp
  (use-package eglot
    :hook ((prog-mode . (lambda ()
                          (unless (derived-mode-p
                                   'emacs-lisp-mode 'lisp-mode
                                   'makefile-mode 'snippet-mode
                                   'ron-mode)
                            (eglot-ensure)))))
    :init (setq eglot-autoshutdown t
                eglot-send-changes-idle-time 0.5
                eglot-extend-to-xref t
                eglot-code-action-indications '(eldoc-hint)
                eglot-events-buffer-config '(:size 0 :format full) ;; 取消 eglot log
                eglot-ignored-server-capabilities '(:documentFormattingProvider
                                                    :documentRangeFormattingProvider))
    :bind (:map eglot-mode-map
           ("C-c l r" . eglot-rename)
           ("C-c l a" . eglot-code-actions)))
  ;;; Flymake - 与 EGLOT 配合使用
  (use-package flymake
    :diminish
    :bind ("C-c f" . flymake-show-buffer-diagnostics)
    :hook prog-mode
    :custom
    (flymake-no-changes-timeout nil)
    (flymake-fringe-indicator-position 'right-fringe)
    (flymake-margin-indicator-position 'right-margin))
#+end_src
*** 编程模式通用设置
#+begin_src emacs-lisp
  (use-package project
    :ensure nil                                    ; 内置包
    :defer t                                       ; 按需加载
    :bind (("C-x p f" . project-find-file)        ; 快速找文件
           ("C-x p g" . project-find-regexp)      ; 全文搜索（rg）
           ("C-x p b" . project-switch-to-buffer) ; 仅项目内 buffer
           ("C-x p k" . project-kill-buffers)     ; 一键关闭项目 buffer
           ("C-x p p" . project-switch-project)   ; 最近项目切换
           ("C-x p d" . project-dired)            ; 在项目根打开 dired
           ("C-x p c" . project-compile)          ; 在项目根编译
           ("C-x p e" . project-eshell))          ; 在项目根开 eshell
    :custom
    ;; 用 ripgrep 替代 grep（需先装 rg）
    (project-find-regexp-function (if (executable-find "rg")
                                      #'project-ripgrep
                                    #'project-find-regexp))
    ;; 缓存 50 个最近项目
    (project-list-size 50)
    ;; 把缓存文件集中存放
    (project-list-file (locate-user-emacs-file "etc/project-list.el"))
    ;; 模糊匹配：vertico 用户自动生效，默认 completion 也够用
    (project-completion-system 'default))
  (use-package eldoc
    :after eglot
    :bind
    (:map eglot-mode-map
     ("C-c C-d" . eldoc-doc-buffer))
    :init
    ;; 在屏幕右侧显示 eldoc-buffer
    (add-to-list 'display-buffer-alist
                 '("^\\*eldoc.*\\*"
                   (display-buffer-reuse-window display-buffer-in-side-window)
                   (dedicated . t)
                   (side . right)
                   (inhibit-same-window . t)
                   (window-width . 80)))
    :config
    (setq eldoc-idle-delay 0.1)
    ;; 打开 eldoc-buffer 时关闭 echo-area 显示
    (setq eldoc-echo-area-prefer-doc-buffer t)
    ;; 将 minibuffer 窗口高度设为 1
    (setq max-mini-window-height 1)
    ;; 只单行显示 eldoc 信息
    (setq eldoc-echo-area-use-multiline-p nil))
  (use-package rainbow-delimiters
    :ensure t
    :hook (prog-mode . rainbow-delimiters-mode)
    :config
    (setq rainbow-delimiters-max-face-count 5))
  (use-package prog-mode
    :hook (prog-mode . display-fill-column-indicator-mode)
    :custom
    (setq-local truncate-lines nil)      ; 关闭硬截断
    (setq-local visual-fill-column-width 80)
    (setq-local visual-fill-column-center-text nil)
    (visual-line-mode 1))
  (use-package indent-bars
    :ensure t
    :hook (python-ts-mode . indent-bars-mode))
  (use-package helpful
    :ensure t
    :bind (([remap describe-function] . helpful-callable)
           ([remap describe-command] . helpful-command)
           ([remap describe-variable] . helpful-variable)
           ([remap describe-key] . helpful-key)
           ([remap describe-symbol] . helpful-symbol)
           :map emacs-lisp-mode-map ("C-c C-d" . helpful-at-point)
           :map lisp-interaction-mode-map ("C-c C-d" . helpful-at-point)
           :map helpful-mode-map ("r" . remove-hook-at-point))
    :hook (helpful-mode . cursor-sensor-mode)
    :init
    (with-eval-after-load 'apropos
      (dolist (fun-bt '(apropos-function apropos-macro apropos-command))
        (button-type-put fun-bt 'action
                         (lambda (button)
                           (helpful-callable (button-get button 'apropos-symbol)))))
      (dolist (var-bt '(apropos-variable apropos-user-option))
        (button-type-put var-bt 'action
                         (lambda (button)
                           (helpful-variable (button-get button 'apropos-symbol))))))
    :config
    (defun my/helpful--navigate (button)
      "导航到 BUTTON 代表的路径"
      (find-file-other-window (substring-no-properties (button-get button 'path)))
      (when-let* ((pos (get-text-property button 'position (marker-buffer button))))
        (helpful--goto-char-widen pos)))
    (advice-add #'helpful--navigate :override #'my/helpful--navigate))
  (use-package magit
    :ensure t
    :hook (git-commit-setup . git-commit-turn-on-flyspell)
    :bind (("C-x g" . magit-status)
           ("C-x M-g" . magit-dispatch)
           ("C-c M-g" . magit-file-dispatch))
    :custom
    (magit-diff-refine-hunk t)
    (magit-diff-paint-whitespace nil)
    (magit-ediff-dwim-show-on-hunks t))
  (use-package gptel-magit
    :ensure t
    :hook (magit-mode . gptel-magit-install))
#+end_src
** LaTeX 配置
#+begin_src emacs-lisp
  (add-hook 'prettify-symbols-mode-hook
            (defun prettify-symbols-latex-symbols ()
              "LaTeX 符号美化列表"
              (interactive)
              (setq-local prettify-symbols-alist '(("$" . 183)
                                                   ("\\alpha" . 945)
                                                   ("\\beta" . 946)
                                                   ("\\gamma" . 947)
                                                   ("\\delta" . 948)
                                                   ("\\epsilon" . 1013)
                                                   ("\\zeta" . 950)
                                                   ("\\eta" . 951)
                                                   ("\\theta" . 952)
                                                   ("\\iota" . 953)
                                                   ("\\kappa" . 954)
                                                   ("\\lambda" . 955)
                                                   ("\\mu" . 956)
                                                   ("\\nu" . 957)
                                                   ("\\xi" . 958)
                                                   ("\\pi" . 960)
                                                   ("\\rho" . 961)
                                                   ("\\sigma" . 963)
                                                   ("\\tau" . 964)
                                                   ("\\phi" . 981)
                                                   ("\\omega" . 969)
                                                   ("\\infty" . 8734)
                                                   ("\\int" . 8747)
                                                   ("\\sum" . 8721)
                                                   ("\\prod" . 8719)
                                                   ("\\leq" . 8804)
                                                   ("\\geq" . 8805)
                                                   ("\\in" . 8712)
                                                   ("\\subset" . 8834)
                                                   ("\\subseteq" . 8838)
                                                   ("\\supset" . 8835)
                                                   ("\\supseteq" . 8839)
                                                   ("\\cup" . 8746)
                                                   ("\\cap" . 8745)
                                                   ("\\emptyset" . 8709)
                                                   ("\\exists" . 8707)
                                                   ("\\forall" . 8704)
                                                   ("\\to" . 8594)
                                                   ("\\rightarrow" . 8594)
                                                   ("\\leftarrow" . 8592)
                                                   ("\\Rightarrow" . 8658)
                                                   ("\\Leftarrow" . 8656)
                                                   ("\\equiv" . 8801)
                                                   ("\\ne" . 8800)
                                                   ("\\approx" . 8776)
                                                   ("\\times" . 215)
                                                   ("\\cdot" . 8901)
                                                   ("\\partial" . 8706)
                                                   ("\\nabla" . 8711)))))
  ;;;  Lazytab
  (use-package lazytab
    :vc (:url "https://github.com/karthink/lazytab" :rev :newest)
    :bind (:map orgtbl-mode-map
           ("<tab>" . lazytab-org-table-next-field-maybe)
           ("TAB" . lazytab-org-table-next-field-maybe))
    :after cdlatex
    :config
    (add-hook 'cdlatex-tab-hook #'lazytab-cdlatex-or-orgtbl-next-field 90)
    (dolist (cmd '(("smat" "插入 smallmatrix 环境"
                    "\\left( \\begin{smallmatrix} ? \\end{smallmatrix} \\right)"
                    lazytab-position-cursor-and-edit nil nil t)
                   ("bmat" "插入 bmatrix 环境"
                    "\\begin{bmatrix} ? \\end{bmatrix}"
                    lazytab-position-cursor-and-edit nil nil t)
                   ("pmat" "插入 pmatrix 环境"
                    "\\begin{pmatrix} ? \\end{pmatrix}"
                    lazytab-position-cursor-and-edit nil nil t)
                   ("tbl" "插入表格"
                    "\\begin{table}\n\\centering ? \\caption{}\n\\end{table}\n"
                    lazytab-position-cursor-and-edit nil t nil)))
      (push cmd cdlatex-command-alist))
    (cdlatex-reset-mode))

  ;;;  AUCTeX
  (use-package latex
    :ensure auctex
    :mode ("\\.tex\\'" . LaTeX-mode)
    :hook ((LaTeX-mode . prettify-symbols-mode)
           (LaTeX-mode . display-line-numbers-mode)
           (LaTeX-mode . my/latex-with-outline))
    :bind (:map LaTeX-mode-map
           ("C-S-e" . latex-math-from-calc)
           ([remap LaTeX-environment] . cdlatex-environment)
           ("C-c C-v" . TeX-view)           ; 正向搜索：LaTeX → PDF
           ("C-c C-c" . TeX-command-master) ; 编译
           ("C-c C-a" . TeX-command-run-all)) ; 编译所有
    :config
    (setq TeX-auto-save t
          TeX-parse-self t
          TeX-save-query nil
          TeX-show-help nil
          TeX-PDF-mode t
          TeX-source-correlate-mode t
          TeX-source-correlate-start-server t
          TeX-error-overview-open-after-TeX-run t
          TeX-debug-warnings nil
          TeX-source-correlate-method 'synctex
          TeX-engine 'xetex
          TeX-command-default "Latexmk (xelatex)")
    (with-eval-after-load 'tex
      (dolist (cmd '(("Latexmk (xelatex)" "latexmk -xelatex -interaction=nonstopmode -synctex=1 %s" TeX-run-TeX nil t :help "使用 latexmk (XeLaTeX) 编译")
                     ("Latexmk Clean" "latexmk -c %s" TeX-run-command nil t :help "使用 latexmk 清理辅助文件")))
        (push cmd TeX-command-list))
      (setq TeX-view-program-selection '((output-pdf "PDF Tools"))
            TeX-view-program-list '(("PDF Tools" TeX-pdf-tools-sync-view)))
      ;; ----- 编译后自动刷新 PDF -----
      (add-hook 'TeX-after-compilation-finished-functions
                #'TeX-revert-document-buffer)
      (defun my/latex-with-outline ()
        (add-to-list 'minor-mode-overriding-map-alist
                     `(outline-minor-mode . ,outline-minor-mode-map))
        (outline-minor-mode 1))
      (defun latex-math-from-calc ()
        "对光标所在行的内容执行 calc 求值"
        (interactive)
        (let ((calc-settings '(calc-language latex
                                             calc-prefer-frac t
                                             calc-angle-mode rad)))
          (if (region-active-p)
              (let* ((beg (region-beginning))
                     (end (region-end))
                     (string (buffer-substring-no-properties beg end)))
                (delete-region beg end)
                (insert (calc-eval (cons string calc-settings))))
            (let ((l (thing-at-point 'line)))
              (end-of-line 1)
              (kill-line 0)
              (insert (calc-eval (cons l calc-settings)))))))
      (add-hook 'LaTeX-mode-hook
                (lambda ()
                  (setq TeX-auto-untabify t
                        TeX-engine 'xetex
                        TeX-show-compilation t
                        TeX-save-query nil)
                  (TeX-global-PDF-mode t)
                  (imenu-add-menubar-index)))))

  (use-package preview
    :after latex
    :hook (LaTeX-mode . preview-larger-previews)
    :config
    (defun preview-larger-previews ()
      (setq preview-scale-function
            (lambda () (* 1.25 (funcall (preview-scale-from-face)))))))
  ;;;CDLatex
  (use-package cdlatex
    :ensure t
    :hook ((LaTeX-mode . turn-on-cdlatex)
           (cdlatex-tab . yas-expand)
           (cdlatex-tab . cdlatex-in-yas-field))
    :bind (:map cdlatex-mode-map
           ("<tab>" . cdlatex-tab))
    :config
    (with-eval-after-load 'yasnippet
      (define-key yas-keymap (kbd "<tab>") #'yas-next-field-or-cdlatex)
      (define-key yas-keymap (kbd "TAB") #'yas-next-field-or-cdlatex)
      (defun cdlatex-in-yas-field ()
        "在 Yas 字段中检查并处理 cdlatex"
        (when-let* ((_ (overlayp yas--active-field-overlay))
                    (end (overlay-end yas--active-field-overlay)))
          (if (>= (point) end)
              (let ((s (thing-at-point 'sexp)))
                (unless (and s (assoc (substring-no-properties s)
                                      cdlatex-command-alist-comb))
                  (yas-next-field-or-maybe-expand)
                  t))
            (let (cdlatex-tab-hook minp)
              (setq minp (min (save-excursion (cdlatex-tab) (point))
                              (overlay-end yas--active-field-overlay)))
              (goto-char minp)
              t))))
      (defun yas-next-field-or-cdlatex ()
        "正确处理 cdlatex 激活时跳转到下一个 Yas 字段"
        (interactive)
        (if (or (bound-and-true-p cdlatex-mode)
                (bound-and-true-p org-cdlatex-mode))
            (cdlatex-tab)
          (yas-next-field-or-maybe-expand)))))

  (use-package org-table
    :after cdlatex
    :bind (:map orgtbl-mode-map
           ("<tab>" . lazytab-org-table-next-field-maybe)
           ("TAB" . lazytab-org-table-next-field-maybe))
    :hook (cdlatex-tab . lazytab-cdlatex-or-orgtbl-next-field))

  ;;;  Consult-RefTeX
  (use-package consult-reftex
    :vc (consult-reftex :url "https://github.com/karthink/consult-reftex" :rev :newest)
    :after (reftex consult embark)
    :bind (:map reftex-mode-map
           ("C-c )" . consult-reftex-insert-reference)
           ("C-c M-." . consult-reftex-goto-label)
           :map org-mode-map
           ("C-c (" . consult-reftex-goto-label)
           ("C-c )" . consult-reftex-insert-reference))
    :config
    (with-eval-after-load 'embark
      (defun consult-reftex--key-finder ()
        (when (and
               (or (derived-mode-p 'LaTeX-mode)
                   (derived-mode-p 'org-mode))
               (cl-intersection
                '(font-lock-constant-face TeX-fold-unfolded-face)
                (ensure-list (get-char-property (point) 'face))))
          (save-excursion
            (text-property-search-backward
             'face 'font-lock-constant-face
             (lambda (val prop) (memq val (ensure-list prop))))
            (when (looking-back "\$?:la\$?\$?:ref\\|bel\${" (- (point) 5))
              (backward-char 1)
              (let* ((start (1+ (point)))
                     (end (progn (forward-list)
                                 (1- (point)))))
                `(reftex-label
                  ,(buffer-substring-no-properties start end)
                  ,start . ,end))))))
      (cl-pushnew 'consult-reftex--key-finder embark-target-finders))
    (setq consult-reftex-preview-function
          #'consult-reftex-preview-make-window
          consult-reftex-preferred-style-order
          '("\\cref" "\\eqref" "\\ref"))
    (consult-customize consult-reftex-insert-reference
                       :preview-key (list :debounce 0.3 'any)))
  ;;;Pdf-Tools
  (use-package pdf-tools
    :ensure t
    :commands (pdf-view-mode pdf-tools-install)
    :mode ("\\.[pP][dD][fF]\\'" . pdf-view-mode)
    :config
    (pdf-tools-install) ; On demand loading, leads to faster startup time
    ;; 性能优化
    (setq pdf-view-midnight-colors '("#ffffff" . "#000000"))
    (setq-default pdf-view-display-size 'fit-page)
    (setq pdf-view-resize-factor 1.1)
    ;; 自动重载
    (add-hook 'pdf-view-mode-hook 'auto-revert-mode))
  ;; 常用辅助模块（它们都在 pdf-tools 包里，不需要 :ensure）
  (use-package pdf-isearch
    :ensure nil :after pdf-tools)
  (use-package pdf-links
    :ensure nil
    :after pdf-tools
    :bind (:map pdf-view-mode-map
           ("f" . pdf-links-isearch-link)
           ("F" . pdf-links-action-perform)))
  (use-package pdf-annot
    :ensure nil
    :after pdf-tools)
  (use-package doc-view
    :ensure nil
    :init
    (setq doc-view-mode-hook nil))
  ;;; 文献管理与引用
  (use-package bibtex
    :ensure nil
    :defer t
    :mode ("\\.bib\\'" . bibtex-mode)
    :custom
    (bibtex-dialect 'biblatex)  ;; 使用 BibLaTeX 格式
    (bibtex-user-optional-fields
     '(("keywords" "关键词，用逗号分隔")
       ("file" "PDF 文件路径")
       ("doi" "DOI")
       ("url" "在线链接")))
    (bibtex-align-at-equal-sign t)
    (bibtex-autokey-year-length 4)
    (bibtex-autokey-name-year-separator "")
    (bibtex-autokey-year-title-separator "")
    (bibtex-autokey-titleword-length 5)
    (bibtex-autokey-titlewords 3)
    :bind (:map bibtex-mode-map
           ("C-c C-c" . bibtex-clean-entry)))
  (use-package reftex
    :defer t
    :hook (LaTeX-mode . turn-on-reftex)
    :config
    (setq reftex-plug-into-AUCTeX t
          reftex-cite-format 'biblatex))
#+end_src
** 工具集成
*** Gptel
#+begin_src emacs-lisp
  (use-package epa-file
    :ensure nil  ;; Emacs 内置
    :config
    (epa-file-enable)
    (setq epa-file-cache-passphrase-for-symmetric-encryption t
          epa-file-select-keys t  ;; 自动选择密钥
          epg-pinentry-mode 'loopback))  ;; 在 minibuffer 输入密码
  (use-package auth-source
    :ensure nil
    :config
    (setq auth-sources (list(locate-user-emacs-file "authinfo.gpg")))
    (setq auth-source-cache-expiry nil))

  (use-package gptel
    :ensure t
    :commands (gptel gptel-send gptel-menu gptel-abort)
    :config
    (setq gptel-backends
          `(("B4U" .
             ,(gptel-make-openai "B4U"
                :host "b4u.qzz.io"
                :protocol "https"
                :endpoint "/v1/chat/completions"
                :stream t
                :key #'gptel-api-key-from-auth-source
                :models '(claude-4.5-sonnet-think
                          claude-4.5-sonnet)))
            ("Deep Seek" .
             ,(gptel-make-deepseek "DeepSeek"
                :stream t
                :key #'gptel-api-key-from-auth-source
                :models '(deepseek-reasoner deepseek-chat)))
            ("Aliyun Bailian" .
             ,(gptel-make-openai "Aliyun Bailian"
                :host "dashscope.aliyuncs.com"
                :protocol "https"
                :endpoint "/compatible-mode/v1/chat/completions"
                :stream t
                :key #'gptel-api-key-from-auth-source
                :models '(kimi-k2-thinking
                          deepseek-v3.2)))))
    (setq gptel-default-mode 'org-mode
          gptel-use-curl nil
          gptel-backend (cdr (assoc "Aliyun Bailian" gptel-backends)) ; 默认后端
          gptel-model 'deepseek-v3.2)                                    ; 默认模型
    :bind (("C-c C-<return>" . gptel-menu)
           ("C-c <return>" . gptel-send)
           ("C-c C-g" . gptel-abort)
           :map gptel-mode-map
           ("C-c C-x t" . gptel-set-topic))
    :custom
    (gptel-prompt-prefix-alist
     '((markdown-mode . "### ")
       (org-mode . "* ")
       (text-mode . "### ")))
    (gptel-response-prefix-alist
     '((markdown-mode . "")
       (org-mode . "")
       (text-mode . ""))))
  (defun replace-and-trim-latex (&rest _)
    "将 LaTeX 分隔符替换为 $, $$"
    (save-excursion
      (goto-char (point-min))
      (let ((replacements '(("\\\$" . "$")
                            ("\\\$" . "$")
                            ("\\\\\$$" . "$$")
                            ("\\\\\$$" . "$$"))))
        (dolist (pair replacements)
          (goto-char (point-min))
          (while (re-search-forward (car pair) nil t)
            (replace-match (cdr pair) nil nil))))
      (goto-char (point-min))
      (while (re-search-forward "\$?:^\\| \$\\$\$?: \\|$\$" nil t)
        (replace-match "$" nil nil))))
  (add-hook 'gptel-post-response-functions #'replace-and-trim-latex)
#+end_src

*** Persistent Scratch
#+begin_src emacs-lisp
  (use-package diminish
    :ensure t)
  (use-package persistent-scratch
    :ensure t
    :diminish
    :bind (:map persistent-scratch-mode-map
           ([remap kill-buffer] . (lambda (&rest _)
                                    (interactive)
                                    (user-error "Scratch 缓冲区无法关闭")))
           ([remap revert-buffer] . persistent-scratch-restore)
           ([remap revert-this-buffer] . persistent-scratch-restore))
    :hook ((after-init . persistent-scratch-autosave-mode)
           (lisp-interaction-mode . persistent-scratch-mode))
    :init
    (setq persistent-scratch-save-file
          (locate-user-emacs-file "etc/persistent-scratch/.persistent-scratch")
          persistent-scratch-backup-file-name-format "%Y-%m-%d"
          persistent-scratch-backup-directory
          (locate-user-emacs-file "etc/persistent-scratch/")))
#+end_src

*** Transient 配置
#+begin_src emacs-lisp
  (setq transient-levels-file (locate-user-emacs-file "etc/transient/levels.el")
        transient-values-file (locate-user-emacs-file "etc/transient/values.el")
        transient-history-file (locate-user-emacs-file "etc/transient/history.el"))
#+end_src
*** 日历配置
#+begin_src emacs-lisp
  (use-package cal-china-x
    :ensure t
    :defer t
    :commands cal-china-x-setup
    :hook (calendar-mode . cal-china-x-setup)
    :config
    (setq calendar-mark-holidays-flag t
          cal-china-x-important-holidays cal-china-x-chinese-holidays
          cal-china-x-general-holidays '((holiday-lunar 1 15 "元宵节")
                                         (holiday-lunar 7 7 "七夕节")
                                         (holiday-fixed 3 8 "妇女节")
                                         (holiday-fixed 3 12 "植树节")
                                         (holiday-fixed 5 4 "青年节")
                                         (holiday-fixed 6 1 "儿童节")
                                         (holiday-fixed 9 10 "教师节"))
          holiday-other-holidays '((holiday-fixed 2 14 "情人节")
                                   (holiday-fixed 4 1 "愚人节")
                                   (holiday-fixed 12 25 "圣诞节")
                                   (holiday-float 5 0 2 "母亲节")
                                   (holiday-float 6 0 3 "父亲节")
                                   (holiday-float 11 4 4 "感恩节"))
          calendar-holidays (append cal-china-x-important-holidays
                                    cal-china-x-general-holidays
                                    holiday-other-holidays)))
  ;;; init.el ends here
#+end_src
