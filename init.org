#+TITLE: Emacs config (single source of truth)
#+PROPERTY: header-args:emacs-lisp :lexical t
#+OPTIONS: toc:nil

* early-init.el
:PROPERTIES:
:header-args:emacs-lisp: :tangle early-init.el
:END:

#+begin_src emacs-lisp
;; -*- lexical-binding: t; -*-
;;; early-init.el - æ¿€è¿›ä¼˜åŒ–ç‰ˆ

;; ========== (1) GC ä¸´æ—¶åŠ é€Ÿï¼ˆä¿æŒåŸæ ·ï¼‰==========
(defvar my/startup-gc-cons-threshold gc-cons-threshold)
(defvar my/startup-gc-cons-percentage gc-cons-percentage)

(setq gc-cons-threshold most-positive-fixnum
      gc-cons-percentage 0.6)

(add-hook 'emacs-startup-hook
          (lambda ()
            (setq gc-cons-threshold (* 64 1024 1024)  ;; 64MBï¼ˆæ›´æ¿€è¿›ï¼‰
                  gc-cons-percentage 0.1)))

;; ========== (2) file-name-handler-alist ä¸´æ—¶åŠ é€Ÿï¼ˆä¿æŒåŸæ ·ï¼‰==========
(defvar my/startup-file-name-handler-alist file-name-handler-alist)
(setq file-name-handler-alist nil)

(add-hook 'emacs-startup-hook
          (lambda ()
            (setq file-name-handler-alist my/startup-file-name-handler-alist)))

;; ========== (3) **å…³é”®ä¼˜åŒ–: å¯ç”¨ package-quickstart** ==========
;; ç”Ÿæˆå•ä¸€çš„ autoload æ–‡ä»¶ï¼Œé¿å…æ¯æ¬¡æ‰«æ elpa/
(setq package-quickstart t)
;; é¦–æ¬¡ä½¿ç”¨éœ€è¿è¡Œ: M-x package-quickstart-refresh

;; ========== (4) Native compilation ä¼˜åŒ– ==========
(setq load-prefer-newer t
      native-comp-jit-compilation t
      native-comp-async-report-warnings-errors nil
      native-comp-deferred-compilation t)  ;; å»¶è¿Ÿç¼–è¯‘

;; ========== (5) ç¼–ç ï¼ˆä¿æŒåŸæ ·ï¼‰==========
(prefer-coding-system 'utf-8)
(setq-default buffer-file-coding-system 'utf-8)

;; ========== (6) Frame/UIï¼ˆä¿æŒåŸæ ·ï¼‰==========
(setq frame-inhibit-implied-resize t)
(push '(menu-bar-lines . 0) default-frame-alist)
(push '(tool-bar-lines . 0) default-frame-alist)
(push '(vertical-scroll-bars . nil) default-frame-alist)

;; ========== (7) åŠ è½½è·¯å¾„ä¼˜åŒ– ==========
(setq load-suffixes '(".elc" ".el"))  ;; ä¼˜å…ˆ .elc
(setq load-file-rep-suffixes '(""))

(provide 'early-init)
;;; early-init.el ends here
#+end_src

* init.el
:PROPERTIES:
:header-args:emacs-lisp: :tangle init.el
:END:
#+begin_src emacs-lisp
;; -*- lexical-binding: t; -*-
;;; init.el --- ä¼˜åŒ–åçš„åŒ…ç®¡ç†é…ç½®

;; ========== å…³é”®ä¼˜åŒ– 1: å®Œå…¨é¿å… package-initialize ==========
(eval-and-compile
  (setq package-enable-at-startup nil)
  
  ;; ç›´æ¥ require use-packageï¼ˆç¡®ä¿å·²é€šè¿‡ä¸€æ¬¡æ€§å®‰è£…ï¼‰
  ;; å¦‚æœæœªå®‰è£…ï¼Œé¦–æ¬¡è¿è¡Œï¼šM-x package-refresh-contents â†’ M-x package-install RET use-package
  (unless (require 'use-package nil t)
    (warn "use-package æœªå®‰è£…ï¼è¯·æ‰‹åŠ¨å®‰è£…ï¼šM-x package-refresh-contents"))
  
  (setq use-package-always-ensure nil
        use-package-expand-minimally t
        use-package-compute-statistics nil))  ;; å…³é—­ç»Ÿè®¡ä»¥å‡å°‘å¼€é”€

;; åŒ…æºé…ç½®ï¼ˆä¿æŒåŸæ ·ï¼‰
(setq package-archives '(("gnu"    . "https://mirrors.ustc.edu.cn/elpa/gnu/")
                         ("melpa"  . "https://mirrors.ustc.edu.cn/elpa/melpa/")
                         ("nongnu" . "https://mirrors.ustc.edu.cn/elpa/nongnu/")))


#+END_SRC
** åŸºç¡€é…ç½®
*** æ ¸å¿ƒè®¾ç½®
#+begin_src emacs-lisp
  ;; å‘½ä»¤è¡Œé€‰é¡¹
  (setq command-line-x-option-alist nil)

  ;; è¿›ç¨‹ IO ä¼˜åŒ–
  (setq read-process-output-max #x10000)  ; 64kb

  ;; ç¦ç”¨ ffap åŸŸåæ£€æµ‹
  (setq ffap-machine-p-known 'reject)

  ;; ä¸ªäººä¿¡æ¯
  (setq user-full-name "Wei"
        user-mail-address "Jiawei0655@gmail.com")

  ;; UTF-8 ç¼–ç 
  (when (fboundp 'set-charset-priority)
    (set-charset-priority 'unicode))
  (prefer-coding-system 'utf-8)
  (setq locale-coding-system 'utf-8)
  (setq system-time-locale "C")

  ;; GC ç®¡ç†
  (use-package gcmh
    :ensure t
    :diminish
    :hook (emacs-startup . gcmh-mode)
    :custom
    (gcmh-idle-delay 'auto)
    (gcmh-auto-idle-delay-factor 10)
    (gcmh-high-cons-threshold #x12800000))

  ;; Server æ¨¡å¼
 
(use-package server
  :ensure nil
  :hook (after-init . server-mode))

  ;; ä¿å­˜ä½ç½®
  (use-package saveplace
    :defer t
     :hook (after-init . save-place-mode)
    :config (setq save-place-file (locate-user-emacs-file "etc/places")))

  ;; æœ€è¿‘æ–‡ä»¶
  (use-package recentf
    :defer 1
    :bind (("C-x C-r" . recentf-open-files))
     :hook (after-init . recentf-mode)
    :custom
    (recentf-max-saved-items 300)
    (recentf-auto-cleanup 'never)
    (recentf-exclude
     '("^/private/tmp/"
       "^/var/folders/"
       "^/tmp/"
       "/ssh\\(x\\)?:"
       "/su\\(do\\)?:"
       "^/usr/include/"
       "/TAGS\\'"
       "COMMIT_EDITMSG\\'"))
    :config (setq recentf-save-file (locate-user-emacs-file "etc/recentf")))

  ;; å†å²è®°å½•
  (use-package savehist
    :hook (after-init . savehist-mode)
    :init (setq enable-recursive-minibuffers t
                history-length 1000
                savehist-file (locate-user-emacs-file "etc/history")
                savehist-additional-variables '(mark-ring
                                                global-mark-ring
                                                search-ring
                                                regexp-search-ring
                                                extended-command-history)
                savehist-autosave-interval 300))
#+end_src

*** Simple æ¨¡å¼å¢å¼º

#+begin_src emacs-lisp
  (use-package simple
    :ensure nil
    :hook ((after-init . size-indication-mode)
           (text-mode . visual-line-mode)
           ((prog-mode markdown-mode conf-mode) . enable-trailing-whitespace))
    :init
    (setq column-number-mode t
          line-number-mode t
          line-move-visual nil
          track-eol t
          set-mark-command-repeat-pop t)

    (setq-default show-trailing-whitespace nil)
    (defun enable-trailing-whitespace ()
      "Show trailing spaces and delete on saving."
      (setq show-trailing-whitespace t)
      (add-hook 'before-save-hook #'delete-trailing-whitespace nil t))

    ;; ç¾åŒ–è¿›ç¨‹åˆ—è¡¨
    (with-no-warnings
      (defun my/list-processes--prettify ()
        "Prettify process list."
        (when-let* ((entries tabulated-list-entries))
          (setq tabulated-list-entries nil)
          (dolist (p (process-list))
            (when-let* ((val (cadr (assoc p entries)))
                        (name (aref val 0))
                        (pid (aref val 1))
                        (status (aref val 2))
                        (status (list status
                                      'face
                                      (if (memq status '(stop exit closed failed))
                                          'error
                                        'success)))
                        (buf-label (aref val 3))
                        (tty (list (aref val 4) 'face 'font-lock-doc-face))
                        (thread (list (aref val 5) 'face 'font-lock-doc-face))
                        (cmd (list (aref val 6) 'face 'completions-annotations)))
              (push (list p (vector name pid status buf-label tty thread cmd))
                    tabulated-list-entries)))))
      (advice-add #'list-processes--refresh :after #'my/list-processes--prettify)))

  ;; ç®€åŒ–ç¡®è®¤
  (setq use-short-answers t)
  (setq y-or-n-p-use-read-key t
        read-char-choice-use-read-key t)
  (setq visible-bell t
        inhibit-compacting-font-caches t
        delete-by-moving-to-trash t
        make-backup-files nil
        auto-save-default nil
        uniquify-buffer-name-style 'post-forward-angle-brackets
        adaptive-fill-regexp "[ t]+|[ t]*([0-9]+.|*+)[ t]*"
        adaptive-fill-first-line-regexp "^* *$"
        sentence-end "\\([ã€‚ï¼ï¼Ÿ]\\|â€¦â€¦\\|[.?!][]\"')}]*\\($\\|[ \t]\\)\\)[ \t\n]*"
        sentence-end-double-space nil
        word-wrap-by-category t)
#+end_src

** UI ç•Œé¢
*** ä¸»é¢˜é…ç½®
#+begin_src emacs-lisp
(use-package panel
  :vc (panel :url "https://github.com/LuciusChen/panel.git"
             :branch "main")
  :hook (after-init . panel-create-hook)

  :config
  ;; ========== åŸºç¡€æ˜¾ç¤ºé…ç½® ==========
  (setq panel-title "Happy hacking, Emacs â™¥  you"
        panel-show-file-path nil
        panel-min-left-padding 10
        panel-path-max-length 20

        ;; åœ°ç†ä½ç½® - å¤§è¿
        panel-latitude 38.9140
        panel-longitude 121.6147

        ;; å›¾ç‰‡é…ç½®
        panel-image-file (locate-user-emacs-file "etc/bitmap.png")
        panel-image-width 400
        panel-image-height 169)

  ;; ========== ä¿®å¤å¤©æ°”å›¾æ ‡æ˜¾ç¤º ==========
  ;; è¦†ç›– Panel çš„å›¾æ ‡å‡½æ•°ï¼Œä½¿ç”¨ Unicode emojiï¼ˆå…¼å®¹æ€§æœ€å¥½ï¼‰
  (defun panel--weather-icon-from-code (code)
    "ä½¿ç”¨ Unicode emoji æ›¿ä»£ nerd-iconsï¼ˆå…¼å®¹æ€§æœ€ä½³ï¼‰"
    (pcase code
      ;; æ™´å¤©
      (`0 "â˜€ï¸")

      ;; å¤šäº‘/éƒ¨åˆ†å¤šäº‘
      ((or `1 `2 `3) "â›…")

      ;; é›¾
      ((or `45 `48) "ğŸŒ«ï¸")

      ;; æ¯›æ¯›é›¨/å°é›¨
      ((or `51 `53 `55) "ğŸŒ¦ï¸")

      ;; å†»é›¨/é›¨å¤¹é›ª
      ((or `56 `57 `66 `67) "ğŸŒ¨ï¸")

      ;; é›¨
      ((or `61 `63 `65 `80 `81 `82) "ğŸŒ§ï¸")

      ;; é›ª
      ((or `71 `73 `75 `77 `85 `86) "â„ï¸")

      ;; é›·æš´
      ((or `95 `96 `99) "â›ˆï¸")

      ;; æœªçŸ¥/é»˜è®¤
      (_ "ğŸŒ¤ï¸"))))

(use-package circadian
  :ensure t
  :defer t
  ;; ä¸è¦åœ¨ load-path æ‰«ææ—¶å°±åŠ è½½åŒ…
  :init
  ;; è¿™é‡Œå†™å˜é‡è®¾ç½®ï¼Œä¸ä¼šè§¦å‘åŒ…çš„çœŸæ­£åŠ è½½
  (setq circadian-themes
        '((:sunrise . modus-operandi)
          (:sunset  . modus-vivendi))
        calendar-latitude  38.9140
        calendar-longitude 121.6147
        calendar-location-name "Dalian")
  :hook (after-init . circadian-setup))

;; ========== å¹³æ»‘æ»šåŠ¨ ==========
(use-package pixel-scroll
  :ensure nil
  :if (>= emacs-major-version 29)
  :hook (after-init . pixel-scroll-precision-mode)
  :custom
  ;; åƒç´ çº§è°ƒæ•´çª—å£
  (window-resize-pixelwise t)
  (frame-resize-pixelwise t)
  (pixel-scroll-precision-interpolate-page t)
  (pixel-scroll-precision-large-scroll-height 40.0)
  (pixel-scroll-precision-interpolation-factor 30))
#+end_src

*** å­—ä½“é…ç½®

#+begin_src emacs-lisp

  ;;; å­—ä½“é…ç½® - ä¼˜åŒ–ç‰ˆï¼ˆç¼“å­˜ + å»¶è¿ŸåŠ è½½ï¼‰

  (defun font-available-p (font-name)
    "æ£€æŸ¥å­—ä½“æ˜¯å¦å¯ç”¨ï¼ˆç¼“å­˜å‹å¥½ï¼‰"
    (find-font (font-spec :name font-name)))

  ;; å­—ä½“ç¼“å­˜ï¼ˆé¿å…é‡å¤æ¢æµ‹ï¼‰
  (defvar my/font-cache nil
    "ç¼“å­˜æ¢æµ‹åˆ°çš„å­—ä½“ï¼Œé¿å…é‡å¤æŸ¥è¯¢ç³»ç»Ÿå­—ä½“æ•°æ®åº“")

  (defun my/detect-fonts-once ()
  ;;   "ä¸€æ¬¡æ€§æ¢æµ‹æ‰€æœ‰éœ€è¦çš„å­—ä½“å¹¶ç¼“å­˜ç»“æœ"
  (unless my/font-cache
    (setq my/font-cache
          (list
           :han (cl-loop for f in '("Sarasa Mono SC" "LXGW Neo Xihei"
                                    "LXGW WenKai Mono" "Microsoft Yahei UI")
                         when (font-available-p f) return f)
           :symbol (cl-loop for f in '("Symbols Nerd Font" "Symbols Nerd Font Mono" "Apple Symbols"
                                       "Segoe UI Symbol" "Symbola" "Symbol")
                            when (font-available-p f) return f)
           :emoji (cl-loop for f in '("Noto Color Emoji" "Apple Color Emoji"
                                      "Segoe UI Emoji")
                           when (font-available-p f) return f)))))

  (defun my/setup-fonts-beautiful ()
    "è®¾ç½®å­—ä½“ï¼ˆç¾åŒ–ç‰ˆï¼‰"
    (when (display-graphic-p)
      ;; è‹±æ–‡å­—ä½“ï¼ˆä½¿ç”¨æ›´ç°ä»£çš„å­—ä½“ï¼‰
      ;; æ¨èï¼šFira Code, Cascadia Code, Source Code Pro
      (set-face-attribute 'default nil
                          :font "IosevkaTerm NF"  ;; æˆ– "Fira Code"
                          :height 120
                          :weight 'normal)

      ;; å˜é‡å­—ä½“ï¼ˆç”¨äº Org æ­£æ–‡ï¼‰
      (set-face-attribute 'variable-pitch nil
                          :font "Sarasa Mono SC"  ;; æˆ– "Microsoft YaHei UI"
                          :height 1.0)

      ;; ç­‰å®½å­—ä½“ï¼ˆç”¨äºä»£ç å—ï¼‰
      (set-face-attribute 'fixed-pitch nil
                          :font "JetBrains Mono"
                          :height 1.0)

      ;; ä¸­æ–‡å­—ä½“
      (my/detect-fonts-once)
      (when-let* ((han (plist-get my/font-cache :han)))
        (setq face-font-rescale-alist `((,han . 1.3)))
        (set-fontset-font t 'han (font-spec :family han)))

      ;; ç¬¦å·å­—ä½“
      (when-let* ((sym (plist-get my/font-cache :symbol)))
        (set-fontset-font t 'symbol (font-spec :family sym) nil 'prepend))

      ;; Emoji å­—ä½“
      (when-let* ((emo (plist-get my/font-cache :emoji)))
        (set-fontset-font t 'emoji (font-spec :family emo) nil 'prepend))))

  ;; å»¶è¿ŸåŠ è½½å­—ä½“é…ç½®
  ;; (run-with-idle-timer 0.3 nil #'my/setup-fonts-beautiful)

  (add-hook 'after-init-hook #'my/setup-fonts-beautiful)
  ;; æ–°å»º frameæ—¶ä¹Ÿåº”ç”¨ï¼ˆdaemon æ¨¡å¼éœ€è¦ï¼‰
  (add-hook 'after-make-frame-functions #'my/setup-fonts-beautiful)
  ;; Circadian åˆ‡æ¢ä¸»é¢˜åé‡æ–°åº”ç”¨
  (with-eval-after-load 'circadian
    (add-hook 'circadian-after-load-theme-hook
              (lambda (_theme) (my/setup-fonts-beautiful))))
#+end_src

*** å›¾æ ‡ä¸ Modeline

#+begin_src emacs-lisp
;;; Modeline - Doom Modelineï¼ˆæ¨èï¼‰

(use-package doom-modeline
  :ensure t
  :hook (after-init . doom-modeline-mode)
  :custom
  ;; å›¾æ ‡è®¾ç½®ï¼ˆéœ€è¦ nerd-iconsï¼‰
  (doom-modeline-icon t)
  (doom-modeline-major-mode-icon t)
  (doom-modeline-major-mode-color-icon t)
  
  ;; é«˜åº¦å’Œæ ·å¼
  (doom-modeline-height 28)
  (doom-modeline-bar-width 4)
  
  ;; æ˜¾ç¤ºå†…å®¹
  (doom-modeline-buffer-file-name-style 'relative-from-project)
  (doom-modeline-buffer-encoding nil)  ;; éšè—ç¼–ç ï¼ˆé€šå¸¸æ˜¯ UTF-8ï¼‰
  (doom-modeline-time-icon t)
  (doom-modeline-modal-icon t)
  (doom-modeline-modal-modern-icon t)
  
  ;; LSP æ”¯æŒ
  (doom-modeline-lsp t)
  (doom-modeline-lsp-icon t)
  
  ;; Git ä¿¡æ¯
  (doom-modeline-vcs-max-length 20)
  (doom-modeline-check-simple-format t)
  
  ;; æ€§èƒ½ä¼˜åŒ–
  (doom-modeline-env-version nil)  ;; ä¸æ˜¾ç¤º Python/Node ç‰ˆæœ¬ï¼ˆå‡å°‘å¡é¡¿ï¼‰
  (doom-modeline-github nil)       ;; ä¸æŸ¥è¯¢ GitHub é€šçŸ¥
  
  ;; Org æ¨¡å¼æ”¯æŒ
  (doom-modeline-enable-word-count t))

;; ç¡®ä¿ nerd-icons å·²å®‰è£…å­—ä½“
;; é¦–æ¬¡ä½¿ç”¨éœ€è¿è¡Œ: M-x nerd-icons-install-fonts
  (use-package nerd-icons
    :ensure t
    :defer t)  ;; åªåœ¨éœ€è¦æ—¶åŠ è½½ï¼ˆå¦‚ diredã€ibufferï¼‰
#+end_src

** ç¼–è¾‘å™¨è®¾ç½®

#+begin_src emacs-lisp
(use-package emacs
  :custom
  ;; æ›´ç»†çš„çª—å£åˆ†éš”çº¿
  (window-divider-default-right-width 1)
  (window-divider-default-bottom-width 1)
  (window-divider-default-places t)
  (initial-major-mode 'lisp-interaction-mode)
  (menu-bar-mode nil)
  (scroll-bar-mode nil)
  (tool-bar-mode nil)
  (inhibit-startup-screen t)
  (delete-selection-mode t)
  (electric-indent-mode nil)
  (electric-pair-mode t)
  (blink-cursor-mode nil)
  (global-auto-revert-mode t)
  (mouse-wheel-progressive-speed nil)
  (scroll-conservatively 10)
  (tab-width 4)
  (use-dialog-box nil)
  (make-backup-files nil)
  :config
  (window-divider-mode 1)
  ;; åˆ†éš”çº¿é¢œè‰²ï¼ˆè·Ÿéšä¸»é¢˜ï¼‰
  (set-face-attribute 'window-divider nil
                      :foreground (face-attribute 'default :background))
  (set-face-attribute 'window-divider-first-pixel nil
                      :foreground (face-attribute 'default :background))
  (set-face-attribute 'window-divider-last-pixel nil
                      :foreground (face-attribute 'default :background))
  :init
  ;; è¿è¡Œæ—¶çŠ¶æ€ç›®å½•
  (setq server-auth-dir (locate-user-emacs-file "etc/server/")
        auto-save-list-file-prefix (locate-user-emacs-file "etc/auto-save-list/.saves-"))
  (dolist (dir '("etc/" "etc/server/" "etc/auto-save-list/" "etc/org-persist/" "etc/transient/" "etc/persistent-scratch/"))
    (make-directory (locate-user-emacs-file dir) t))

  (setq custom-file (locate-user-emacs-file "etc/custom-vars.el"))
  (load custom-file 'noerror 'nomessage)
  (setq warning-minimum-level :emergency)
  (setq default-directory "C:/Users/wei/Documents/")
  ;; è°ƒæ•´frame-title
  ;; ä¸»çª—å£æ ‡é¢˜ä»…æ˜¾ç¤º buffer å
  (setq frame-title-format "%b")
  ;; ä»»åŠ¡æ /å›¾æ ‡æ ‡é¢˜ä¹ŸåŒæ­¥ï¼ˆå¯é€‰ï¼‰
  (setq icon-title-format "%b")
  (setq native-comp-async-report-warnings-errors nil)

  ;; Electric mode
  (electric-pair-mode t)

  ;; é•¿è¡Œä¼˜åŒ–
  (setq-default bidi-paragraph-direction 'left-to-right)
  (setq bidi-inhibit-bpa t)

  ;; æ— é”æ–‡ä»¶
  (setq create-lockfiles nil)

  ;; æ€»æ˜¯åŠ è½½æœ€æ–°æ–‡ä»¶
  (setq load-prefer-newer t)

  ;; å‰ªè´´æ¿è®¾ç½®
  (setq select-enable-primary t
        select-enable-clipboard t)

  ;; å­—ä½“ç¼“å­˜ä¸ GC
  (setq inhibit-compacting-font-caches t)

  ;; æ˜¾ç¤ºæ”¹è¿›
  (setq display-raw-bytes-as-hex t
        redisplay-skip-fontification-on-input t)

  ;; ç¦ç”¨å“é“ƒ
  (setq ring-bell-function 'ignore)

  ;; ç¦ç”¨å…‰æ ‡é—ªçƒ
  (setq blink-cursor-mode nil)

  ;; å¹³æ»‘æ»šåŠ¨
  (setq scroll-step 2
        scroll-margin 2
        hscroll-step 2
        hscroll-margin 2
        scroll-conservatively 101
        scroll-preserve-screen-position 'always)

  (setq auto-hscroll-mode 'current-line)
  (setq auto-window-vscroll nil)
  (setq mouse-yank-at-point t)
  (setq-default fill-column 80)

  ;; å°† _ è§†ä¸ºå•è¯ç»„æˆéƒ¨åˆ†
  (add-hook 'after-change-major-mode-hook
            (lambda ()
              (modify-syntax-entry ?_ "w")))

  ;; ç¦ç”¨ tabs
  (setq-default indent-tabs-mode nil)
  (setq-default tab-width 4)

  ;; å­—ä½“å¤§å°
  (set-face-attribute 'default nil :height 110)

  ;; å¯ç”¨è¢«ç¦ç”¨çš„å‘½ä»¤
  (put 'narrow-to-defun 'disabled nil)
  (put 'narrow-to-page 'disabled nil)
  (put 'narrow-to-region 'disabled nil)
  (put 'dired-find-alternate-file 'disabled nil)
  (put 'list-timers 'disabled nil)
  (put 'list-threads 'disabled nil)

  (with-eval-after-load 'help-fns
    (put 'help-fns-edit-variable 'disabled nil))
  :bind (([escape] . keyboard-escape-quit)))

;; è‡ªåŠ¨é‡æ–°åŠ è½½
(global-auto-revert-mode 1)
#+end_src

** ç¼–è¾‘å¢å¼º

*** åˆ é™¤é€‰ä¸­æ–‡æœ¬

#+begin_src emacs-lisp
  (use-package delsel
    :ensure nil
    :hook (after-init . delete-selection-mode))
#+end_src

*** è·³è½¬ (Avy)

#+begin_src emacs-lisp
    (use-package avy
      :defer t
      :ensure t
      :bind (("C-:" . avy-goto-char)
             ("C-\"" . avy-goto-char-2))
      ;;:hook (after-init . avy-setup-default)
      :config
      (setq avy-all-windows nil
            avy-all-windows-alt t
            avy-background t
            avy-style 'pre))
#+end_src

*** è‡ªåŠ¨é…å¯¹

#+begin_src emacs-lisp
  (use-package elec-pair
    :ensure nil
    :hook (after-init . electric-pair-mode)
    :config
    (setq electric-pair-inhibit-predicate 'electric-pair-conservative-inhibit))
#+end_src

*** æ™ºèƒ½åˆ é™¤ç©ºç™½

#+begin_src emacs-lisp
  (use-package hungry-delete
    :ensure t
    :diminish
    :hook (after-init . global-hungry-delete-mode)
    :init
    (setq hungry-delete-chars-to-skip " \t\f\v"
          hungry-delete-except-modes
          '(help-mode minibuffer-mode minibuffer-inactive-mode calc-mode)))
#+end_src

*** æ™ºèƒ½è¡Œé¦–è¡Œå°¾ç§»åŠ¨

#+begin_src emacs-lisp
  (use-package mwim
    :ensure t
    :bind (([remap move-beginning-of-line] . mwim-beginning)
           ([remap move-end-of-line] . mwim-end)))
#+end_src

*** é•¿è¡Œå¤„ç†

#+begin_src emacs-lisp
  (use-package so-long
    :ensure t
    :hook (after-init . global-so-long-mode))
#+end_src


** è¡¥å…¨ç³»ç»Ÿ
*** æ ¸å¿ƒè¡¥å…¨è®¾ç½®

#+begin_src emacs-lisp
  (use-package emacs
    :init
    (setq completion-cycle-threshold 3)
    (when (boundp 'read-extended-command-predicate)
      (setq read-extended-command-predicate
            #'command-completion-default-include-p))
    (setq tab-always-indent 'complete))
#+end_src

*** Orderless åŒ¹é…

#+begin_src emacs-lisp
    (use-package orderless
      :ensure t
      :after vertico
      :defer t
      :custom
      (completion-styles '(orderless basic))
      (completion-category-overrides '((file (styles basic partial-completion))))
      (completion-category-defaults nil) ;; Disable defaults, use our settings    
      (orderless-component-separator #'orderless-escapable-split-on-space))
#+end_src

*** æ‹¼éŸ³æ”¯æŒ

#+begin_src emacs-lisp
  (use-package pinyinlib
    :ensure t
    :after orderless
    :autoload pinyinlib-build-regexp-string
    :init
    (defun completion--regex-pinyin (str)
      (orderless-regexp (pinyinlib-build-regexp-string str)))
    (add-to-list 'orderless-matching-styles 'completion--regex-pinyin))
#+end_src

*** Vertico

#+begin_src emacs-lisp
  (use-package vertico
    :ensure t
    :bind (:map vertico-map
           ("RET" . vertico-directory-enter)
           ("DEL" . vertico-directory-delete-char)
           ("M-DEL" . vertico-directory-delete-word))
    :hook ((after-init . vertico-mode)
           (rfn-eshadow-update-overlay . vertico-directory-tidy))
    :custom
    (vertico-resize t)
    (vertico-cycle t)
    (vertico-resize nil)
    (vertico-count 15))
#+end_src

*** Marginalia

#+begin_src emacs-lisp
  (use-package marginalia
    :ensure t
    :after vertico
    :hook (after-init . marginalia-mode)
    :config
    (defun my/marginalia-annotate-command (cand)
      "Annotate command CAND with its documentation string."
      (when-let* ((sym (intern-soft cand)))
        (concat
         (when (member sym minor-mode-list)
           (if (and (boundp sym) (symbol-value sym))
               (propertize " (On)" 'face 'marginalia-on)
             (propertize " (Off)" 'face 'marginalia-off)))
         (marginalia-annotate-binding cand)
         (marginalia--documentation (marginalia--function-doc sym)))))
    (setf (alist-get 'command marginalia-annotator-registry)
          '(my/marginalia-annotate-command marginalia-annotate-binding builtin none)))
#+end_src

*** Consult

#+begin_src emacs-lisp
  (use-package consult-dir
    :ensure t
    :after consult)
  (use-package consult
    :ensure t
    :hook (completion-list-mode . consult-preview-at-point-mode)
    :defer t
    :bind (([remap imenu] . consult-imenu)
           ([remap isearch-forward] . consult-line)
           ([remap isearch-backward] . consult-line)
           ([remap find-file-read-only] . consult-recent-file)
           ([remap list-directory] . consult-dir)
           ([remap goto-line] . consult-goto-line)
           ([remap bookmark-jump] . consult-bookmark)
           ([remap recentf-open-files] . consult-recent-file)
           ([remap repeat-complex-command] . consult-complex-command)
           ([remap jump-to-register] . consult-register-load)
           ([remap point-to-register] . consult-register-store))
    :config
    (with-eval-after-load 'xref
      (setq xref-show-xrefs-function #'consult-xref
            xref-show-definitions-function #'consult-xref))

    (defvar consult-colors-history nil)
    (autoload 'list-colors-duplicates "facemenu")
    (autoload 'consult--read "consult")

    (defun consult-colors-emacs (color)
      "Show a list of all supported colors."
      (interactive
       (list (consult--read (list-colors-duplicates (defined-colors))
                            :prompt "Emacs color: "
                            :require-match t
                            :category 'color
                            :history '(:input consult-colors-history))))
      (insert color))

    (defun consult-colors--web-list ()
      "Return list of CSS colors."
      (require 'shr-color)
      (sort (mapcar #'downcase (mapcar #'car shr-color-html-colors-alist))
            #'string-lessp))

    (defun consult--orderless-regexp-compiler (input type &rest _config)
      (setq input (orderless-pattern-compiler input))
      (cons
       (mapcar (lambda (r) (consult--convert-regexp r type)) input)
       (lambda (str) (orderless--highlight input str))))

    (defun consult-colors-web (color)
      "Show a list of all CSS colors."
      (interactive
       (list (consult--read (consult-colors--web-list)
                            :prompt "Color: "
                            :require-match t
                            :category 'color
                            :history '(:input consult-colors-history))))
      (insert color))

    (with-no-warnings
      (consult-customize consult-ripgrep consult-fd
                         consult-bookmark consult-goto-line consult-theme
                         consult-recent-file
                         consult-buffer
                         :preview-key '(:debounce 0.2 any)))

    (setq register-preview-delay 0.5
          register-preview-function #'consult-register-format)

    :custom
    (consult-fontify-preserve nil)
    (consult-async-min-input 2)
    (consult-async-refresh-delay 0.15)
    (consult-async-input-throttle 0.2)
    (consult-async-input-debounce 0.1))
#+end_src

*** Embark

#+begin_src emacs-lisp
  (use-package embark
    :ensure t
    :bind (([remap describe-bindings] . embark-bindings)
           :map minibuffer-local-map
           ("M-o" . embark-act)
           ("C-c C-c" . embark-export)
           ("M-." . my/embark-preview)
           ("C-c C-o" . embark-collect))
    :init
    (setq prefix-help-command #'embark-prefix-help-command)
    :config
    (defun my/embark-preview ()
      "Previews candidate in vertico buffer."
      (interactive)
      (unless (bound-and-true-p consult--preview-function)
        (save-selected-window
          (let ((embark-quit-after-action nil))
            (embark-dwim)))))

    (add-to-list 'display-buffer-alist
                 '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                   nil
                   (window-parameters (mode-line-format . none))))

    (with-eval-after-load 'which-key
      (defun embark-which-key-indicator ()
        "An embark indicator that displays keymaps using which-key."
        (lambda (&optional keymap targets prefix)
          (if (null keymap)
              (which-key--hide-popup-ignore-command)
            (which-key--show-keymap
             (if (eq (plist-get (car targets) :type) 'embark-become)
                 "Become"
               (format "Act on %s '%s'%s"
                       (plist-get (car targets) :type)
                       (embark--truncate-target (plist-get (car targets) :target))
                       (if (cdr targets) "â€¦" "")))
             (if prefix
                 (pcase (lookup-key keymap prefix 'accept-default)
                   ((and (pred keymapp) km) km)
                   (_ (key-binding prefix 'accept-default)))
               keymap)
             nil nil t (lambda (binding)
                         (not (string-suffix-p "-argument" (cdr binding))))))))

      (setq embark-indicators
            '(embark-which-key-indicator
              embark-highlight-indicator
              embark-isearch-highlight-indicator))

      (defun embark-hide-which-key-indicator (fn &rest args)
        "Hide which-key indicator immediately."
        (which-key--hide-popup-ignore-command)
        (let ((embark-indicators
               (remq #'embark-which-key-indicator embark-indicators)))
          (apply fn args)))

      (advice-add #'embark-completing-read-prompter
                  :around #'embark-hide-which-key-indicator)))

  (use-package embark-consult
    :ensure t
    :after embark
    :bind (:map minibuffer-mode-map
           ("C-c C-o" . embark-export))
    :hook (embark-collect-mode . consult-preview-at-point-mode))
#+end_src

*** è‡ªåŠ¨è¡¥å…¨

#+begin_src emacs-lisp
  ;; Auto completion
    ;;; 1. æ ¸å¿ƒï¼šcorfu æœ¬èº«ä»éš Emacs å¯åŠ¨ï¼Œä½†æ‰€æœ‰æ‰©å±•éƒ½å»¶è¿ŸåŠ è½½
  ;; Company Mode
  (use-package company
    :ensure t
    :diminish
    :defer t  ;; å®Œå…¨å»¶è¿Ÿï¼Œä¸é€šè¿‡ hook è‡ªåŠ¨åŠ è½½
    :commands (company-mode company-complete company-complete-common)
    :bind
    (:map company-mode-map
     ([remap completion-at-point]
      . company-complete)
     :map company-active-map
     ("C-s"     . company-filter-candidates)
     ([tab]
      . company-complete-common-or-cycle)
     ([backtab]
      . company-select-previous-or-abort))
    :hook
    ;; åªåœ¨çœŸæ­£éœ€è¦è¡¥å…¨æ—¶æ‰å¯ç”¨ï¼ˆé¦–æ¬¡è¾“å…¥è§¦å‘ï¼‰
    ((prog-mode . my/company-enable-on-input)
     (org-mode . my/company-enable-on-input))
    :init
    (defvar my/company-enabled-buffers nil
      "å·²å¯ç”¨ company çš„ buffer åˆ—è¡¨")

    (defun my/company-enable-on-input ()
      "å»¶è¿Ÿå¯ç”¨ company-modeï¼Œç›´åˆ°é¦–æ¬¡è¾“å…¥"
      (unless (memq (current-buffer) my/company-enabled-buffers)
        (add-hook 'post-self-insert-hook #'my/company-lazy-start nil t)))

    (defun my/company-lazy-start ()
      "é¦–æ¬¡è¾“å…¥æ—¶å¯ç”¨ company-mode"
      (remove-hook 'post-self-insert-hook #'my/company-lazy-start t)
      (push (current-buffer) my/company-enabled-buffers)
      (company-mode 1))
    :custom
    (company-idle-delay 0.2)  ;; ä» 0 æ”¹ä¸º 0.2 ç§’ï¼ˆå‡å°‘é¢‘ç¹è§¦å‘ï¼‰
    (company-show-quick-access t)
    (company-require-match nil)
    (company-minimum-prefix-length 3)
    (company-tooltip-width-grow-only t)
    (company-tooltip-align-annotations t)
    (company-files-exclusions '(".git/" ".DS_Store"))
    (company-files-chop-trailing-slash nil)
    :config
    (setq company-backends '(company-capf
                             company-keywords
                             company-files
                             company-dabbrev
                             company-etags
                             company-yasnippet)))

    ;;; 2. ä¸»åŒ…å°‘é‡é…ç½®ï¼Œæ— æ€§èƒ½å½±å“ï¼Œç›´æ¥ä¿ç•™
  (use-package emacs
    :custom
    (tab-always-indent 'complete)
    (text-mode-ispell-word-completion nil)
    (read-extended-command-predicate #'command-completion-default-include-p))
#+end_src

*** Yasnippet

#+begin_src emacs-lisp
  (use-package yasnippet
    :ensure t
    :diminish
    :hook (((LaTeX-mode) . yas-minor-mode)
           (post-self-insert . my/yas-try-expanding-auto-snippets))
    :config
    (yas-reload-all)
    (with-eval-after-load 'warnings
      (cl-pushnew '(yasnippet backquote-change)
                  warning-suppress-types :test 'equal))

    (setq yas-triggers-in-field t)

    (defun my/yas-try-expanding-auto-snippets ()
      (when (and (boundp 'yas-minor-mode) yas-minor-mode)
        (let ((yas-buffer-local-condition ''(require-snippet-condition . auto)))
          (yas-expand))))
    :custom
    (yas-snippet-dirs (list (locate-user-emacs-file "yasnippets"))))
#+end_src

*** LSP-Mode

#+begin_src emacs-lisp
(use-package lsp-mode
  :ensure t
  :defer t
  :commands (lsp lsp-deferred)
  :hook (python-mode . lsp-deferred)
  :init
  ;; æå‰è®¾ç½®å˜é‡
  (setq lsp-keymap-prefix "C-c l"
        lsp-enable-links nil
        lsp-log-io nil
        lsp-print-performance nil
        lsp-enable-folding nil
        lsp-enable-snippet t
        lsp-enable-file-watchers nil
        lsp-enable-text-document-color nil
        lsp-enable-symbol-highlighting nil
        lsp-enable-on-type-formatting nil
        lsp-semantic-tokens-enable nil
        lsp-headerline-breadcrumb-enable nil
        lsp-modeline-code-actions-enable nil
        lsp-modeline-diagnostics-enable nil
        lsp-auto-guess-root nil
        lsp-completion-provider :none
        lsp-keep-workspace-alive nil
        lsp-eldoc-enable-hover nil
        lsp-client-packages '(lsp-ruff lsp-python-ty)
        ;;lsp-enabled-clients '(ruff ty)
        lsp-completion-enable-additional-text-edit nil)
  :config
  ;; ========== ä¼˜åŒ– 4: é™åˆ¶ LSP å·¥ä½œç©ºé—´ç¼“å­˜ ==========
  (setq lsp-session-file (locate-user-emacs-file "etc/lsp-session"))
  (setq lsp-server-install-dir (locate-user-emacs-file "etc/lsp-servers/"))
  ;; ========== å…³é”®é…ç½® 3: è¯†åˆ« org-src buffer ==========
  (defun my/lsp-org-src-p ()
    "åˆ¤æ–­å½“å‰ buffer æ˜¯å¦ä¸º org-src buffer"
    (and (boundp 'org-src-mode) org-src-mode))

  (defun my/lsp-org-src-workspace-root ()
    "ä¸º org-src buffer æä¾›å·¥ä½œç©ºé—´æ ¹ç›®å½•"
    (when (my/lsp-org-src-p)
      (when-let* ((edit-buffer (marker-buffer org-src--beg-marker)))
        (with-current-buffer edit-buffer
          (or (lsp-workspace-root)
              default-directory)))))

  (add-hook 'lsp-before-initialize-hook
            (lambda ()
              (when (my/lsp-org-src-p)
                (setq-local lsp-workspace-root
                            (my/lsp-org-src-workspace-root)))))
  ;; å»¶è¿ŸåŠ è½½ which-key é›†æˆ
  (with-eval-after-load 'which-key
    (lsp-enable-which-key-integration)))
#+end_src

** Format-all

#+begin_src emacs-lisp
(use-package format-all
  :ensure t
  :defer t
  :hook ((LaTeX-mode python-mode c-mode) . format-all-mode)
  :init
  (setq format-all-show-errors 'never)
  :config
  (setq format-all-default-formatters
        '(("LaTeX" auctex)
          ("Emacs Lisp" emacs-lisp)
          ("C" astyle)
          ("Python" ruff)
          ("BibTeX" emacs-bibtex)))
  (add-hook 'format-all-mode-hook #'format-all-ensure-formatter)
  ;; ========== å…³é”®é…ç½® 2: Org-src buffer ä¸“ç”¨é€»è¾‘ ==========
  (defun my/format-all-org-src ()
    "åœ¨ org-src buffer ä¸­æ ¹æ®è¯­è¨€é€‰æ‹©æ ¼å¼åŒ–å™¨"
    (when (derived-mode-p 'org-src-mode)
      (let* ((lang (org-src--lang-mode (org-src--contents-area)))
             (formatter (cdr (assoc (format "%s" lang)
                                    format-all-default-formatters))))
        (when formatter
          (format-all-buffer)))))
  ;; ========== å…³é”®é…ç½® 3: ä¿å­˜æ—¶è‡ªåŠ¨æ ¼å¼åŒ– ==========
  (add-hook 'format-all-mode-hook #'format-all-ensure-formatter)
  (with-eval-after-load 'diminish
    (diminish 'format-all-mode)))
#+end_src

** é«˜äº®ä¸åé¦ˆ
*** å½“å‰è¡Œé«˜äº®

#+begin_src emacs-lisp
  (use-package hl-line
    :ensure nil
    :hook ((after-init . global-hl-line-mode)
           ((dashboard-mode eshell-mode shell-mode term-mode vterm-mode) .
            (lambda () (setq-local global-hl-line-mode nil))))
    :custom-face
    ;; æ ¹æ®ä¸»é¢˜è°ƒæ•´é«˜äº®è¡Œé¢œè‰²
    (hl-line ((t (:extend t :background "#2d3436")))))
#+end_src

*** æ‹¬å·åŒ¹é…
#+begin_src emacs-lisp
  (use-package paren
    :defer t
    :after (:any text prog)
    :hook ((text-mode prog-mode) . show-paren-mode)
    :custom
    (show-paren-when-point-inside-paren t)
    (show-paren-when-point-in-periphery t)
    :config
    (setq show-paren-context-when-offscreen
          (if (childframe-workable-p) 'child-frame 'overlay))
    (with-no-warnings
      (defun display-line-overlay (pos str &optional face)
        "Display line at POS as STR with FACE."
        (let ((ol (save-excursion
                    (goto-char pos)
                    (make-overlay (line-beginning-position)
                                  (line-end-position)))))
          (overlay-put ol 'display str)
          (overlay-put ol 'face (or face '(:inherit highlight)))
          ol))

      (defvar-local show-paren--off-screen-overlay nil)
      (defun show-paren-off-screen (&rest _args)
        "Display matching line for off-screen paren."
        (when (overlayp show-paren--off-screen-overlay)
          (delete-overlay show-paren--off-screen-overlay))
        (when (and (overlay-buffer show-paren--overlay)
                   (not (or cursor-in-echo-area
                            executing-kbd-macro
                            noninteractive
                            (minibufferp)
                            this-command))
                   (and (not (bobp))
                        (memq (char-syntax (char-before)) '(?\) ?\$)))
                   (= 1 (logand 1 (- (point)
                                     (save-excursion
                                       (forward-char -1)
                                       (skip-syntax-backward "/\\")
                                       (point))))))
          (cl-letf (((symbol-function #'minibuffer-message)
                     (lambda (msg &rest args)
                       (let ((msg (apply #'format-message msg args)))
                         (setq show-paren--off-screen-overlay
                               (display-line-overlay
                                (window-start) msg))))))
            (blink-matching-open))))
      (advice-add #'show-paren-function :after #'show-paren-off-screen)))
#+end_src

*** è„‰å†²é«˜äº®

#+begin_src emacs-lisp
  (use-package pulse
    :ensure nil
    :custom-face
    (pulse-highlight-start-face ((t (:inherit region :background unspecified))))
    (pulse-highlight-face ((t (:inherit region :background unspecified :extend t))))
    :hook (((dumb-jump-after-jump imenu-after-jump) . my/recenter-and-pulse)
           ((bookmark-after-jump magit-diff-visit-file next-error) . my/recenter-and-pulse-line))
    :init
    (with-no-warnings
      (defun my/pulse-momentary-line (&rest _)
        "Pulse the current line."
        (pulse-momentary-highlight-one-line (point)))

      (defun my/pulse-momentary (&rest _)
        "Pulse the region or current line."
        (if (fboundp 'xref-pulse-momentarily)
            (xref-pulse-momentarily)
          (my/pulse-momentary-line)))

      (defun my/recenter-and-pulse (&rest _)
        "Recenter and pulse the region or current line."
        (recenter)
        (my/pulse-momentary))

      (defun my/recenter-and-pulse-line (&rest _)
        "Recenter and pulse the current line."
        (recenter)
        (my/pulse-momentary-line))

      (dolist (cmd '(recenter-top-bottom
                     other-window switch-to-buffer
                     aw-select toggle-window-split
                     windmove-do-window-select
                     pager-page-down pager-page-up
                     treemacs-select-window))
        (advice-add cmd :after #'my/pulse-momentary-line))

      (dolist (cmd '(pop-to-mark-command
                     pop-global-mark
                     goto-last-change))
        (advice-add cmd :after #'my/recenter-and-pulse))))
#+end_src

** æ–‡ä»¶ç®¡ç†
*** Ibuffer

#+begin_src emacs-lisp
  (use-package ibuffer
    :ensure nil
    :bind ("C-x C-b" . ibuffer)
    :init (setq ibuffer-filter-group-name-face '(:inherit (font-lock-string-face bold))))

  (use-package nerd-icons-ibuffer
    :ensure t
    :after ibuffer
    :hook (ibuffer-mode . nerd-icons-ibuffer-mode)
    :config (setq nerd-icons-ibuffer-icon t))
#+end_src

*** Minibuffer

#+begin_src emacs-lisp
  (use-package minibuffer
    :bind (:map minibuffer-local-map
           ([escape] . abort-recursive-edit)
           :map minibuffer-local-ns-map
           ([escape] . abort-recursive-edit)
           :map minibuffer-local-completion-map
           ([escape] . abort-recursive-edit)
           :map minibuffer-local-must-match-map
           ([escape] . abort-recursive-edit)
           :map minibuffer-local-isearch-map
           ([escape] . abort-recursive-edit))
    :custom
    (completion-auto-help t)
    (completion-show-help nil)
    (completion-cycle-threshold nil)
    (completion-auto-select 'second-tab)
    (enable-recursive-minibuffers t)
    (minibuffer-depth-indicate-mode t)
    (minibuffer-default-prompt-format " [%s]")
    (minibuffer-electric-default-mode t)
    (minibuffer-completion-auto-choose nil)
    (minibuffer-follows-selected-frame nil)
    (completion-ignore-case t)
    (read-buffer-completion-ignore-case t)
    (read-file-name-completion-ignore-case t)
    (completion-styles '(basic partial-completion substring flex))
    (completion-category-overrides
     '((buffer (styles . (flex)))
       (imenu (styles . (substring)))))
    (completions-format 'one-column)
    (completions-max-height 13)
    (completions-detailed t))
#+end_src

*** Dired

#+begin_src emacs-lisp
  (use-package dired
    :ensure nil
    :bind (:map dired-mode-map
           ("C-c C-p" . wdired-change-to-wdired-mode))
    :config
    (setq dired-dwim-target t)
    (setq dired-recursive-deletes 'always
          dired-recursive-copies 'always)
    (setq dired-listing-switches "-alh --group-directories-first")

    (use-package diredfl
      :ensure t
      :hook (dired-mode . diredfl-mode))

    (use-package nerd-icons-dired
      :ensure t
      :diminish
      :custom-face
      (nerd-icons-dired-dir-face ((t (:inherit nerd-icons-dsilver :foreground unspecified))))
      :hook (dired-mode . nerd-icons-dired-mode)))

  (use-package fd-dired
    :ensure t)
#+end_src

*** Bookmark

#+begin_src emacs-lisp
  (use-package bookmark
    :ensure nil
    :config
    (setq bookmark-default-file (locate-user-emacs-file "etc/bookmarks"))
    (with-no-warnings
      (defun my/bookmark-bmenu--revert ()
        "Re-populate tabulated-list-entries."
        (let (entries)
          (dolist (full-record (bookmark-maybe-sort-alist))
            (let* ((name (bookmark-name-from-record full-record))
                  
                 (annotation (bookmark-get-annotation full-record))
                 (location (bookmark-location full-record))
                 (file (file-name-nondirectory location))
                 (type (let ((fmt "%-8.8s"))
                         (cond ((null location)
                                (propertize (format fmt "NOFILE") 'face 'warning))
                               ((file-remote-p location)
                                (propertize (format fmt "REMOTE") 'face 'mode-line-buffer-id))
                               ((not (file-exists-p location))
                                (propertize (format fmt "NOTFOUND") 'face 'error))
                               ((file-directory-p location)
                                (propertize (format fmt "DIRED") 'face 'warning))
                               (t (propertize (format fmt "FILE") 'face 'success))))))
            (push (list
                   full-record
                   `[,(if (and annotation (not (string-equal annotation "")))
                          "*" "")
                     ,icon
                     ,(if (display-mouse-p)
                          (propertize name
                                      'font-lock-face 'bookmark-menu-bookmark
                                      'mouse-face 'highlight
                                      'follow-link t
                                      'help-echo "mouse-2: go to this bookmark in other window")
                        name)
                     ,type
                     ,@(if bookmark-bmenu-toggle-filenames
                           (list (propertize location 'face 'completions-annotations)))])
                  entries)))
        (tabulated-list-init-header)
        (setq tabulated-list-entries entries))
      (tabulated-list-print t))
    (advice-add #'bookmark-bmenu--revert :override #'my/bookmark-bmenu--revert)

    (defun my/bookmark-bmenu-list ()
      "Display a list of existing bookmarks."
      (interactive)
      (bookmark-maybe-load-default-file)
      (let ((buf (get-buffer-create bookmark-bmenu-buffer)))
        (if (called-interactively-p 'interactive)
            (pop-to-buffer buf)
          (set-buffer buf)))
      (bookmark-bmenu-mode)
      (bookmark-bmenu--revert))
    (advice-add #'bookmark-bmenu-list :override #'my/bookmark-bmenu-list)

    (define-derived-mode bookmark-bmenu-mode tabulated-list-mode "Bookmark Menu"
      (setq truncate-lines t)
      (setq buffer-read-only t)
      (setq tabulated-list-format
            `[("" 1)
              ("" ,(if (icons-displayable-p) 2 0))
              ("Bookmark" ,bookmark-bmenu-file-column bookmark-bmenu--name-predicate)
              ("Type" 9)
              ,@(if bookmark-bmenu-toggle-filenames
                    '(("File" 0 bookmark-bmenu--file-predicate)))])
      (setq tabulated-list-padding bookmark-bmenu-marks-width)
      (setq tabulated-list-sort-key '("Bookmark" . nil))
      (add-hook 'tabulated-list-revert-hook #'bookmark-bmenu--revert nil t)
      (setq revert-buffer-function #'bookmark-bmenu--revert)
      (tabulated-list-init-header))))
#+end_src

** ç¬”è®°ç³»ç»Ÿ
*** å…¨å±€å¸¸é‡ä¸è·¯å¾„

#+begin_src emacs-lisp
(defvar my/org-root "C:/Users/wei/Documents/org/agenda/"
  "Agenda æ–‡ä»¶çš„æ ¹ç›®å½•ã€‚")

(defvar my/denote-root "C:/Users/wei/Documents/org/notes/"
  "Denote ç¬”è®°å­˜å‚¨ç›®å½•ã€‚")

(defun my/normalize-path (path)
  "å°†Windowsè·¯å¾„è½¬æ¢ä¸ºEmacså†…éƒ¨è¡¨ç¤ºã€‚"
  (replace-regexp-in-string "\\\\" "/" path))

(setq my/org-root (my/normalize-path my/org-root)
      my/denote-root (my/normalize-path my/denote-root))

(defun my/ensure-directories-exist ()
  "ç¡®ä¿æ‰€æœ‰å¿…è¦çš„ç›®å½•éƒ½å­˜åœ¨ã€‚"
  (dolist (dir (list my/org-root my/denote-root))
    (let ((normalized-dir (file-name-as-directory dir)))
      (unless (file-directory-p normalized-dir)
        (make-directory normalized-dir t)
        (message "å·²åˆ›å»ºç›®å½•: %s" normalized-dir)))))

(add-hook 'after-init-hook #'my/ensure-directories-exist)
#+end_src

*** Org æ€§èƒ½ä¼˜åŒ–

#+begin_src emacs-lisp
  (defvar my/org-optimized-p nil
    "æ ‡è®°æ˜¯å¦å·²ç»ä¼˜åŒ–è¿‡Orgè§£æã€‚")

  (defun my/org-optimize-emphasis-parsing ()
    "ä¸€æ¬¡æ€§è®¾ç½® emphasis è§£æã€‚"
    (unless my/org-optimized-p
      (setq org-emphasis-regexp-components '("-[:space:]('\"{[:nonascii:]"
                                             "-[:space:].,:!?;'\")}\\[[:nonascii:]"
                                             "[:space:]"
                                             "."
                                             1))
      (setq org-match-substring-regexp
            (concat "\\([0-9a-zA-ZÎ±-Î³Î‘-Î©]\\)\\([_^]\\)\\("
                    "\\(?:" (org-create-multibrace-regexp "{" "}" org-match-sexp-depth) "\\)"
                    "\\|"
                    "\\(?:" (org-create-multibrace-regexp "(" ")" org-match-sexp-depth) "\\)"
                    "\\|"
                    "\\(?:\\*\\|[+-]?[[:alnum:].,\\]*[[:alnum:]]\\)\\)"))
      (org-set-emph-re 'org-emphasis-regexp-components org-emphasis-regexp-components)
      (org-element-update-syntax)
      (setq my/org-optimized-p t)))
#+end_src

*** Org-mode æ ¸å¿ƒé…ç½®

#+begin_src emacs-lisp
  (setq org-persist-directory (locate-user-emacs-file "etc/org-persist/"))
  (setq org-cite-export-processors
        '((html csl)
          (latex biblatex)))
  (use-package org
    :diminish
    :defer t
    :mode ("\\.org\\'" . org-mode)
    :hook ((org-mode . (lambda ()
                         (lazytab-mode 1)
                         (visual-line-mode 1)
                         (turn-on-org-cdlatex)
                         (yas-minor-mode 1)
                         (my/add-latex-in-org-mode-expansions)
                         (my/org-indent-setup)))
           (org-babel-after-execute . org-redisplay-inline-images))
    :bind (("C-c a" . org-agenda)
           :map org-mode-map
           ("C-c i" . yank-media)
           ("C-c l" . org-store-link))
    :custom
    (org-directory my/org-root)
    (org-hide-emphasis-markers t)
    (org-startup-indented t)
    (org-fontify-todo-headline nil)
    (org-fontify-done-headline t)
    (org-fontify-whole-heading-line t)
    (org-fontify-quote-and-verse-blocks t)
    (org-ellipsis " [+]")
    (org-list-demote-modify-bullet
     '(("+" . "-") ("1." . "a.") ("-" . "+")))
    (org-image-actual-width '(600))
    (org-preview-latex-image-directory
     (expand-file-name "orgltxpng/" (getenv "TEMP")))
    (org-latex-preview-numbered t)
    (org-imenu-depth 4)
    (org-clone-delete-id t)
    (org-use-sub-superscripts '{})
    (org-yank-adjusted-subtrees t)
    (org-ctrl-k-protect-subtree 'error)
    (org-fold-catch-invisible-edits 'show-and-error)
    (org-return-follows-link nil)
    (org-todo-keywords
     '((sequence "TODO(t)" "HOLD(h!)" "WIP(i!)" "WAIT(w!)" "|" "DONE(d!)" "CANCELLED(c@/!)")))
    (org-todo-keyword-faces
     '(("TODO" :foreground "#7c7c75" :weight bold)
       ("HOLD" :foreground "#feb24c" :weight bold)
       ("WIP" :foreground "#0098dd" :weight bold)
       ("WAIT" :foreground "#9f7efe" :weight bold)
       ("DONE" :foreground "#50a14f" :weight bold)
       ("CANCELLED" :foreground "#ff6480" :weight bold)))
    (org-use-fast-todo-selection 'expert)
    (org-enforce-todo-dependencies t)
    (org-enforce-todo-checkbox-dependencies t)
    (org-priority-faces
     '((?A :foreground "red") (?B :foreground "orange") (?C :foreground "yellow")))
    (org-global-properties
     '(("EFFORT_ALL" . "0:15 0:30 0:45 1:00 2:00 3:00 4:00 5:00 6:00 7:00 8:00")
       ("APPT_WARNTIME_ALL" . "0 5 10 15 20 25 30 45 60")
       ("STYLE_ALL" . "habit")))
    (org-columns-default-format "%25ITEM %TODO %SCHEDULED %DEADLINE %3PRIORITY %TAGS %CLOCKSUM %EFFORT{:}")
    (org-log-repeat 'time)
    (org-closed-keep-when-no-todo t)
    (org-archive-location "%s_archive::datetree/")
    (org-refile-use-cache nil)
    (org-refile-targets '((org-agenda-files . (:maxlevel . 6))))
    (org-refile-use-outline-path 'file)
    (org-outline-path-complete-in-steps nil)
    (org-refile-allow-creating-parent-nodes 'confirm)
    (org-goto-auto-isearch nil)
    (org-goto-interface 'outline-path-completion)
    (org-use-fast-tag-selection t)
    (org-fast-tag-selection-single-key t)
    (org-id-link-to-org-use-id 'create-if-interactive-and-no-custom-id)
    :config
    (setq org-yank-image-save-method "file")
    (defun my/org-yank-image-file-name ()
      "ç”Ÿæˆå›¾ç‰‡ä¿å­˜è·¯å¾„"
      (unless (buffer-file-name)
        (error "è¯·å…ˆä¿å­˜å½“å‰ org æ–‡ä»¶"))

      (let* ((heading (or (org-get-heading t t t t) "default"))
             (clean-heading (replace-regexp-in-string "[^a-zA-Z0-9\u4e00-\u9fa5-]+" "_" heading))
             (timestamp (format-time-string "%Y%m%d_%H%M%S"))
             (base-dir (file-name-directory (buffer-file-name)))
             (dir (expand-file-name (concat "Figure/" clean-heading "/") base-dir))
             (filename (concat timestamp ".png"))
             (full-path (expand-file-name filename dir)))

        (make-directory dir t)
        (message "ä¿å­˜å›¾ç‰‡åˆ°: %s" full-path)
        full-path))

    (setq org-yank-image-file-name-function #'my/org-yank-image-file-name)

    ;; ä¿®æ­£ç‰ˆï¼šæ­£ç¡®æ’å…¥æè¿°
    (defun my/org-yank-image-add-description ()
      "åœ¨ç²˜è´´å›¾ç‰‡åæ·»åŠ æè¿°"
      (when (eq major-mode 'org-mode)
        (save-excursion
          ;; æ‰¾åˆ°åˆšæ’å…¥çš„é“¾æ¥
          (when (re-search-backward "\\[\\[file:\\([^]]+\\)\\]\\]" (line-beginning-position) t)
            (let* ((file-path (match-string 1))
                   (description (read-string "å›¾ç‰‡æè¿°: ")))
              (when (not (string-empty-p description))
                ;; æ›¿æ¢æ•´ä¸ªé“¾æ¥ï¼Œæ·»åŠ æè¿°
                (replace-match (format "[[file:%s][%s]]" file-path description) t t)))))))

    ;; ç§»é™¤æ—§çš„ adviceï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    (advice-remove 'yank-media #'my/org-yank-image-add-description)

    ;; æ·»åŠ æ–°çš„ advice
    (advice-add 'yank-media :after
                (lambda (&rest _)
                  (when (eq major-mode 'org-mode)
                    (run-with-idle-timer 0.1 nil #'my/org-yank-image-add-description))))


    (defun my/add-latex-in-org-mode-expansions ()
      (modify-syntax-entry ?\\ "\\" org-mode-syntax-table)
      (setq paragraph-start (concat paragraph-start "\\|\\\\end{\\([A-Za-z0-9*]+\\)}"))
      (setq-local beginning-of-defun-function 'my/org-beginning-of-defun)
      (with-eval-after-load 'expand-region
        (set (make-local-variable 'my/try-expand-list)
             (append (cl-set-difference my/try-expand-list
                                        '(my/mark-method-call
                                          my/mark-inside-pairs
                                          my/mark-outside-pairs))
                     '(LaTeX-mark-environment
                       my/mark-LaTeX-inside-math
                       my/mark-latex-inside-pairs
                       my/mark-latex-outside-pairs
                       my/mark-LaTeX-math)))))

    (defun my/org-indent-setup ()
      (setq-local show-paren-mode nil))
    (my/org-optimize-emphasis-parsing))
#+end_src

#+RESULTS:
: org-store-link

*** Denote ç¬”è®°ç³»ç»Ÿ

#+begin_src emacs-lisp
  (use-package denote
    :ensure t
    :defer t
    :custom
    (denote-file-type 'org)
    (denote-directory my/denote-root)
    (denote-signature-prompt nil)
    (denote-known-keywords
     '("literature" "research" "thesis"
       "project" "work" "meeting" "report"
       "journal" "idea" "reading" "personal"
       "todo" "draft" "archive"))
    (denote-infer-keywords t)
    (denote-sort-keywords t)
    (denote-prompts '(title keywords template))
    (denote-save-buffers nil)
    (denote-rename-confirmations '(rewrite-front-matter modify-file-name))
    (denote-link-fontify t)
    (denote-date-prompt-use-org-read-date t)
    (denote-date-format "%Y-%m-%d %a")
    :hook ((org-mode . denote-fontify-links-mode-maybe)
           (dired-mode . denote-dired-mode-in-directories))
    :bind (("C-c n n" . denote)
           ("C-c n R" . denote-rename-file)
           ("C-c n r" . denote-rename-file-keywords)
           ("C-c n d" . denote-dired-rename-files)
           ("C-c n b" . denote-backlinks)
           ("C-c n a" . denote-add-links)
           :map dired-mode-map
           ("C-c C-d C-r" . denote-dired-rename-files)
           ("C-c C-d C-i" . denote-dired-link-marked-notes))
    :config
    (denote-rename-buffer-mode 1)
    (setq denote-templates
          `((æŠ¥å‘Š . "* æ‘˜è¦\n\n* å¼•è¨€\n\n* ä¸»ä½“\n** æ–¹æ³•\n** ç»“æœ\n\n* ç»“è®º\n\n* å‚è€ƒæ–‡çŒ®\n\n")
            (æ—¥è®° . ,(concat "* ä»Šæ—¥æ€»ç»“"
                                "\n\n"
                                "* å¾…åŠäº‹é¡¹"
                                "\n** å·²å®Œæˆ"
                                "\n** æœªå®Œæˆ"
                                "\n\n"
                                "* æ€è€ƒä¸æ„Ÿæ‚Ÿ"
                                "\n\n"))
            (æ–‡çŒ® . ,(concat "* æ–‡çŒ®ä¿¡æ¯"
                                   "\n** ä½œè€…"
                                   "\n** å‘è¡¨æ—¶é—´"
                                   "\n** æœŸåˆŠ/ä¼šè®®"
                                   "\n\n"
                                   "* ä¸»è¦å†…å®¹"
                                   "\n\n"
                                   "* å…³é”®è§‚ç‚¹"
                                   "\n\n"
                                   "* æ‰¹åˆ¤æ€§æ€è€ƒ"
                                   "\n\n"
                                   "* ä¸å·²æœ‰ç¬”è®°çš„å…³è”"
                                   "\n\n"))
            (è‰ç¨¿ . ,(concat "* å¤§çº²"
                              "\n\n"
                              "* åˆç¨¿"
                              "\n\n"
                              "* ä¿®æ”¹è®°å½•"
                              "\n\n")))))

  (use-package consult-denote
    :ensure t
    :after (consult denote)
    :bind (("C-c n f" . consult-denote-find)
         ("C-c n l" . consult-denote-link)
         ("C-c n g" . consult-denote-grep))
    :config
    (setq consult-denote-grep-command #'consult-ripgrep
          denote-consult-directory denote-directory))
#+end_src

*** Org Agenda é…ç½®

#+begin_src emacs-lisp

(defvar my/org-projects-dir (expand-file-name "projects/" my/org-root))
(defvar my/org-work-dir (expand-file-name "work/" my/org-root))
(defvar my/org-personal-dir (expand-file-name "personal/" my/org-root))

(defvar my/org-agenda-files-cache nil
  "ç¼“å­˜çš„ agenda æ–‡ä»¶åˆ—è¡¨")
(defvar my/org-agenda-files-last-check 0
  "ä¸Šæ¬¡æ£€æŸ¥çš„æ—¶é—´æˆ³")

(defun my/org-auto-collect-agenda-files (&optional force-refresh)
  "è‡ªåŠ¨æ”¶é›†æ‰€æœ‰å­ç›®å½•ä¸­çš„ Org æ–‡ä»¶ï¼ˆå¸¦ç¼“å­˜ï¼‰"
  (let ((now (float-time))
        (cache-timeout 300))
    (when (or force-refresh
              (null my/org-agenda-files-cache)
              (> (- now my/org-agenda-files-last-check) cache-timeout))
      (setq my/org-agenda-files-cache
            (delete-dups
             (append
              (when (file-directory-p my/org-projects-dir)
                (directory-files-recursively my/org-projects-dir "\\.org$"))
              (when (file-directory-p my/org-work-dir)
                (directory-files-recursively my/org-work-dir "\\.org$"))
              (when (file-directory-p my/org-personal-dir)
                (directory-files-recursively my/org-personal-dir "\\.org$"))
              (let ((inbox (expand-file-name "inbox.org" my/org-root)))
                (when (file-exists-p inbox) (list inbox))))))
      (setq my/org-agenda-files-last-check now))
    my/org-agenda-files-cache))

;; ========== å…³é”®ä¼˜åŒ–: åªåœ¨çœŸæ­£æ‰“å¼€ agenda æ—¶æ‰«æ ==========
(with-eval-after-load 'org-agenda
  (setq org-agenda-files nil)  ;; å¯åŠ¨æ—¶ä¸è®¾ç½®
  
  (defun my/org-agenda-prepare (&rest _)
    "å»¶è¿ŸåŠ è½½ agenda æ–‡ä»¶åˆ—è¡¨"
    (unless org-agenda-files
      (setq org-agenda-files (my/org-auto-collect-agenda-files))))
  
  (advice-add 'org-agenda :before #'my/org-agenda-prepare)
  
  ;; Agenda æ˜¾ç¤ºè®¾ç½®ï¼ˆä¿æŒåŸæ ·ï¼‰
  (setq org-agenda-span 'week
        org-agenda-start-day nil
        org-agenda-window-setup 'current-window
        org-agenda-include-deadlines t
        org-agenda-show-all-dates nil
        org-agenda-block-separator ?â”€
        org-agenda-time-grid
        '((daily today require-timed)
          (800 1000 1200 1400 1600 1800 2000)
          " â”„â”„â”„â”„â”„ " "â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„")
        org-agenda-current-time-string
        "â­  now â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        org-agenda-prefix-format
        '((agenda . " %i %-12:c %t")
          (todo . " %i %-12:c")
          (tags . " %i %-12:c")
          (search . " %i %-12:c"))
        org-agenda-sorting-strategy
        '((agenda time-up priority-down category-keep)
          (todo priority-down category-keep)
          (tags priority-down category-keep)
          (search category-keep))))

#+end_src

*** Org Capture

#+begin_src emacs-lisp
  (defvar my/org-capture-files
    '(("inbox" . "inbox.org")
      ("ideas" . "ideas.org")
      ("notes" . "notes.org")))

  (defun my/create-org-capture-file (name)
    "åˆ›å»ºæŒ‡å®šåç§°çš„æ•è·æ–‡ä»¶ã€‚"
    (let ((file (expand-file-name name my/org-root)))
      (unless (file-exists-p file)
        (with-temp-file file
          (insert (format "#+TITLE: %s\n#+CREATED: %s\n\n"
                          (file-name-sans-extension name)
                          (format-time-string "%Y-%m-%d %a %H:%M"))))
        (message "å·²åˆ›å»ºæ•è·æ–‡ä»¶: %s" (file-relative-name file my/org-root)))
      file))

  (defun my/ensure-capture-files ()
    "ç¡®ä¿æ‰€æœ‰æ•è·æ¨¡æ¿æ–‡ä»¶éƒ½å­˜åœ¨ã€‚"
    (dolist (file-pair my/org-capture-files)
      (my/create-org-capture-file (cdr file-pair))))

 (with-eval-after-load 'org-capture
  (my/ensure-capture-files))

  (defun my/get-capture-file (key)
    "æ ¹æ®KEYè·å–å¯¹åº”çš„æ•è·æ–‡ä»¶è·¯å¾„ã€‚"
    (let ((file-name (alist-get key my/org-capture-files nil nil #'string=)))
      (when file-name
        (expand-file-name file-name my/org-root))))

  (defun my/org-capture-setup ()
    "é…ç½® capture ç¼“å†²åŒºç¯å¢ƒã€‚"
    (setq-local org-complete-tags-always-offer-all-agenda-tags t)
    (visual-line-mode -1)
    (auto-fill-mode -1))

  (defun my/org-capture-selection-or-block ()
    "æ ¹æ®é€‰ä¸­å†…å®¹è¿”å›é€‚å½“æ ¼å¼ã€‚"
    (with-current-buffer (org-capture-get :original-buffer)
      (let ((content (plist-get org-store-link-plist :initial))
            (src-mode (replace-regexp-in-string "-mode$" "" (symbol-name major-mode)))
            (is-code (derived-mode-p 'prog-mode)))
        (if (string-empty-p (or content ""))
            ""
          (if is-code
              (format "\n#+begin_src %s\n%s\n#+end_src\n" src-mode content)
            (format "\n#+begin_quote\n%s\n#+end_quote\n" content))))))

  (defun my/org-capture-link-format ()
    "æ ¼å¼åŒ–é“¾æ¥æˆ–æ ‡æ³¨ä¿¡æ¯ã€‚"
    (with-current-buffer (org-capture-get :original-buffer)
      (let* ((annotation (plist-get org-store-link-plist :annotation))
             (file (buffer-file-name)))
        (cond
         ((string-empty-p (or annotation "")) "")
         ((eq major-mode 'org-mode)
          (concat "- reference :: "
                  (replace-regexp-in-string ".*::\\s-*\\([^]]+\\)\\s-*\\(.*\\)" "\\1" annotation)))
         (file
          (format "- reference :: %s[[%s]]" annotation (file-name-nondirectory file)))
         (t (format "- reference :: %s" annotation))))))

  (use-package org-capture
    :bind ("C-c c" . org-capture)
    :hook (org-capture-mode . my/org-capture-setup)
    :config
    (setq org-capture-templates
          `(("t" "Todo" entry (file ,(my/get-capture-file "inbox"))
             "* TODO %?\n%U\n%i\n"
             :empty-lines 1)
            ("n" "Notes" entry (file+headline ,(my/get-capture-file "notes") "Notes")
             "* %?\n%(my/org-capture-selection-or-block)\n%(my/org-capture-link-format)\n%U"
             :prepend t :empty-lines 1)
            ("i" "Idea" entry (file+headline ,(my/get-capture-file "ideas") "Ideas")
             "* %^{Title}\n%?\n%(my/org-capture-selection-or-block)\n%(my/org-capture-link-format)\n%U"
             :prepend t :empty-lines 1)))

    (defun my/org-capture-refresh-agenda (&rest _)
      "æ•è·å®Œæˆåè‡ªåŠ¨åˆ·æ–° agendaã€‚"
      (when (get-buffer "*Org Agenda*")
        (with-current-buffer "*Org Agenda*"
          (org-agenda-redo))))

    (advice-add 'org-capture-finalize :after #'my/org-capture-refresh-agenda))
#+end_src

*** Org Modern

#+begin_src emacs-lisp
(use-package org-modern
  :ensure t
  :defer t ; å®Œå…¨å»¶è¿ŸåŠ è½½ï¼Œç›´åˆ° org-mode è§¦å‘
  :hook
  ((org-mode . org-modern-mode)
   (org-agenda-finalize . org-modern-agenda))
  :config
  ;; è‡ªå®šä¹‰ faceï¼ˆæ ¹æ®ä¸»é¢˜è°ƒæ•´ï¼‰
  (custom-set-faces
   '(org-modern-tag ((t (:background "#3d4b5a" :foreground "#e5e9f0"
                         :height 0.8 :weight regular :box nil))))
   '(org-modern-priority ((t (:inherit org-priority :height 0.8))))
   '(org-modern-date-active ((t (:background "#4c566a" :foreground "#88c0d0"
                                 :height 0.8))))
   '(org-modern-time-active ((t (:background "#4c566a" :foreground "#88c0d0"
                                 :height 0.8)))))
  ;; è¡Œé—´è·ä¼˜åŒ–
  (defun my/org-modern-spacing ()
    (setq-local line-spacing 0.15))
  (add-hook 'org-modern-mode-hook #'my/org-modern-spacing)

  ;; ===== åˆå¹¶æ‰€æœ‰é…ç½®é¡¹ï¼Œå‡å°‘å¤šæ¬¡ setq =====
  (setq org-modern-star ["â—‰" "â—‹" "âœ¸" "âœ¿" "âœ¤" "âœœ"]
        ;; åˆ—è¡¨ç¾åŒ–
        org-modern-list '((43 . "â¤")    ;; +
                          (45 . "â€“")    ;; -
                          (42 . "â€¢"))  ;; *
        org-modern-block-name
        '((t . t)
          ("src" "Â»" "Â«")
          ("SRC" "Â»" "Â«")
          ("example" "Â»â€“" "â€“Â«")
          ("quote" "â" "â"))
        ;; å¤é€‰æ¡†ç¾åŒ–
        org-modern-checkbox
        '((88 . "â˜‘")   ;; [X]
          (45 . "â—«")   ;; [-]
          (32 . "â˜")) ;; [ ]
        ;; LaTeX ç‰‡æ®µç¾åŒ–
        org-modern-latex
        '((t . t)
          ("\\(" "â…" "â†")
          ("\\[" "âŸ¦" "âŸ§"))
        org-modern-table-horizontal 0.2
        org-modern-table t
        ;; æ ‡ç­¾ç¾åŒ–
        org-modern-tag t
        org-modern-priority t
        org-modern-timestamp t
        org-tags-column 0
        org-special-ctrl-a/e t
        org-insert-heading-respect-content t))

  ;;; Org ä»£ç å— LSP æ”¯æŒ

(use-package org-src
  :ensure nil
  :after org
  :hook (org-src-mode . my/org-src-format-before-save)
  :custom
  (org-src-window-setup 'current-window)
  (org-src-fontify-natively t)
  (org-src-tab-acts-natively t)
  (org-confirm-babel-evaluate nil)

  ;; ========== å…³é”®é…ç½® 1: ä¿ç•™ç¼©è¿› ==========
  (org-src-preserve-indentation t)
  (org-edit-src-content-indentation 0)
  :config
  (defun my/org-src-format-before-save ()
    "Org-src buffer ä¿å­˜å‰æ ¼å¼åŒ–ä»£ç "
    (when (and (derived-mode-p 'org-src-mode)
               (bound-and-true-p format-all-mode))
      (format-all-buffer)))
  :bind (:map org-mode-map
         ("C-c C-v C-e" . org-babel-execute-src-block)
         ("C-c C-v C-b" . org-babel-execute-buffer)
         ("C-c '" . org-edit-special)  ;; è¿›å…¥ org-src-mode
         :map org-src-mode-map
         ("C-c '" . org-edit-src-exit)  ;; é€€å‡º org-src-mode
         ("C-c C-k" . org-edit-src-abort))
  :custom-face
  ;; ä»£ç å—ä½¿ç”¨ç­‰å®½å­—ä½“
  (org-block ((t (:inherit fixed-pitch :background "#2e3440"))))
  (org-block-begin-line ((t (:inherit fixed-pitch :foreground "#616e88"
                             :background "#2e3440" :extend t))))
  (org-block-end-line ((t (:inherit org-block-begin-line)))))
(use-package org-faces
  :ensure nil
  :after org
  :custom-face
  (org-level-1 ((t (:height 1.3 :weight bold))))
  (org-level-2 ((t (:height 1.2 :weight semi-bold))))
  (org-level-3 ((t (:height 1.1 :weight normal))))
  (org-document-title ((t (:height 1.5 :weight bold :underline t)))))
#+end_src

*** Org Agenda æé†’ç³»ç»Ÿ
#+begin_src emacs-lisp
      (use-package appt
        :defer org-agenda
        :ensure nil
        :config
        (appt-activate 1)
        (setq appt-message-warning-time 15
              appt-display-interval 5
              appt-display-mode-line t
              appt-display-duration 60
              appt-audible t
              appt-display-diary nil
              appt-display-format 'window)
        
        (defun my/appt-display (min-to-app new-time msg)
          "è‡ªå®šä¹‰çš„æé†’æ˜¾ç¤ºå‡½æ•°ã€‚"
          (let ((title (format "ğŸ“… Agenda æé†’ (%såˆ†é’Ÿå)" min-to-app)))
            (appt-disp-window min-to-app new-time msg)
            (message "%s: %s" title msg)
            (when (featurep 'alert)
              (alert msg
                     :title title
                     :severity (cond
                                ((< (string-to-number min-to-app) 5) 'urgent)
                                ((< (string-to-number min-to-app) 10) 'high)
                                (t 'moderate))
                     :category 'org-agenda))))
        
        (setq appt-disp-window-function #'my/appt-display)
        
        (defun my/org-agenda-to-appt ()
          "ä» Org Agenda æ–‡ä»¶ä¸­æå–æ‰€æœ‰çº¦ä¼šã€‚"
          (interactive)
          (setq appt-time-msg-list nil)
          (org-agenda-to-appt t)
          (message "å·²ä» Agenda åŠ è½½ %d ä¸ªçº¦ä¼šæé†’" (length appt-time-msg-list)))
        
        (run-at-time nil 3600 'my/org-agenda-to-appt)
        (add-hook 'org-finalize-agenda-hook 'my/org-agenda-to-appt)
        (add-hook 'org-after-todo-state-change-hook 'my/org-agenda-to-appt)
        (add-hook 'org-after-tags-change-hook 'my/org-agenda-to-appt)
        (my/org-agenda-to-appt)
        (message "Org Agenda æé†’ç³»ç»Ÿå·²å¯ç”¨"))

      (use-package alert
        :ensure t
        :after appt
        :config
        (setq alert-default-style  'message))

      (defun my/show-today-appointments ()
        "æ˜¾ç¤ºä»Šå¤©æ‰€æœ‰çš„æé†’äº‹é¡¹ã€‚"
        (interactive)
        (if appt-time-msg-list
            (let ((buf (get-buffer-create "*Today's Appointments*")))
              (with-current-buffer buf
                (erase-buffer)
                (insert (propertize "ğŸ“… ä»Šæ—¥æé†’äº‹é¡¹\n\n"
                                    'face '(:height 1.3 :weight bold)))
                (dolist (appt appt-time-msg-list)
                  (insert (format "â° %s - %s\n"
                                  (car appt)
                                  (cadr appt))))
                (goto-char (point-min)))
              (display-buffer buf))
          (message "ä»Šå¤©æ²¡æœ‰æé†’äº‹é¡¹")))

      (defun my/clear-all-appointments ()
        "æ¸…é™¤æ‰€æœ‰æé†’äº‹é¡¹ã€‚"
        (interactive)
        (setq appt-time-msg-list nil)
        (message "å·²æ¸…é™¤æ‰€æœ‰æé†’"))
#+end_src

*** RefTeX

#+begin_src emacs-lisp
  (use-package reftex
    :defer t
    :hook ((LaTeX-mode . turn-on-reftex)
           (org-mode . turn-on-reftex))
    :config
    (setq reftex-plug-into-AUCTeX t
          reftex-cite-format 'biblatex))

  (use-package eldoc
    :after (lsp-mode)
    :bind
    (:map lsp-mode-map ("C-c C-d" . eldoc))
    :config
    (setq eldoc-idle-delay 0.1)

    ;; æ‰“å¼€ eldoc-buffer æ—¶å…³é—­ echo-area æ˜¾ç¤º, eldoc-buffer ä¼šè·Ÿéšæ˜¾ç¤º hover ä¿¡æ¯, å¦‚
    ;; å‡½æ•°ç­¾åã€‚
    (setq eldoc-echo-area-prefer-doc-buffer t)

    ;; åœ¨å±å¹•å³ä¾§æ˜¾ç¤º eldoc-buffer
    (add-to-list 'display-buffer-alist
                 '("^\\*eldoc.*\\*"
                   (display-buffer-reuse-window display-buffer-in-side-window)
                   (dedicated . t)
                   (side . right)
                   (inhibit-same-window . t)))

    ;; å°† minibuffer çª—å£é«˜åº¦è®¾ä¸º 1ï¼Œå¯ä»¥ç¡®ä¿åªæ˜¾ç¤ºä¸€è¡Œï¼ˆé»˜è®¤ä¸ºå°æ•°ï¼Œè¡¨ç¤º frame é«˜åº¦å 
    ;; æ¯”ï¼Œä¼šå¯¼è‡´æ˜¾ç¤ºå¤šè¡Œï¼‰ã€‚
    (setq max-mini-window-height 1)
    ;; ä¸º nil æ—¶åªå•è¡Œæ˜¾ç¤º eldoc ä¿¡æ¯.
    (setq eldoc-echo-area-use-multiline-p nil))
#+end_src 

*** Org -> Htmlå¯¼å‡º
#+BEGIN_SRC emacs-lisp
  ;; å¯¼å‡º HTML æ—¶è‡ªåŠ¨è¿½åŠ  org.css
  (with-eval-after-load 'ox-html
    (setq org-html-head-extra
          "<link rel=\"stylesheet\" type=\"text/css\" href=\"https://gongzhitaao.org/orgcss/org.css\"/>"))
#+END_SRC

** LaTeX é…ç½®
*** Org -> LaTeX å¯¼å‡º

#+begin_src emacs-lisp
(with-eval-after-load 'ox-latex
  (setq org-latex-pdf-process '("latexmk -xelatex -quiet -shell-escape -f %f"))
  (push '(
          "\\documentclass[lang=cn]{article}
                 [NO-DEFAULT-PACKAGES]
                 [PACKAGES]
                 [EXTRA]"
          ("\\section{%s}" . "\\section*{%s}")
          ("\\subsection{%s}" . "\\subsection*{%s}")
          ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
          ("\\paragraph{%s}" . "\\paragraph*{%s}")
          ("\\subparagraph{%s}" . "\\subparagraph*{%s}"))
        org-latex-classes))
#+end_src 

*** LaTeX Pretty Symbols

#+begin_src emacs-lisp
(add-hook 'prettify-symbols-mode-hook
          (defun prettify-symbols-latex-symbols ()
            "LaTeX ç¬¦å·ç¾åŒ–åˆ—è¡¨"
            (interactive)
            (setq-local prettify-symbols-alist '(("$" . 183)
                                                 ("\\alpha" . 945)
                                                 ("\\beta" . 946)
                                                 ("\\gamma" . 947)
                                                 ("\\delta" . 948)
                                                 ("\\epsilon" . 1013)
                                                 ("\\zeta" . 950)
                                                 ("\\eta" . 951)
                                                 ("\\theta" . 952)
                                                 ("\\iota" . 953)
                                                 ("\\kappa" . 954)
                                                 ("\\lambda" . 955)
                                                 ("\\mu" . 956)
                                                 ("\\nu" . 957)
                                                 ("\\xi" . 958)
                                                 ("\\pi" . 960)
                                                 ("\\rho" . 961)
                                                 ("\\sigma" . 963)
                                                 ("\\tau" . 964)
                                                 ("\\phi" . 981)
                                                 ("\\omega" . 969)
                                                 ("\\infty" . 8734)
                                                 ("\\int" . 8747)
                                                 ("\\sum" . 8721)
                                                 ("\\prod" . 8719)
                                                 ("\\leq" . 8804)
                                                 ("\\geq" . 8805)
                                                 ("\\in" . 8712)
                                                 ("\\subset" . 8834)
                                                 ("\\subseteq" . 8838)
                                                 ("\\supset" . 8835)
                                                 ("\\supseteq" . 8839)
                                                 ("\\cup" . 8746)
                                                 ("\\cap" . 8745)
                                                 ("\\emptyset" . 8709)
                                                 ("\\exists" . 8707)
                                                 ("\\forall" . 8704)
                                                 ("\\to" . 8594)
                                                 ("\\rightarrow" . 8594)
                                                 ("\\leftarrow" . 8592)
                                                 ("\\Rightarrow" . 8658)
                                                 ("\\Leftarrow" . 8656)
                                                 ("\\equiv" . 8801)
                                                 ("\\ne" . 8800)
                                                 ("\\approx" . 8776)
                                                 ("\\times" . 215)
                                                 ("\\cdot" . 8901)
                                                 ("\\partial" . 8706)
                                                 ("\\nabla" . 8711)))))
#+end_src

*** Lazytab (Org è¡¨æ ¼ + LaTeX)

#+begin_src emacs-lisp
(use-package lazytab
  :vc (:url "https://github.com/karthink/lazytab" :rev :newest)
  :bind (:map orgtbl-mode-map
         ("<tab>" . lazytab-org-table-next-field-maybe)
         ("TAB" . lazytab-org-table-next-field-maybe))
  :after cdlatex
  :config
  (add-hook 'cdlatex-tab-hook #'lazytab-cdlatex-or-orgtbl-next-field 90)
  (dolist (cmd '(("smat" "æ’å…¥ smallmatrix ç¯å¢ƒ"
                  "\\left( \\begin{smallmatrix} ? \\end{smallmatrix} \\right)"
                  lazytab-position-cursor-and-edit nil nil t)
                 ("bmat" "æ’å…¥ bmatrix ç¯å¢ƒ"
                  "\\begin{bmatrix} ? \\end{bmatrix}"
                  lazytab-position-cursor-and-edit nil nil t)
                 ("pmat" "æ’å…¥ pmatrix ç¯å¢ƒ"
                  "\\begin{pmatrix} ? \\end{pmatrix}"
                  lazytab-position-cursor-and-edit nil nil t)
                 ("tbl" "æ’å…¥è¡¨æ ¼"
                  "\\begin{table}\n\\centering ? \\caption{}\n\\end{table}\n"
                  lazytab-position-cursor-and-edit nil t nil)))
    (push cmd cdlatex-command-alist))
  (cdlatex-reset-mode))
#+end_src

*** AUCTeX

#+begin_src emacs-lisp
  (use-package latex
      :ensure auctex
      :mode ("\\.tex\\'" . LaTeX-mode)
      :hook ((LaTeX-mode . prettify-symbols-mode)
             (LaTeX-mode . my/latex-with-outline))
      :bind (:map LaTeX-mode-map
             ("C-S-e" . latex-math-from-calc)
             ([remap LaTeX-environment] . cdlatex-environment))
      :config
      (setq TeX-auto-save t
            TeX-parse-self t
            TeX-save-query nil
            TeX-show-help nil
            TeX-PDF-mode t
            TeX-source-correlate-mode t
            TeX-source-correlate-start-server t
            TeX-error-overview-open-after-TeX-run t
            TeX-debug-warnings nil
            TeX-source-correlate-method 'synctex
            TeX-engine 'xetex
            TeX-command-default "Latexmk (xelatex)")
      
      (with-eval-after-load 'tex
        (dolist (cmd '(("Latexmk (xelatex)" "latexmk -xelatex -interaction=nonstopmode -synctex=1 %s" TeX-run-TeX nil t :help "ä½¿ç”¨ latexmk (XeLaTeX) ç¼–è¯‘")
                       ("Latexmk Clean" "latexmk -c %s" TeX-run-command nil t :help "ä½¿ç”¨ latexmk æ¸…ç†è¾…åŠ©æ–‡ä»¶")))
          (push cmd TeX-command-list))
        (setq TeX-view-program-list
              '(("SumatraPDF"
                 "\"D:/Apps/Scoop/apps/SumatraPDF/current/SumatraPDF.exe\" -reuse-instance -forward-search \"%b\" %n \"%o\"")))
        (setq TeX-view-program-selection
              '((output-pdf "SumatraPDF"))))
      
      (defun my/latex-with-outline ()
        (add-to-list 'minor-mode-overriding-map-alist
                     `(outline-minor-mode . ,outline-minor-mode-map))
        (outline-minor-mode 1))
      
      (defun latex-math-from-calc ()
        "å¯¹å…‰æ ‡æ‰€åœ¨è¡Œçš„å†…å®¹æ‰§è¡Œ calc æ±‚å€¼"
        (interactive)
        (let ((calc-settings '(calc-language latex
                                             calc-prefer-frac t
                                             calc-angle-mode rad)))
          (if (region-active-p)
              (let* ((beg (region-beginning))
                     (end (region-end))
                     (string (buffer-substring-no-properties beg end)))
                (delete-region beg end)
                (insert (calc-eval (cons string calc-settings))))
            (let ((l (thing-at-point 'line)))
              (end-of-line 1)
              (kill-line 0)
              (insert (calc-eval (cons l calc-settings)))))))
      
      (add-hook 'LaTeX-mode-hook
                (lambda ()
                  (setq TeX-auto-untabify t
                        TeX-engine 'xetex
                        TeX-show-compilation t
                        TeX-save-query nil)
                  (TeX-global-PDF-mode t)
                  (imenu-add-menubar-index))))

    (use-package preview
      :after latex
      :hook (LaTeX-mode . preview-larger-previews)
      :config
      (defun preview-larger-previews ()
        (setq preview-scale-function
              (lambda () (* 1.25 (funcall (preview-scale-from-face)))))))
#+end_src

*** CDLatex

#+begin_src emacs-lisp
  (use-package cdlatex
    :ensure t
    :hook ((LaTeX-mode . turn-on-cdlatex)
           (cdlatex-tab . yas-expand)
           (cdlatex-tab . cdlatex-in-yas-field))
    :bind (:map cdlatex-mode-map
           ("<tab>" . cdlatex-tab))
    :config
    (with-eval-after-load 'yasnippet
      (define-key yas-keymap (kbd "<tab>") #'yas-next-field-or-cdlatex)
      (define-key yas-keymap (kbd "TAB") #'yas-next-field-or-cdlatex)
      
      (defun cdlatex-in-yas-field ()
        "åœ¨ Yas å­—æ®µä¸­æ£€æŸ¥å¹¶å¤„ç† cdlatex"
        (when-let* ((_ (overlayp yas--active-field-overlay))
                    (end (overlay-end yas--active-field-overlay)))
          (if (>= (point) end)
              (let ((s (thing-at-point 'sexp)))
                (unless (and s (assoc (substring-no-properties s)
                                      cdlatex-command-alist-comb))
                  (yas-next-field-or-maybe-expand)
                  t))
            (let (cdlatex-tab-hook minp)
              (setq minp (min (save-excursion (cdlatex-tab) (point))
                              (overlay-end yas--active-field-overlay)))
              (goto-char minp)
              t))))
      
      (defun yas-next-field-or-cdlatex ()
        "æ­£ç¡®å¤„ç† cdlatex æ¿€æ´»æ—¶è·³è½¬åˆ°ä¸‹ä¸€ä¸ª Yas å­—æ®µ"
        (interactive)
        (if (or (bound-and-true-p cdlatex-mode)
                (bound-and-true-p org-cdlatex-mode))
            (cdlatex-tab)
          (yas-next-field-or-maybe-expand)))))

  (use-package org-table
    :after cdlatex
    :bind (:map orgtbl-mode-map
           ("<tab>" . lazytab-org-table-next-field-maybe)
           ("TAB" . lazytab-org-table-next-field-maybe))
    :hook (cdlatex-tab . lazytab-cdlatex-or-orgtbl-next-field))
#+end_src

*** Consult-RefTeX

#+begin_src emacs-lisp
(use-package consult-reftex
  :vc (consult-reftex :url "https://github.com/karthink/consult-reftex" :rev :newest)
  :after (reftex consult embark)
  :bind (:map reftex-mode-map
         ("C-c )" . consult-reftex-insert-reference)
         ("C-c M-." . consult-reftex-goto-label)
         :map org-mode-map
         ("C-c (" . consult-reftex-goto-label)
         ("C-c )" . consult-reftex-insert-reference))
  :config
  (with-eval-after-load 'embark
    (defun consult-reftex--key-finder ()
      (when (and
             (or (derived-mode-p 'LaTeX-mode)
                 (derived-mode-p 'org-mode))
             (cl-intersection
              '(font-lock-constant-face TeX-fold-unfolded-face)
              (ensure-list (get-char-property (point) 'face))))
        (save-excursion
          (text-property-search-backward
           'face 'font-lock-constant-face
           (lambda (val prop) (memq val (ensure-list prop))))
          (when (looking-back "\\(?:la\\)?\\(?:ref\\|bel\\){" (- (point) 5))
            (backward-char 1)
            (let* ((start (1+ (point)))
                   (end (progn (forward-list)
                               (1- (point)))))
              `(reftex-label
                ,(buffer-substring-no-properties start end)
                ,start . ,end))))))
    (cl-pushnew 'consult-reftex--key-finder embark-target-finders))
  (setq consult-reftex-preview-function
        #'consult-reftex-preview-make-window
        consult-reftex-preferred-style-order
        '("\\cref" "\\eqref" "\\ref"))
  (consult-customize consult-reftex-insert-reference
                     :preview-key (list :debounce 0.3 'any)))
#+end_src

** ç¼–ç¨‹è¯­è¨€
*** Org-babelé…ç½®æ–‡ä»¶
#+begin_src emacs-lisp
(with-eval-after-load 'org
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((python . t))))

(use-package elisp-mode
  :ensure nil
  :bind (:map emacs-lisp-mode-map
         ("C-c C-x" . ielm)
         ("C-c C-c" . eval-defun)
         ("C-c C-b" . eval-buffer))
  :config
  (defun my/lisp-indent-function (indent-point state)
    "æ”¹è¿›çš„ Lisp ç¼©è¿›å‡½æ•°"
    (let ((normal-indent (current-column))
          (orig-point (point)))
      (goto-char (1+ (elt state 1)))
      (parse-partial-sexp (point) calculate-lisp-indent-last-sexp 0 t)
      (cond
       ((and (elt state 2)
             (or (not (looking-at "\\sw\\|\\s_"))
                 (looking-at ":")))
        (unless (> (save-excursion (forward-line 1) (point))
                   calculate-lisp-indent-last-sexp)
          (goto-char calculate-lisp-indent-last-sexp)
          (beginning-of-line)
          (parse-partial-sexp (point) calculate-lisp-indent-last-sexp 0 t))
        (backward-prefix-chars)
        (current-column))
       ((and (save-excursion
               (goto-char indent-point)
               (skip-syntax-forward " ")
               (not (looking-at ":")))
             (save-excursion
               (goto-char orig-point)
               (looking-at ":")))
        (save-excursion
          (goto-char (+ 2 (elt state 1)))
          (current-column)))
       (t
        (let* ((function (buffer-substring (point)
                                           (progn (forward-sexp 1) (point))))
               (method (or (function-get (intern-soft function)
                                         'lisp-indent-function)
                           (get (intern-soft function) 'lisp-indent-hook))))
          (cond ((or (eq method 'defun)
                     (and (null method)
                          (length> function 3)
                          (string-match "\\`def" function)))
                 (lisp-indent-defform state indent-point))
                ((integerp method)
                 (lisp-indent-specform method state indent-point normal-indent))
                (method
                 (funcall method indent-point state))))))))
  
  (add-hook 'emacs-lisp-mode-hook
            (lambda () (setq-local lisp-indent-function #'my/lisp-indent-function)))
  
  (add-hook 'help-mode-hook #'cursor-sensor-mode)
  
  (defun function-advices (function)
    "è¿”å› FUNCTION çš„æ‰€æœ‰ advice"
    (let ((flist (indirect-function function)) advices)
      (while (advice--p flist)
        (push (advice--car flist) advices)
        (setq flist (advice--cdr flist)))
      (nreverse advices)))
  
  (defun add-remove-advice-button (advice function)
    "ä¸º ADVICE æ·»åŠ ç§»é™¤æŒ‰é’®"
    (when (and (functionp advice) (functionp function))
      (let ((inhibit-read-only t)
            (msg (format "Remove advice `%s'" advice)))
        (insert "\t")
        (insert-button
         "Remove"
         'face 'custom-button
         'cursor-sensor-functions `((lambda (&rest _) (message ,msg)))
         'help-echo msg
         'action (lambda (_)
                   (when (yes-or-no-p msg)
                     (message "%s from function `%s'" msg function)
                     (advice-remove function advice)
                     (if (eq major-mode 'helpful-mode)
                         (helpful-update)
                       (revert-buffer nil t))))
         'follow-link t))))
  
  (defun add-button-to-remove-advice (buffer-or-name function)
    "åœ¨å¸®åŠ©ç¼“å†²åŒºä¸­æ·»åŠ ç§»é™¤ advice çš„æŒ‰é’®"
    (with-current-buffer buffer-or-name
      (save-excursion
        (goto-char (point-min))
        (let ((ad-list (function-advices function)))
          (while (re-search-forward
                  "^\\(?:This function has \\)?:[-a-z]+ advice: \\(.+\\)$" nil t)
            (when-let* ((advice (pop ad-list)))
              (add-remove-advice-button advice function)))))))
  
  (define-advice describe-function-1 (:after (function) advice-remove-button)
    (add-button-to-remove-advice (help-buffer) function))
  
  (with-eval-after-load 'helpful
    (define-advice helpful-update (:after () advice-remove-button)
      (when helpful--callable-p
        (add-button-to-remove-advice (current-buffer) helpful--sym))))
  
  (defun remove-hook-at-point ()
    "åœ¨ *Help* ç¼“å†²åŒºä¸­ç§»é™¤å…‰æ ‡å¤„çš„ hook"
    (interactive)
    (unless (memq major-mode '(help-mode helpful-mode))
      (error "ä»…é€‚ç”¨äº help-mode æˆ– helpful-mode"))
    (let ((orig-point (point)))
      (save-excursion
        (when-let* ((hook (progn (goto-char (point-min)) (symbol-at-point)))
                    (func (when (and (or (re-search-forward "^Value:?[\s|\n]" nil t)
                                         (goto-char orig-point))
                                     (sexp-at-point))
                            (end-of-sexp)
                            (backward-char 1)
                            (catch 'break
                              (while t
                                (condition-case nil
                                    (backward-sexp)
                                  (scan-error (throw 'break nil)))
                                (when-let* ((bounds (bounds-of-thing-at-point 'sexp)))
                                  (when (<= (car bounds) orig-point (cdr bounds))
                                    (throw 'break (sexp-at-point)))))))))
          (when (yes-or-no-p (format "Remove %s from %s? " func hook))
            (remove-hook hook func)
            (if (eq major-mode 'helpful-mode)
                (helpful-update)
              (revert-buffer nil t)))))))
  
  (bind-key "r" #'remove-hook-at-point help-mode-map))

(use-package macrostep
  :ensure t
  :bind ((:map emacs-lisp-mode-map ("C-c e" . macrostep-expand))
         (:map lisp-interaction-mode-map ("C-c e" . macrostep-expand))))

(use-package helpful
  :ensure t
  :bind (([remap describe-function] . helpful-callable)
         ([remap describe-command] . helpful-command)
         ([remap describe-variable] . helpful-variable)
         ([remap describe-key] . helpful-key)
         ([remap describe-symbol] . helpful-symbol)
         :map emacs-lisp-mode-map ("C-c C-d" . helpful-at-point)
         :map lisp-interaction-mode-map ("C-c C-d" . helpful-at-point)
         :map helpful-mode-map ("r" . remove-hook-at-point))
  :hook (helpful-mode . cursor-sensor-mode)
  :init
  (with-eval-after-load 'apropos
    (dolist (fun-bt '(apropos-function apropos-macro apropos-command))
      (button-type-put fun-bt 'action
                       (lambda (button)
                         (helpful-callable (button-get button 'apropos-symbol)))))
    (dolist (var-bt '(apropos-variable apropos-user-option))
      (button-type-put var-bt 'action
                       (lambda (button)
                         (helpful-variable (button-get button 'apropos-symbol))))))
  :config
  (defun my/helpful--navigate (button)
    "å¯¼èˆªåˆ° BUTTON ä»£è¡¨çš„è·¯å¾„"
    (find-file-other-window (substring-no-properties (button-get button 'path)))
    (when-let* ((pos (get-text-property button 'position (marker-buffer button))))
      (helpful--goto-char-widen pos)))
  
  (advice-add #'helpful--navigate :override #'my/helpful--navigate))
#+end_src
*** Pythonçš„é…ç½®
#+begin_src emacs-lisp
;;; Python

(use-package python
  :defer t
  :mode ("\\.py\\'" . python-mode)
  :init
  (setq python-shell-completion-native-enable nil)
  :config
  ;; UV è™šæ‹Ÿç¯å¢ƒæ¿€æ´»ï¼ˆä¿æŒåŸæœ‰é…ç½®ï¼‰
  (defun my/uv-activate ()
    "Activate Python environment managed by uv"
    (interactive)
    (let* ((project-root (project-root (project-current t)))
           (venv-path (expand-file-name ".venv" project-root))
           (python-path (expand-file-name
                         (if (eq system-type 'windows-nt)
                             "Scripts/python.exe"
                           "bin/python")
                         venv-path)))
      (if (file-exists-p python-path)
          (progn
            (setq python-shell-interpreter python-path)
            (let ((venv-bin-dir (file-name-directory python-path)))
              (setq exec-path (cons venv-bin-dir
                                    (remove venv-bin-dir exec-path))))
            (setenv "PATH" (concat (file-name-directory python-path)
                                   path-separator
                                   (getenv "PATH")))
            (setenv "VIRTUAL_ENV" venv-path)
            (setenv "PYTHONHOME" nil)
            (message "Activated UV Python environment at %s" venv-path))
        (error "No UV Python environment found in %s" project-root)))))
;; Flymake-ruffï¼ˆè¯­æ³•æ£€æŸ¥ï¼‰
(use-package flymake-ruff
  :ensure t
  :defer t
  :hook (python-mode . flymake-ruff-load))

(setq python-shell-interpreter "python")
#+end_src
*** ç¼–ç¨‹æ¨¡å¼é€šç”¨è®¾ç½®

#+begin_src emacs-lisp
  (use-package rainbow-delimiters
    :ensure t
    :hook (prog-mode . rainbow-delimiters-mode)
    :config
    (setq rainbow-delimiters-max-face-count 5))
  (use-package prog-mode
    :hook ((prog-mode LaTeX-mode org-mode) . display-fill-column-indicator-mode))
  (use-package indent-bars
    :ensure t
    :hook ((python-mode yaml-mode) . indent-bars-mode)) ; or whichever modes you prefer
#+end_src

** å·¥å…·é›†æˆ
*** GPTel

#+begin_src emacs-lisp
  (defvar my/gptel-cache-dir (locate-user-emacs-file "etc/gptel/"))
  (unless (file-directory-p my/gptel-cache-dir)
    (make-directory my/gptel-cache-dir t))

  (use-package gptel
    :ensure t
:commands (gptel gptel-send gptel-menu gptel-abort)
    :config
    (setq gptel-default-mode 'org-mode
          gptel-use-curl nil
          gptel-model 'kimi-k2-thinking
          gptel-backend
          (gptel-make-openai "Aliyun Bailian"
            :host "dashscope.aliyuncs.com"
            :endpoint "/compatible-mode/v1/chat/completions"
            :stream t
            :key "sk-0e8850453d3543a895b0393acab5128b"
            :models '(qwen-max qwen-plus qwen-turbo kimi-k2-thinking)))
    :bind (("C-c C-<return>" . gptel-menu)
           ("C-c <return>" . gptel-send)
           ("C-c C-g" . gptel-abort)
           :map gptel-mode-map
           ("C-c C-x t" . gptel-set-topic))
    :custom
    (gptel-prompt-prefix-alist
     '((markdown-mode . "### ")
       (org-mode . "* ")
       (text-mode . "### ")))
    (gptel-response-prefix-alist
     '((markdown-mode . "")
       (org-mode . "")
       (text-mode . ""))))

  (defun replace-and-trim-latex (&rest _)
    "å°† LaTeX åˆ†éš”ç¬¦æ›¿æ¢ä¸º $, $$"
    (save-excursion
      (goto-char (point-min))
      (let ((replacements '(("\\\\(" . "$")
                            ("\\\\)" . "$")
                            ("\\\\\\[" . "$$")
                            ("\\\\\\]" . "$$"))))
        (dolist (pair replacements)
          (goto-char (point-min))
          (while (re-search-forward (car pair) nil t)
            (replace-match (cdr pair) nil nil))))
      (goto-char (point-min))
      (while (re-search-forward "\\(?:^\\| \\)\\$\\(?: \\|$\\)" nil t)
        (replace-match "$" nil nil))))
  (add-hook 'gptel-post-response-functions #'replace-and-trim-latex)
#+end_src

*** Persistent Scratch

#+begin_src emacs-lisp
(use-package diminish
  :ensure t)

(use-package persistent-scratch
  :ensure t
  :diminish
  :bind (:map persistent-scratch-mode-map
         ([remap kill-buffer] . (lambda (&rest _)
                                  (interactive)
                                  (user-error "Scratch ç¼“å†²åŒºæ— æ³•å…³é—­")))
         ([remap revert-buffer] . persistent-scratch-restore)
         ([remap revert-this-buffer] . persistent-scratch-restore))
  :hook ((after-init . persistent-scratch-autosave-mode)
         (lisp-interaction-mode . persistent-scratch-mode))
  :init
  (setq persistent-scratch-save-file
        (locate-user-emacs-file "etc/persistent-scratch/.persistent-scratch")
        persistent-scratch-backup-file-name-format "%Y-%m-%d"
        persistent-scratch-backup-directory
        (locate-user-emacs-file "etc/persistent-scratch/")))
#+end_src

*** Transient é…ç½®

#+begin_src emacs-lisp
(setq transient-levels-file (locate-user-emacs-file "etc/transient/levels.el")
      transient-values-file (locate-user-emacs-file "etc/transient/values.el")
      transient-history-file (locate-user-emacs-file "etc/transient/history.el"))
#+end_src

*** Ripgrep

#+begin_src emacs-lisp
(use-package rg
  :ensure t
  :hook (after-init . rg-enable-default-bindings)
  :bind (:map rg-global-map
         ("c" . rg-dwim-current-dir)
         ("f" . rg-dwim-current-file)
         ("m" . rg-menu))
  :init
  (setq rg-group-result t
        rg-show-columns t)
  :config
  (cl-pushnew '("tmpl" . "*.tmpl") rg-custom-type-aliases))
#+end_src

*** Vundo
#+begin_src emacs-lisp
(use-package vundo
  :ensure t
  :bind ("C-x u" . vundo)
  :config
  (setq vundo-glyph-alist vundo-unicode-symbols))
#+end_src

*** Magit

#+begin_src emacs-lisp
  (use-package magit
    :ensure t
    :hook (git-commit-setup . git-commit-turn-on-flyspell)
    :bind (("C-x g" . magit-status)
           ("C-x M-g" . magit-dispatch)
           ("C-c M-g" . magit-file-dispatch))
    :custom
    (magit-diff-refine-hunk t)
    (magit-diff-paint-whitespace nil)
    (magit-ediff-dwim-show-on-hunks t))

  (use-package gptel-commit
    :after (gptel magit)
    :config
    (setq gptel-commit-model 'kimi-k2-thinking
          gptel-commit-backend
          (gptel-make-openai "Aliyun Bailian"
            :host "dashscope.aliyuncs.com"
            :endpoint "/compatible-mode/v1/chat/completions"
            :stream t
            :key "sk-0e8850453d3543a895b0393acab5128b"
            :models '(qwen-max qwen-plus qwen-turbo kimi-k2-thinking))
          ;;gptel-commit-backend (gptel-make-gh-copilot "Copilot")
          gptel-commit-prompt
          "You are an expert at writing Git commits. Your job is to write a short clear commit message that summarizes the changes.

    If you can accurately express the change in just the subject line, don't include anything in the message body. Only use the body when it is providing *useful* information.

    Don't repeat information from the subject line in the message body.

    Only return the commit message in your response. Do not include any additional meta-commentary about the task. Do not include the raw diff output in the commit message.

    Follow good Git style:

    - Separate the subject from the body with a blank line
    - Try to limit the subject line to 50 characters
    - Capitalize the subject line
    - Do not end the subject line with any punctuation
    - Use the imperative mood in the subject line
    - Wrap the body at 72 characters
    - Keep the body short and concise (omit it entirely if not useful)")
    :custom
    (gptel-commit-stream t))
  (with-eval-after-load 'magit
    (define-key git-commit-mode-map (kbd "C-c g") #'gptel-commit)
    (define-key git-commit-mode-map (kbd "C-c G") #'gptel-commit-rationale))
#+end_src
** æ—¥å†é…ç½®

#+begin_src emacs-lisp
  (use-package cal-china-x
    :ensure t
    :defer t
    :commands cal-china-x-setup
    :hook (calendar-mode . cal-china-x-setup)
    :config
    (setq calendar-mark-holidays-flag t
          cal-china-x-important-holidays cal-china-x-chinese-holidays
          cal-china-x-general-holidays '((holiday-lunar 1 15 "å…ƒå®µèŠ‚")
                                         (holiday-lunar 7 7 "ä¸ƒå¤•èŠ‚")
                                         (holiday-fixed 3 8 "å¦‡å¥³èŠ‚")
                                         (holiday-fixed 3 12 "æ¤æ ‘èŠ‚")
                                         (holiday-fixed 5 4 "é’å¹´èŠ‚")
                                         (holiday-fixed 6 1 "å„¿ç«¥èŠ‚")
                                         (holiday-fixed 9 10 "æ•™å¸ˆèŠ‚"))
          holiday-other-holidays '((holiday-fixed 2 14 "æƒ…äººèŠ‚")
                                   (holiday-fixed 4 1 "æ„šäººèŠ‚")
                                   (holiday-fixed 12 25 "åœ£è¯èŠ‚")
                                   (holiday-float 5 0 2 "æ¯äº²èŠ‚")
                                   (holiday-float 6 0 3 "çˆ¶äº²èŠ‚")
                                   (holiday-float 11 4 4 "æ„Ÿæ©èŠ‚"))
          calendar-holidays (append cal-china-x-important-holidays
                                    cal-china-x-general-holidays
                                    holiday-other-holidays)))
;;; init.el ends here
#+end_src

